<!DOCTYPE html><html lang="en"><head>
    <link rel="icon" type="image/png" href="https://i.imgur.com/lMAoVCW.png">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI in Education VIP Research Exchange</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700&amp;display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            /* Light mode colors (default) */
            --bg-primary: #f8f9fa;
            --bg-secondary: white;
            --bg-tertiary: #fafafa;
            --text-primary: #2d2d2d;
            --text-secondary: #666;
            --text-tertiary: #333;
            --border-color: #ddd;
            --border-color-light: #eee;
            --shadow-color: rgba(0, 0, 0, 0.08);
            --shadow-color-medium: rgba(0, 0, 0, 0.15);
            --accent-primary: #57068c;
            --accent-light: #e9ddf5;
            --accent-hover: #f0e6ff;
            --input-bg: white;
            --card-bg: white;
            --annotation-bg: #fafafa;
            --perspective-bg: #f0f4ff;
            --code-bg: #f5f5f5;
        }

        [data-theme="dark"] {
            /* Dark mode colors */
            --bg-primary: #1a1a1a;
            --bg-secondary: #2d2d2d;
            --bg-tertiary: #3a3a3a;
            --text-primary: #e0e0e0;
            --text-secondary: #b0b0b0;
            --text-tertiary: #d0d0d0;
            --border-color: #444;
            --border-color-light: #3a3a3a;
            --shadow-color: rgba(0, 0, 0, 0.3);
            --shadow-color-medium: rgba(0, 0, 0, 0.5);
            --accent-primary: #8b4fc9;
            --accent-light: #3d2857;
            --accent-hover: #4a3366;
            --input-bg: #3a3a3a;
            --card-bg: #2d2d2d;
            --annotation-bg: #3a3a3a;
            --perspective-bg: #2a2a40;
            --code-bg: #3a3a3a;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Montserrat', sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.7;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        .fixed-header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 70px;
            background-color: var(--bg-secondary);
            border-bottom: 3px solid var(--accent-primary);
            box-shadow: 0 2px 8px var(--shadow-color);
            padding: 0 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 1000;
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 20px;
            flex-shrink: 0;
        }

        .logo {
            display: flex;
            align-items: center;
            flex-shrink: 0;
        }

        .logo img {
            height: 60px;
            width: auto;
        }

        .header-title {
            color: var(--accent-primary);
            font-weight: 600;
            font-size: 1.4rem;
            opacity: 0;
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            transition: opacity 0.3s ease, color 0.3s ease;
            letter-spacing: 0.5px;
        }

        .header-title.visible {
            opacity: 1;
        }

        .header-right {
            display: flex;
            gap: 15px;
            align-items: center;
            margin-left: auto;
            position: relative;
            z-index: 9999;
        }

        .search-field {
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 14px;
            width: 200px;
            background-color: var(--input-bg);
            color: var(--text-primary);
            transition: background-color 0.3s ease, border-color 0.3s ease, color 0.3s ease;
        }

        .contribute-btn {
            background-color: var(--bg-secondary);
            border: 2px solid var(--accent-primary);
            border-radius: 4px;
            padding: 10px 24px;
            font-family: 'Montserrat', sans-serif;
            color: var(--accent-primary);
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.85rem;
            font-weight: 600;
            letter-spacing: 0.3px;
            text-transform: uppercase;
            white-space: nowrap;
        }

        .contribute-btn:hover {
            background-color: #57068c;
            color: white;
        }

        .contribute-btn-hidden {
            display: none;
        }

        .header-menu {
            position: relative;
        }

        .menu-trigger {
            background: none;
            border: none;
            cursor: pointer;
            padding: 8px;
            font-size: 1.5rem;
            color: #57068c;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background-color 0.2s ease;
        }

        .menu-trigger:hover {
            background-color: #f0e6ff;
        }

        .header-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            box-shadow: 0 4px 12px var(--shadow-color-medium);
            min-width: 180px;
            display: none;
            z-index: 10000;
            margin-top: 8px;
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }

        .header-dropdown.show {
            display: block;
        }

        .dropdown-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 16px;
            color: var(--text-primary);
            text-decoration: none;
            transition: background-color 0.2s ease, color 0.3s ease;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s ease;
            border: none;
            background: none;
            width: 100%;
            text-align: left;
            font-family: 'Montserrat', sans-serif;
        }

        .dropdown-item:first-child {
            border-radius: 8px 8px 0 0;
        }

        .dropdown-item:last-child {
            border-radius: 0 0 8px 8px;
        }

        .dropdown-item:hover {
            background-color: #f0e6ff;
            color: #57068c;
        }

        .dropdown-item i {
            width: 16px;
            color: #57068c;
        }

        .breadcrumb-subheader {
            position: fixed;
            top: 80px;
            left: 0;
            right: 0;
            height: 45px;
            background-color: var(--bg-tertiary);
            border-bottom: 1px solid var(--border-color);
            padding: 0 30px;
            display: flex;
            align-items: center;
            z-index: 999;
            display: none;
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }

        .breadcrumbs {
            display: flex;
            align-items: center;
            font-size: 14px;
            color: var(--text-secondary);
            transition: color 0.3s ease;
        }

        .breadcrumbs a {
            color: var(--accent-primary);
            text-decoration: none;
            transition: color 0.2s;
        }

        .breadcrumbs a:hover {
            color: #6600a8;
            text-decoration: underline;
        }

        .breadcrumbs .separator {
            margin: 0 8px;
            color: #999;
        }

        .breadcrumbs .current {
            font-weight: 600;
            color: #333;
        }

        body.show-breadcrumbs .breadcrumb-subheader {
            display: flex;
        }

        body.show-breadcrumbs main {
            margin-top: 135px;
        }

        main {
            margin-top: 70px;
            color: #333;
            transition: margin-top 0.3s;
        }

        h1, h2, h3 {
            font-family: 'Montserrat', sans-serif;
            color: #57068c;
        }

        a {
            color: #57068c;
            text-decoration: none;
        }

        a:hover {
            text-decoration: underline;
        }

        .hero-banner {
            background: var(--accent-primary);
            color: white;
            padding: 60px 20px;
            text-align: center;
            position: relative;
            overflow: visible;
            z-index: 1;
            transition: background-color 0.3s ease;
        }

        .hero-banner::before {
            display: none;
        }

        .hero-content {
            position: relative;
            z-index: 2;
            max-width: 900px;
            margin: 0 auto;
        }

        .hero-banner h1 {
            color: white;
            font-size: 2.2rem;
            margin-bottom: 16px;
            font-weight: 600;
            letter-spacing: 0.5px;
        }

        .hero-banner p {
            font-size: 1rem;
            max-width: 700px;
            margin: 0 auto 25px;
            line-height: 1.7;
            color: rgba(255, 255, 255, 0.9);
            font-weight: 300;
        }

        .hero-search-container {
            position: relative;
            z-index: 9999;
            width: 100%;
            max-width: 600px;
            margin: 0 auto;
        }

        .hero-search-field {
            width: 100%;
            padding: 15px 20px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            font-size: 16px;
            box-shadow: 0 4px 10px var(--shadow-color);
            background-color: var(--input-bg);
            color: var(--text-primary);
            transition: all 0.3s ease;
        }

        .hero-search-container::after {
            content: "\f002";
            font-family: "Font Awesome 6 Free";
            font-weight: 900;
            position: absolute;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--accent-primary);
            transition: color 0.3s ease;
        }

        .content-section {
            padding: 60px 20px;
            max-width: 1200px;
            margin: 0 auto;
        }

        .section-title {
            text-align: center;
            margin-bottom: 50px;
            font-size: 2rem;
            color: var(--accent-primary);
            position: relative;
            padding-bottom: 15px;
            transition: color 0.3s ease;
        }

        .section-title::after {
            content: "";
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 80px;
            height: 3px;
            background-color: var(--accent-primary);
            transition: background-color 0.3s ease;
        }

        .topic-categories {
                display: grid;
                grid-template-columns: repeat(2, 1fr);
                gap: 20px;
                margin-bottom: 20px;
                max-width: 800px;
                margin-left: auto;
                margin-right: auto;
            }

            .topic-categories.resources-grid {
                display: flex;
                justify-content: center;
                gap: 20px;
            }

            .topic-categories.resources-grid .topic-category {
                flex: 0 1 350px;
            }

            @media (max-width: 768px) {
                .topic-categories {
                    grid-template-columns: 1fr;
                    gap: 25px;
                }

                .topic-categories.resources-grid {
                    flex-direction: column;
                    align-items: center;
                }

                .topic-categories.resources-grid .topic-category {
                    width: 100%;
                    max-width: 350px;
                }
            }

            .topic-category h3 {
    font-size: 1.1rem;
    line-height: 1.3;
}

.subtopic-button {
    font-size: 16px;
    padding: 8px 12px;
    margin-bottom: 6px;
}

@media (max-width: 1200px) {
    .topic-category h3 {
        font-size: 1.2rem;
    }
    
    .subtopic-button {
        font-size: 18px;
        padding: 10px 15px;
        margin-bottom: 8px;
    }
}

        .topic-category {
            background-color: var(--card-bg);
            border-radius: 8px;
            box-shadow: 0 2px 8px var(--shadow-color);
            overflow: hidden;
            transition: all 0.2s ease;
            border: 1px solid var(--border-color-light);
            position: relative;
        }

        .topic-category:hover {
            box-shadow: 0 4px 12px rgba(137, 0, 225, 0.08);
            border-color: var(--accent-light);
        }

        .category-header {
            background-color: transparent;
            padding: 20px;
            position: relative;
            border-bottom: 1px solid var(--border-color-light);
            transition: border-color 0.3s ease;
        }

        .category-header h3 {
            color: var(--accent-primary);
            font-size: 1.2rem;
            margin: 0;
            padding-left: 32px;
            font-weight: 600;
            transition: color 0.3s ease;
        }

        .category-icon {
            position: absolute;
            left: 20px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 1.2rem;
            color: #57068c;
        }

        .subtopics-list {
            padding: 15px;
        }

        .subtopic-button {
            display: block;
            width: 100%;
            padding: 10px 15px;
            margin-bottom: 8px;
            border: none;
            background-color: transparent;
            cursor: pointer;
            font-family: 'Montserrat', sans-serif;
            font-size: 18px;
            text-align: left;
            border-radius: 4px;
            transition: all 0.2s ease;
            color: #333;
            position: relative;
            padding-left: 15px;
        }

        .subtopic-button:hover {
            background-color: transparent;
            color: #57068c;
            font-size: 18.1px;
        }

        .subtopic-button::before {
            display: none;
        }

        .landing-page {
            display: block;
        }

        .topic-pages {
            display: none;
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }

        body.show-topics .landing-page {
            display: none;
        }

        body.show-topics .topic-pages {
            display: block;
        }

        .topic-page-header {
            margin-bottom: 30px;
            text-align: center;
        }

        .topic-page-header h1 {
            font-size: 2.2rem;
            margin-bottom: 15px;
        }

        .topic-page-header p {
            font-size: 1.1rem;
            color: #555;
            max-width: 800px;
            margin: 0 auto;
        }

        .back-button {
            display: none;
        }

        .subtopic-cards {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
            margin-top: 30px;
            margin-bottom: 30px;
        }

        .subtopic-card {
            background-color: var(--card-bg);
            border-radius: 8px;
            box-shadow: 0 2px 8px var(--shadow-color);
            overflow: hidden;
            transition: all 0.2s ease;
            border: 1px solid var(--border-color-light);
            padding: 20px;
            cursor: pointer;
        }

        .subtopic-card:hover {
            box-shadow: 0 4px 12px rgba(137, 0, 225, 0.08);
            border-color: var(--accent-light);
        }

        .subtopic-card h3 {
            color: var(--accent-primary);
            font-size: 1.1rem;
            margin-bottom: 10px;
            transition: color 0.3s ease;
        }

        .subtopic-card p {
            color: var(--text-secondary);
            font-size: 0.9rem;
            line-height: 1.5;
            transition: color 0.3s ease;
        }

        .entry-pathways {
            padding: 60px 0;
            background-color: #f8f8fa;
        }
        
        .entry-pathways .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 20px;
            position: relative;
            overflow: visible;
        }
        
        .pathways-container {
            display: flex;
            overflow-x: auto;
            scroll-behavior: smooth;
            padding: 20px 0;
            -ms-overflow-style: none;
            scrollbar-width: none;
            gap: 20px;
            margin: 0 70px;
        }
        
        .pathways-container::-webkit-scrollbar {
            display: none;
        }
        
        .pathway-card {
            flex: 0 0 320px;
            background-color: white;
            border-radius: 8px;
            padding: 25px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
            border: 1px solid #eee;
            display: flex;
            flex-direction: column;
        }
        
        .pathway-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 15px rgba(137, 0, 225, 0.1);
            border-color: #e0d0eb;
        }
        
        .pathway-icon {
            width: 60px;
            height: 60px;
            background-color: #f0e6ff;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 15px;
        }
        
        .pathway-icon i {
            font-size: 24px;
            color: #57068c;
        }
        
        .pathway-title {
            font-size: 1.2rem;
            color: #57068c;
            margin-bottom: 10px;
            font-weight: 600;
        }
        
        .pathway-card p {
            color: #666;
            font-size: 0.9rem;
            line-height: 1.5;
            margin-bottom: 15px;
            flex-grow: 1;
        }
        
        .view-more {
            color: #57068c;
            text-decoration: none;
            font-weight: 500;
            font-size: 0.9rem;
            transition: all 0.2s;
            display: inline-block;
            align-self: flex-start;
        }
        
        .view-more:hover {
            color: #6600a8;
            text-decoration: underline;
        }
        
        .pathway-nav {
            position: absolute;
            top: 60%;
            transform: translateY(-50%);
            width: 50px;
            height: 50px;
            background-color: rgba(255, 255, 255, 0.9);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.15);
            z-index: 10;
            transition: all 0.3s ease;
            border: 1px solid #f0f0f0;
        }
        
        .pathway-nav:hover {
            background-color: white;
            box-shadow: 0 5px 12px rgba(137, 0, 225, 0.2);
            transform: translateY(-50%) scale(1.05);
        }

        .pathway-nav.prev {
            left: 25px;
        }

        .pathway-nav.next {
            right: 25px;
        }

        .pathway-nav i {
            color: #57068c;
            font-size: 1.2rem;
        }

        .site-footer {
            background-color: var(--bg-tertiary);
            padding: 60px 0 30px;
            border-top: 1px solid var(--border-color);
            margin-top: 60px;
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }
    
        .site-footer .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }
    
        .footer-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 40px;
            margin-bottom: 40px;
        }
    
        .footer-column h3 {
            color: var(--accent-primary);
            font-size: 1.2rem;
            margin-bottom: 20px;
            font-weight: 600;
            transition: color 0.3s ease;
        }

        .footer-links {
            list-style: none;
        }

        .footer-links li {
            margin-bottom: 12px;
        }

        .footer-links a {
            color: var(--text-tertiary);
            text-decoration: none;
            transition: color 0.2s;
            font-size: 0.95rem;
        }

        .footer-links a:hover {
            color: var(--accent-primary);
            text-decoration: underline;
        }

        .footer-bottom {
            text-align: center;
            padding-top: 30px;
            border-top: 1px solid var(--border-color);
            color: var(--text-secondary);
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .bibliography-container {
            margin-top: 30px;
            padding: 20px;
        }
    
        .bib-entry {
            margin-bottom: 30px;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            border: 1px solid #eee;
        }
    
        .bib-citation {
            font-size: 16px;
            line-height: 1.6;
            position: relative;
            padding: 20px;
            padding-right: 140px;
            background-color: #f0e6ff;
            border-radius: 8px 8px 0 0;
            margin-bottom: 0;
        }

        .bib-citation:hover {
            background-color: #e9ddf5;
        }

        .collapse-indicator {
            position: absolute;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            width: 12px;
            height: 12px;
            border-left: 2px solid #57068c;
            border-bottom: 2px solid #57068c;
            transform: translateY(-60%) rotate(-45deg);
            transition: transform 0.3s ease;
            cursor: pointer;
            user-select: none;
        }

        .collapse-indicator.expanded {
            transform: translateY(-40%) rotate(135deg);
        }

        .citation-text {
            flex: 1 1 auto;
            padding-right: 10px;
            min-width: 0;
        }

        .bib-button {
            padding: 8px 16px;
            background-color: white;
            border: 1px solid #57068c;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 500;
            color: #57068c;
            cursor: pointer;
            transition: all 0.25s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            white-space: nowrap;
            box-shadow: 0 1px 3px rgba(137, 0, 225, 0.1);
        }

        .bib-button:hover {
            background-color: #f0e6ff;
            border-color: #57068c;
            transform: translateY(-2px);
            box-shadow: 0 3px 5px rgba(137, 0, 225, 0.15);
        }
    
        .bib-button:active {
            transform: translateY(0);
            box-shadow: 0 1px 2px rgba(137, 0, 225, 0.1);
        }
    
        .annotation-actions .bib-button::before {
            content: "\f06e";
            font-family: "Font Awesome 6 Free";
            font-weight: 900;
            margin-right: 6px;
            font-size: 12px;
        }
    
        @media (max-width: 768px) {
            .bib-citation {
                padding-right: 50px;
            }

            .annotation-actions {
                flex-direction: column;
                gap: 10px;
            }

            .bib-button,
            .add-perspective-btn {
                width: 100%;
                text-align: center;
            }
        }
    
        .bib-annotation-container {
            padding: 20px;
            border-top: none;
            background-color: white;
            display: none;
        }
    
        .bib-annotation {
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid #e6d0f0;
            font-size: 15px;
            line-height: 1.6;
            color: #444;
        }

        .bib-annotation:last-of-type {
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px dashed #e6d0f0;
        }

        /* Nested annotations (replies/responses in a thread) */
        .bib-annotation .bib-annotation {
            margin-top: 15px;
            margin-left: 20px;
            padding-left: 15px;
            border-left: 3px solid #e6d0f0;
            background-color: #fafafa;
        }

        /* Sibling annotations (multiple perspectives on same source) */
        .bib-annotation-container > .bib-annotation + .bib-annotation {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 2px solid #e6d0f0;
        }
    
        .annotation-author {
            font-style: italic;
            color: #666;
            display: inline-block;
            margin-top: 5px;
            font-size: 14px;
        }
    
        .annotation-text {
            font-size: 15px;
            line-height: 1.6;
            color: #444;
        }
    
        .annotation-actions {
            display: flex;
            gap: 15px;
            justify-content: center;
            align-items: center;
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px dashed #e6d0f0;
        }

        .add-perspective-btn {
            background-color: white;
            border: 2px solid #57068c;
            border-radius: 20px;
            padding: 8px 20px;
            font-family: 'Montserrat', sans-serif;
            color: #57068c;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-block;
            width: fit-content;
            margin: 0;
        }

        .add-perspective-btn:hover {
            background-color: #f0e6ff;
        }
        
        .source-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }
        
        .source-modal-content {
            background-color: white;
            width: 80%;
            max-width: 900px;
            height: 80%;
            border-radius: 8px;
            overflow: hidden;
            position: relative;
        }
        
        .source-modal-header {
            padding: 15px 20px;
            background-color: #57068c;
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .source-modal-title {
            font-size: 1.2rem;
            font-weight: 600;
        }
        
        .close-modal {
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
        }
        
        .source-iframe-container {
            width: 100%;
            height: calc(100% - 60px);
        }
        
        .source-iframe {
            width: 100%;
            height: 100%;
            border: none;
        }
    
        .popup {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.4);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }
        
        .popup-content {
            background-color: white;
            width: 90%;
            max-width: 800px;
            height: 80%;
            border-radius: 8px;
            overflow: hidden;
            position: relative;
            padding: 20px;
        }
        
        .close-btn {
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 24px;
            cursor: pointer;
            color: #57068c;
            z-index: 2001;
        }

        .search-results-container {
            position: absolute;
            top: 100%;
            left: 0;
            width: 100%;
            max-height: 300px;
            overflow-y: auto;
            background-color: white;
            border-radius: 0 0 8px 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            z-index: 9999;
            display: none;
        }
        
        .search-result-item {
            padding: 12px 15px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .search-result-item:hover {
            background-color: #f0e6ff;
        }
        
        .search-result-item:last-child {
            border-bottom: none;
        }
        
        .result-title {
            font-weight: 600;
            color: #57068c;
            margin-bottom: 3px;
        }
        
        .result-context {
            font-size: 0.85rem;
            color: #666;
        }
        
        .search-container {
            position: relative;
            z-index: 9999;
        }
        
        .highlight {
            background-color: #ffffcc;
            transition: background-color 2s;
        }

        #hero-search-results {
            position: absolute;
            top: 100%;
            left: 0;
            width: 100%;
            max-height: 300px;
            overflow-y: auto;
            background-color: white;
            border-radius: 0 0 8px 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            z-index: 9999;
            text-align: left;
        }

        .search-result-item {
            padding: 12px 15px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: background-color 0.2s;
            text-align: left;
        }

        input[type="search"]::-webkit-search-cancel-button {
            -webkit-appearance: none;
            appearance: none;
            display: none;
        }

        input[type="search"] {
            -webkit-appearance: none;
            appearance: none;
        }

        .header-search-wrapper {
            position: relative;
            width: 40px;
            transition: width 0.3s ease;
            overflow: visible;
            margin-right: 15px;
        }

        .header-search-wrapper:hover,
        .header-search-wrapper:focus-within {
            width: 250px;
        }

        .header-search-icon {
            position: absolute;
            left: 10px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--accent-primary);
            font-size: 16px;
            pointer-events: none;
            z-index: 1;
            transition: color 0.3s ease;
        }

        #header-search {
            width: 100%;
            padding: 8px 12px 8px 35px;
            border: 1px solid var(--border-color);
            border-radius: 20px;
            font-size: 14px;
            background-color: var(--input-bg);
            color: var(--text-primary);
            transition: all 0.3s ease;
        }

        #header-search-results {
            right: 0;
            left: auto;
            width: 250px;
        }

        .entry-count {
            margin-top: 10px;
            font-size: 0.9rem;
            color: white;
            opacity: 0.9;
            text-align: center;
        }

        .empty-content-placeholder {
            padding: 60px 20px;
            text-align: center;
        }
            
        .placeholder-message {
            max-width: 600px;
            margin: 0 auto;
            padding: 40px;
            background-color: #f9f6fc;
            border-radius: 8px;
            border: 1px solid #e0d0eb;
        }
            
        .placeholder-message h3 {
            color: #57068c;
            margin-bottom: 15px;
        }
            
        .placeholder-message p {
            color: #555;
            line-height: 1.6;
            margin-bottom: 20px;
        }

        .report-bug-btn {
            background-color: white;
            border: 2px solid #e0e0e0;
            border-radius: 20px;
            padding: 10px 18px;
            font-family: 'Montserrat', sans-serif;
            color: #666;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.9rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 6px;
            white-space: nowrap;
        }

        .report-bug-btn:hover {
            background-color: #f8f8fa;
            border-color: #57068c;
            color: #57068c;
        }

        .report-bug-btn i {
            font-size: 0.8rem;
        }

        /* Auth UI Styles */
        #auth-container {
            display: flex;
            align-items: center;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 14px;
            font-size: 14px;
        }

        .user-avatar-wrapper {
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .user-avatar {
            width: 42px;
            height: 42px;
            border-radius: 50%;
            border: 2px solid #57068c;
            object-fit: cover;
        }

        .user-name {
            font-family: 'Open Sans', sans-serif;
            color: #333;
            font-weight: 500;
        }

        .team-badge {
            position: absolute;
            bottom: -4px;
            right: -8px;
            background-color: #57068c;
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
            font-family: 'Open Sans', sans-serif;
            border: 2px solid white;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            line-height: 1.2;
        }

        .sign-out-btn {
            background-color: transparent;
            border: none;
            padding: 8px 12px;
            font-family: 'Montserrat', sans-serif;
            color: #666;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.9rem;
            font-weight: 500;
            white-space: nowrap;
        }

        .sign-out-btn:hover {
            color: #57068c;
            text-decoration: underline;
        }

        .sign-in-btn {
            background-color: white;
            border: 1px solid #ddd;
            padding: 8px 16px;
            font-family: 'Open Sans', sans-serif;
            color: #444;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.9rem;
            font-weight: 500;
            border-radius: 4px;
            display: flex;
            align-items: center;
            gap: 8px;
            white-space: nowrap;
        }

        .sign-in-btn:hover {
            background-color: #f8f8f8;
            border-color: #bbb;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .contribute-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background-color: #d0d0d0;
            border-color: #d0d0d0;
            transform: none;
            box-shadow: none;
        }

        .contribute-btn:disabled:hover {
            background-color: #d0d0d0;
            border-color: #d0d0d0;
            transform: none;
            box-shadow: none;
        }

        .add-perspective-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        /* Notification Styles */
        .notification {
            position: fixed;
            top: 180px;
            right: 30px;
            background-color: white;
            border-left: 4px solid #57068c;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            padding: 16px 20px;
            border-radius: 4px;
            font-family: 'Open Sans', sans-serif;
            font-size: 14px;
            max-width: 400px;
            z-index: 10000;
            opacity: 0;
            transform: translateX(400px);
            transition: all 0.3s ease;
        }

        .notification.show {
            opacity: 1;
            transform: translateX(0);
        }

        .notification-success {
            border-left-color: #10b981;
        }

        .notification-error {
            border-left-color: #ef4444;
        }

        .notification-info {
            border-left-color: #3b82f6;
        }

        /* User Profile Avatar in Header */
        .user-profile-header {
            cursor: pointer;
            display: flex;
            align-items: center;
            transition: opacity 0.2s ease;
        }

        .user-profile-header:hover {
            opacity: 0.8;
        }

        .user-avatar-header {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: 2px solid #57068c;
            object-fit: cover;
        }

        /* Contribution Modal Styles */
        .contribution-step {
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .topic-option {
            display: block;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
        }

        .topic-option input[type="radio"] {
            position: absolute;
            opacity: 0;
        }

        .topic-option span {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 500;
            color: #2d2d2d;
        }

        .topic-option:hover {
            border-color: #57068c;
            background-color: #f8f4ff;
        }

        .topic-option input[type="radio"]:checked + span {
            color: #57068c;
        }

        .topic-option input[type="radio"]:checked ~ span::before {
            content: '';
            position: absolute;
            right: 15px;
            width: 20px;
            height: 20px;
            background: #57068c;
            border-radius: 50%;
        }

        .topic-option input[type="radio"]:checked {
            & + span::after {
                content: 'âœ“';
                position: absolute;
                right: 20px;
                color: white;
                font-size: 12px;
                font-weight: bold;
            }
        }

        /* Chatbot Styles */
        .chat-button {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, #57068c 0%, #b84cff 100%);
            color: white;
            border: none;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(137, 0, 225, 0.4);
            transition: all 0.3s ease;
            z-index: 9998;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .chat-button:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(137, 0, 225, 0.5);
        }

        .chat-button.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .chat-panel {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 400px;
            height: 600px;
            max-height: calc(100vh - 100px);
            background: white;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            display: flex;
            flex-direction: column;
            transform: translateY(calc(100% + 60px));
            opacity: 0;
            pointer-events: none;
            transition: all 0.3s ease;
            z-index: 9999;
            overflow: hidden;
        }

        .chat-panel.open {
            transform: translateY(0);
            opacity: 1;
            pointer-events: all;
        }

        .chat-header {
            background: linear-gradient(135deg, #57068c 0%, #b84cff 100%);
            color: white;
            padding: 16px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }

        .chat-header-content {
            display: flex;
            align-items: center;
            gap: 10px;
            font-family: 'Montserrat', sans-serif;
            font-weight: 600;
            font-size: 16px;
        }

        .chat-close-btn {
            background: none;
            border: none;
            color: white;
            font-size: 20px;
            cursor: pointer;
            padding: 4px;
            opacity: 0.9;
            transition: opacity 0.2s;
        }

        .chat-close-btn:hover {
            opacity: 1;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 16px;
            background: #f8f8fa;
        }

        .chat-message {
            display: flex;
            gap: 12px;
            animation: messageSlideIn 0.3s ease;
        }

        @keyframes messageSlideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            font-size: 16px;
        }

        .user-message .message-avatar {
            background: #e5e7eb;
            color: #6b7280;
        }

        .bot-message .message-avatar {
            background: linear-gradient(135deg, #57068c 0%, #b84cff 100%);
            color: white;
        }

        .message-content {
            flex: 1;
            background: white;
            padding: 12px 16px;
            border-radius: 12px;
            font-family: 'Open Sans', sans-serif;
            font-size: 14px;
            line-height: 1.6;
            color: #333;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .user-message .message-content {
            background: #57068c;
            color: white;
        }

        .message-content p {
            margin: 0 0 8px 0;
        }

        .message-content p:last-child {
            margin-bottom: 0;
        }

        .message-content ul {
            margin: 8px 0;
            padding-left: 20px;
        }

        .message-content li {
            margin: 4px 0;
        }

        .message-content a {
            color: #57068c;
            text-decoration: underline;
        }

        .user-message .message-content a {
            color: white;
            font-weight: 500;
        }

        .message-content code {
            background: #f3f4f6;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
        }

        .typing-indicator {
            display: flex;
            gap: 4px;
            padding: 4px 0;
        }

        .typing-indicator span {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #57068c;
            animation: typingBounce 1.4s infinite;
        }

        .typing-indicator span:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-indicator span:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typingBounce {
            0%, 60%, 100% {
                transform: translateY(0);
            }
            30% {
                transform: translateY(-10px);
            }
        }

        .chat-input-container {
            padding: 16px;
            background: white;
            border-top: 1px solid #e5e7eb;
            display: flex;
            gap: 12px;
            flex-shrink: 0;
        }

        .chat-input {
            flex: 1;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            padding: 10px 12px;
            font-family: 'Open Sans', sans-serif;
            font-size: 14px;
            resize: none;
            outline: none;
            transition: border-color 0.2s;
            max-height: 120px;
        }

        .chat-input:focus {
            border-color: #57068c;
        }

        .chat-send-btn {
            width: 44px;
            height: 44px;
            border-radius: 8px;
            background: #57068c;
            color: white;
            border: none;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            flex-shrink: 0;
        }

        .chat-send-btn:hover {
            background: #7000c0;
            transform: scale(1.05);
        }

        .chat-send-btn:active {
            transform: scale(0.95);
        }

        /* Responsive Styles */

        /* Tablet and smaller laptops */
        @media (max-width: 1024px) {
            .fixed-header {
                padding: 0 24px;
            }

            .header-title {
                font-size: 1.1rem;
                max-width: 280px;
            }

            .header-right {
                gap: 12px;
            }

            .report-bug-btn span {
                display: none;
            }
        }

        /* Mobile */
        @media (max-width: 768px) {
            .fixed-header {
                height: 70px;
                padding: 0 16px;
                gap: 12px;
            }

            .breadcrumb-subheader {
                top: 70px;
            }

            .header-left {
                gap: 12px;
            }

            .logo img {
                height: 40px;
            }

            .header-title {
                font-size: 1rem;
                max-width: 200px;
            }

            .header-right {
                gap: 8px;
            }

            .contribute-btn,
            .report-bug-btn {
                padding: 8px 14px;
                font-size: 0.85rem;
            }

            .report-bug-btn {
                padding: 8px;
            }

            .report-bug-btn span {
                display: none;
            }

            .user-avatar {
                width: 36px;
                height: 36px;
            }

            .team-badge {
                font-size: 8px;
                padding: 2px 6px;
            }

            .sign-out-btn {
                font-size: 0.85rem;
                padding: 6px 8px;
            }
        }

        /* Extra small mobile */
        @media (max-width: 500px) {
            .fixed-header {
                height: 65px;
                padding: 0 12px;
            }

            .breadcrumb-subheader {
                top: 65px;
            }

            .header-title {
                font-size: 0.9rem;
                max-width: 150px;
            }

            .header-search-wrapper {
                display: none;
            }

            .contribute-btn,
            .report-bug-btn {
                padding: 6px 10px;
                font-size: 0.8rem;
            }

            .report-bug-btn {
                padding: 6px;
            }

            .sign-out-btn {
                display: none;
            }

            .chat-panel {
                width: calc(100vw - 20px);
                height: calc(100vh - 100px);
                right: 10px;
                bottom: 10px;
            }
        }

        /* ============================================
           COMPREHENSIVE DARK MODE OVERRIDES
           ============================================ */

        [data-theme="dark"] .hero-banner {
            background: #2d1a4d;
        }

        [data-theme="dark"] .site-footer {
            background-color: var(--bg-secondary);
        }

        [data-theme="dark"] .topic-card,
        [data-theme="dark"] .pathway-card,
        [data-theme="dark"] .contributor-card {
            background-color: var(--card-bg);
            border-color: var(--border-color);
        }

        [data-theme="dark"] .topic-card h3,
        [data-theme="dark"] .pathway-card h3,
        [data-theme="dark"] .subtopic-card h3 {
            color: var(--accent-primary);
        }

        [data-theme="dark"] .topic-card p,
        [data-theme="dark"] .pathway-card p,
        [data-theme="dark"] .subtopic-card p {
            color: var(--text-secondary);
        }

        [data-theme="dark"] .bib-entry {
            background-color: transparent;
        }

        [data-theme="dark"] .bib-citation {
            background-color: var(--card-bg);
            color: var(--text-primary);
            border-color: var(--border-color);
        }

        [data-theme="dark"] .bib-annotation-container {
            background-color: var(--annotation-bg);
            border-color: var(--border-color);
        }

        [data-theme="dark"] .bib-annotation {
            background-color: var(--annotation-bg);
        }

        [data-theme="dark"] .annotation-text {
            color: var(--text-primary);
        }

        [data-theme="dark"] .annotation-author {
            color: var(--text-secondary);
        }

        [data-theme="dark"] .perspective-item {
            background-color: var(--perspective-bg) !important;
            border-left-color: var(--accent-primary) !important;
        }

        [data-theme="dark"] .bib-button,
        [data-theme="dark"] .add-perspective-btn {
            background-color: var(--bg-secondary);
            color: var(--accent-primary);
            border-color: var(--accent-primary);
        }

        [data-theme="dark"] .bib-button:hover,
        [data-theme="dark"] .add-perspective-btn:hover {
            background-color: var(--accent-hover);
        }

        [data-theme="dark"] .contribute-popup,
        [data-theme="dark"] .modal,
        [data-theme="dark"] .admin-panel {
            background-color: var(--card-bg);
            border-color: var(--border-color);
        }

        [data-theme="dark"] .popup-header,
        [data-theme="dark"] .modal-header {
            background-color: var(--bg-tertiary);
            color: var(--text-primary);
            border-bottom-color: var(--border-color);
        }

        [data-theme="dark"] .popup-body,
        [data-theme="dark"] .modal-body {
            background-color: var(--card-bg);
        }

        [data-theme="dark"] input,
        [data-theme="dark"] textarea,
        [data-theme="dark"] select {
            background-color: var(--input-bg);
            color: var(--text-primary);
            border-color: var(--border-color);
        }

        [data-theme="dark"] input::placeholder,
        [data-theme="dark"] textarea::placeholder {
            color: var(--text-secondary);
        }

        [data-theme="dark"] .dropdown-item:hover {
            background-color: var(--accent-hover);
        }

        [data-theme="dark"] .menu-trigger:hover {
            background-color: var(--accent-hover);
        }

        [data-theme="dark"] .contribute-btn:hover {
            background-color: var(--accent-hover);
        }

        [data-theme="dark"] .landing-page h1,
        [data-theme="dark"] .landing-page h2,
        [data-theme="dark"] .topic-page-header h1,
        [data-theme="dark"] .topic-page-header h2 {
            color: var(--text-primary);
        }

        [data-theme="dark"] .landing-page p,
        [data-theme="dark"] .topic-page-header p {
            color: var(--text-secondary);
        }

        [data-theme="dark"] .topic-grid,
        [data-theme="dark"] .subtopic-grid {
            background-color: transparent;
        }

        [data-theme="dark"] .chat-panel {
            background-color: var(--card-bg);
            border-color: var(--border-color);
        }

        [data-theme="dark"] .chat-header {
            background-color: var(--bg-tertiary);
            color: var(--text-primary);
            border-bottom-color: var(--border-color);
        }

        [data-theme="dark"] .chat-messages {
            background-color: var(--card-bg);
        }

        [data-theme="dark"] .chat-message {
            color: var(--text-primary);
        }

        [data-theme="dark"] .chat-message.user {
            background-color: var(--accent-primary);
            color: white;
        }

        [data-theme="dark"] .chat-message.assistant {
            background-color: var(--bg-tertiary);
            color: var(--text-primary);
        }

        [data-theme="dark"] .chat-input-container {
            background-color: var(--bg-tertiary);
            border-top-color: var(--border-color);
        }

        [data-theme="dark"] .breadcrumbs {
            background-color: var(--bg-secondary);
            border-bottom-color: var(--border-color);
        }

        [data-theme="dark"] .breadcrumbs a,
        [data-theme="dark"] .breadcrumbs span {
            color: var(--text-secondary);
        }

        [data-theme="dark"] .breadcrumbs a:hover {
            color: var(--accent-primary);
        }

        [data-theme="dark"] code,
        [data-theme="dark"] pre {
            background-color: var(--code-bg);
            color: var(--text-primary);
        }

        [data-theme="dark"] table {
            border-color: var(--border-color);
        }

        [data-theme="dark"] th,
        [data-theme="dark"] td {
            border-color: var(--border-color);
            color: var(--text-primary);
        }

        [data-theme="dark"] th {
            background-color: var(--bg-tertiary);
        }

        [data-theme="dark"] .empty-content-placeholder {
            color: var(--text-secondary);
        }

        [data-theme="dark"] .search-results-container {
            background-color: var(--card-bg);
            border-color: var(--border-color);
        }

        [data-theme="dark"] .search-result-item {
            border-bottom-color: var(--border-color);
            color: var(--text-primary);
        }

        [data-theme="dark"] .search-result-item:hover {
            background-color: var(--accent-hover);
        }

        [data-theme="dark"] .result-title {
            color: var(--accent-primary);
        }

        [data-theme="dark"] .result-context {
            color: var(--text-secondary);
        }

        [data-theme="dark"] hr {
            border-color: var(--border-color);
        }

        [data-theme="dark"] .topic-content,
        [data-theme="dark"] .landing-content {
            background-color: transparent;
        }

        /* Progress Dashboard Styles */
        .progress-dashboard {
            display: none;
            max-width: 1200px;
            margin: 90px auto 30px;
            padding: 25px;
            background: var(--card-bg);
            border-radius: 12px;
            box-shadow: 0 2px 12px var(--shadow-color);
            border-left: 4px solid var(--accent-primary);
        }

        .progress-dashboard.show {
            display: block;
        }

        .progress-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .progress-title {
            font-size: 1.4em;
            font-weight: 600;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .progress-status-badge {
            display: inline-block;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .progress-status-badge.on-track {
            background-color: #d4edda;
            color: #155724;
        }

        .progress-status-badge.ahead {
            background-color: #d1ecf1;
            color: #0c5460;
        }

        .progress-status-badge.behind {
            background-color: #f8d7da;
            color: #721c24;
        }

        [data-theme="dark"] .progress-status-badge.on-track {
            background-color: #1e4620;
            color: #8bc34a;
        }

        [data-theme="dark"] .progress-status-badge.ahead {
            background-color: #1a3a40;
            color: #4fc3f7;
        }

        [data-theme="dark"] .progress-status-badge.behind {
            background-color: #4a1f23;
            color: #ef5350;
        }

        .progress-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .progress-info-card {
            padding: 15px;
            background: var(--bg-tertiary);
            border-radius: 8px;
            border: 1px solid var(--border-color-light);
        }

        .progress-info-label {
            font-size: 0.85em;
            color: var(--text-secondary);
            margin-bottom: 5px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .progress-info-value {
            font-size: 1.5em;
            font-weight: 700;
            color: var(--accent-primary);
        }

        .progress-bar-container {
            margin: 25px 0;
        }

        .progress-bar-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 0.9em;
            color: var(--text-secondary);
        }

        .progress-bar {
            height: 28px;
            background: var(--bg-tertiary);
            border-radius: 14px;
            overflow: hidden;
            position: relative;
            border: 1px solid var(--border-color);
        }

        .progress-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent-primary), #8b4fc9);
            transition: width 0.4s ease;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 12px;
            color: white;
            font-weight: 600;
            font-size: 0.85em;
        }

        .progress-bar-fill.ahead {
            background: linear-gradient(90deg, #17a2b8, #20c997);
        }

        .progress-bar-fill.behind {
            background: linear-gradient(90deg, #dc3545, #c82333);
        }

        .contributions-list {
            margin-top: 25px;
        }

        .contributions-list-title {
            font-size: 1.1em;
            font-weight: 600;
            margin-bottom: 15px;
            color: var(--text-primary);
        }

        .contribution-item {
            padding: 12px 15px;
            background: var(--bg-tertiary);
            border-radius: 6px;
            margin-bottom: 10px;
            border-left: 3px solid var(--accent-primary);
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 15px;
        }

        .contribution-item-info {
            flex: 1;
        }

        .contribution-item-title {
            font-weight: 500;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .contribution-item-meta {
            font-size: 0.85em;
            color: var(--text-secondary);
        }

        .contribution-item-period {
            padding: 4px 10px;
            background: var(--accent-light);
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: 600;
            color: var(--accent-primary);
            white-space: nowrap;
        }

        .progress-notification {
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 0.95em;
        }

        .progress-notification.warning {
            background-color: #fff3cd;
            border: 1px solid #ffc107;
            color: #856404;
        }

        .progress-notification.error {
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }

        .progress-notification.info {
            background-color: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
        }

        [data-theme="dark"] .progress-notification.warning {
            background-color: #4a3f1f;
            border-color: #6c5d2c;
            color: #ffc107;
        }

        [data-theme="dark"] .progress-notification.error {
            background-color: #4a1f23;
            border-color: #6c2b31;
            color: #ef5350;
        }

        [data-theme="dark"] .progress-notification.info {
            background-color: #1a3a40;
            border-color: #2c5a64;
            color: #4fc3f7;
        }

        .progress-notification i {
            font-size: 1.2em;
        }

        .empty-contributions {
            text-align: center;
            padding: 30px;
            color: var(--text-secondary);
            font-style: italic;
        }
    </style>

    <!-- Google Sign-In -->
    <script src="https://accounts.google.com/gsi/client" async="" defer=""></script>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-functions-compat.js"></script>

    <!-- Firebase Configuration -->
    <script>
        // Initialize Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyAV9jtApsSFuyZWVoTEnNl9MTOmwun9bmI",
            authDomain: "saymorehere.firebaseapp.com",
            projectId: "saymorehere",
            storageBucket: "saymorehere.firebasestorage.app",
            messagingSenderId: "172636652682",
            appId: "1:172636652682:web:e7ae9ee4e7726044fe9973",
            measurementId: "G-TV09JDHSM0"
        };

        // Initialize Firebase App
        const app = firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const functions = firebase.functions();

        // Make Firebase accessible globally
        window.firebaseApp = {
            app: app,
            auth: auth,
            db: db,
            functions: functions
        };

        console.log('âœ“ Firebase initialized');
    </script>
</head>
<body>
    <header class="fixed-header">
        <div class="logo">
            <a href="#" onclick="showLandingPage(); return false;" style="cursor: pointer;">
                <img id="header-logo" src="https://i.imgur.com/HpJ1Z46.png" alt="AI in Education VIP Logo">
            </a>
        </div>
        <div class="header-title"></div>
        <div class="header-right">
            <div class="search-container header-search-wrapper">
                <i class="fas fa-search header-search-icon"></i>
                <input type="search" placeholder="Search..." class="search-field" id="header-search">
                <div class="search-results-container" id="header-search-results"></div>
            </div>
            <div id="auth-container-header"></div>
            <div class="header-menu">
                <button class="menu-trigger" id="user-menu-trigger" onclick="toggleHeaderMenu()" aria-label="Menu">
                    <i class="fas fa-user-circle"></i>
                </button>
                <div class="header-dropdown" id="header-dropdown">
                    <button class="dropdown-item" id="admin-menu-item" style="display: none;" onclick="openAdminPanel(); toggleHeaderMenu();">
                        <i class="fas fa-user-shield"></i> Manage Users
                    </button>
                    <button class="dropdown-item" onclick="document.querySelector('.contribute-btn-hidden').click(); toggleHeaderMenu();">
                        <i class="fas fa-plus-circle"></i> Contribute
                    </button>
                    <button class="dropdown-item" id="my-drafts-menu-item" style="display: none;" onclick="openMyDrafts(); toggleHeaderMenu();">
                        <i class="fas fa-file-alt"></i> My Drafts
                    </button>
                    <button class="dropdown-item" id="reading-list-menu-item" style="display: none;" onclick="openReadingList(); toggleHeaderMenu();">
                        <i class="fas fa-star"></i> Reading List
                    </button>
                    <button class="dropdown-item" onclick="window.open('https://docs.google.com/forms/d/e/1FAIpQLSfjcCOxnbbpWjvfhBAvo_5EXCoa7DY5ePUzjYa1UgXcqjy9hQ/viewform?usp=sharing', '_blank'); toggleHeaderMenu();">
                        <i class="fas fa-bug"></i> Report Bug
                    </button>
                    <button class="dropdown-item" id="dark-mode-toggle" onclick="toggleDarkMode(); toggleHeaderMenu();">
                        <i class="fas fa-moon"></i> <span id="dark-mode-text">Dark Mode</span>
                    </button>
                    <div id="auth-container-dropdown"></div>
                </div>
            </div>
        </div>
        <button class="contribute-btn contribute-btn-hidden" style="display: none;" onclick="openContributePopup()">Contribute</button>
    </header>

    <div class="breadcrumb-subheader">
        <div class="breadcrumbs">
            <a href="#" onclick="showLandingPage()">Home</a>
            <span class="separator">â€º</span>
            <a href="#" onclick="showTopicPage('topic1')">Topic</a>
            <span class="separator">â€º</span>
            <span class="current">Subtopic</span>
        </div>
    </div>

    <main>
        <div class="landing-page">
            <section class="hero-banner">
                <div class="hero-content">
                    <h1>AI in Education VIP Research Exchange</h1>
                    <p>A collaborative knowledge base for NYU's AI in Education VIP team.</p>
                    <div class="hero-search-container search-container">
                        <input type="search" placeholder="Search for topics, tools, or research..." class="hero-search-field" id="hero-search">
                        <div class="search-results-container" id="hero-search-results"></div>
                    </div>
                    <div class="entry-count">Search <span id="entry-counter">0</span> research entries</div>
                </div>
            </section>

            <!-- Progress Dashboard -->
            <div class="progress-dashboard" id="progress-dashboard">
                <div class="progress-header">
                    <div class="progress-title">
                        <i class="fas fa-chart-line"></i>
                        <span>Your Contribution Progress</span>
                    </div>
                    <span class="progress-status-badge" id="progress-status-badge">Loading...</span>
                </div>

                <div id="progress-notification-area"></div>

                <div class="progress-info">
                    <div class="progress-info-card">
                        <div class="progress-info-label">Current Period</div>
                        <div class="progress-info-value" id="progress-current-period">-</div>
                    </div>
                    <div class="progress-info-card">
                        <div class="progress-info-label">Total Periods</div>
                        <div class="progress-info-value" id="progress-total-periods">-</div>
                    </div>
                    <div class="progress-info-card">
                        <div class="progress-info-label">Your Contributions</div>
                        <div class="progress-info-value" id="progress-user-contributions">-</div>
                    </div>
                    <div class="progress-info-card">
                        <div class="progress-info-label">Expected So Far</div>
                        <div class="progress-info-value" id="progress-expected-contributions">-</div>
                    </div>
                </div>

                <div class="progress-bar-container">
                    <div class="progress-bar-label">
                        <span>Progress</span>
                        <span id="progress-percentage">0%</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-bar-fill" id="progress-bar-fill" style="width: 0%;">
                            <span id="progress-bar-text"></span>
                        </div>
                    </div>
                </div>

                <div class="contributions-list" id="contributions-list-container" style="display: none;">
                    <div class="contributions-list-title">
                        <i class="fas fa-list"></i> Your Contributions This Semester
                    </div>
                    <div id="contributions-list"></div>
                </div>
            </div>

            <section class="content-section">
                <h2 class="section-title">VIP Subteams &amp; Research Areas</h2>
                <p style="text-align: center; max-width: 700px; margin: -15px auto 30px; color: #555; font-size: 1rem;">Understanding, predicting, and guiding the impact of generative AI in education through four complementary research pathways:</p>
                <div class="topic-categories">
                    <!-- Evaluating Tools -->
                    <div class="topic-category">
                        <div class="category-header" onclick="showTopicPage('evaluating-tools')" style="cursor: pointer;">
                            <i class="fas fa-tools category-icon"></i>
                            <h3>Evaluating Tools</h3>
                        </div>
                    </div>

                    <!-- Understanding Users -->
                    <div class="topic-category">
                        <div class="category-header" onclick="showTopicPage('understanding-users')" style="cursor: pointer;">
                            <i class="fas fa-users category-icon"></i>
                            <h3>Understanding Users</h3>
                        </div>
                    </div>

                    <!-- Assessing Impacts -->
                    <div class="topic-category">
                        <div class="category-header" onclick="showTopicPage('assessing-impacts')" style="cursor: pointer;">
                            <i class="fas fa-chart-line category-icon"></i>
                            <h3>Assessing Impacts</h3>
                        </div>
                    </div>

                    <!-- Innovating EdTech -->
                    <div class="topic-category">
                        <div class="category-header" onclick="showTopicPage('innovating-edtech')" style="cursor: pointer;">
                            <i class="fas fa-lightbulb category-icon"></i>
                            <h3>Innovating EdTech</h3>
                        </div>
                    </div>
                </div>
            </section>

            <section class="content-section">
                <h2 class="section-title">Background Resources</h2>
                <div class="topic-categories resources-grid">
                    <!-- Learning Science -->
                    <div class="topic-category">
                        <div class="category-header" onclick="showTopicPage('learning-science')" style="cursor: pointer;">
                            <i class="fas fa-brain category-icon"></i>
                            <h3>Learning Science</h3>
                        </div>
                    </div>

                    <!-- Research Methods & Resources -->
                    <div class="topic-category">
                        <div class="category-header" onclick="showTopicPage('research-methods')" style="cursor: pointer;">
                            <i class="fas fa-book category-icon"></i>
                            <h3>Research Methods &amp; Resources</h3>
                        </div>
                    </div>
                </div>
            </section>
        </div>

        <div class="topic-pages">
            <!-- Understanding Users -->
            <div id="understanding-users" style="display: none;">
                <div class="topic-page-header">
                    <h1>Understanding Users Attitudes &amp; Behaviors</h1>
                    <p>These resources help us to answer questions like: How, and how much, are students and teachers using AI tools? What values, principles, and assumptions shape their engagement with AI tools?</p>
                </div>
                <div class="topic-content">
                    <div class="subtopic-cards">
                        <div class="subtopic-card" onclick="showSubtopicPage('understanding-users', 'general')">
                            <h3>General</h3>
                            <p>General perspectives on how people perceive and interact with AI systems.</p>
                        </div>
                        <div class="subtopic-card" onclick="showSubtopicPage('understanding-users', 'administrators')">
                            <h3>Administrators</h3>
                            <p>Administrative perspectives on AI policy, implementation, and institutional change.</p>
                        </div>
                        <div class="subtopic-card" onclick="showSubtopicPage('understanding-users', 'students')">
                            <h3>Students</h3>
                            <p>Understanding how students perceive and use AI tools in their learning processes.</p>
                        </div>
                        <div class="subtopic-card" onclick="showSubtopicPage('understanding-users', 'faculty')">
                            <h3>Faculty</h3>
                            <p>Faculty attitudes toward AI integration and their teaching practice adaptations.</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- General subtopic -->
            <div id="general" style="display: none;">
                <div class="topic-page-header">
                    <h1>General Perspectives on AI</h1>
                    <p>General perspectives on how people perceive and interact with AI systems.</p>
                </div>
                <div class="topic-content">
                    <div class="bibliography-container">
                        
                    </div>
                </div>
            </div>

            <!-- Faculty subtopic -->
            <div id="faculty" style="display: none;">
                <div class="topic-page-header">
                    <h1>Faculty Perspectives on AI</h1>
                    <p>Faculty attitudes toward AI integration and their teaching practice adaptations.</p>
                </div>
                <div class="topic-content">
                    <div class="bibliography-container">
                        

                        
                    </div>
                </div>
            </div>

            <!-- Students subtopic -->
            <div id="students" style="display: none;">
                <div class="topic-page-header">
                    <h1>Student Perspectives on AI</h1>
                    <p>Understanding how students perceive and use AI tools in their learning processes.</p>
                </div>
                <div class="topic-content">
                    <div class="bibliography-container">
                        

                        
                    </div>
                </div>
            </div>

            <!-- Administrators subtopic -->
            <div id="administrators" style="display: none;">
                <div class="topic-page-header">
                    <h1>Administrator Perspectives on AI</h1>
                    <p>Administrative perspectives on AI policy, implementation, and institutional change.</p>
                </div>
                <div class="topic-content">
                    <div class="bibliography-container">
                        <p style="text-align: center; padding: 40px; color: #666; font-style: italic;">
                            No bibliography entries yet. Check back soon for resources on administrative perspectives!
                        </p>
                    </div>
                </div>
            </div>

            <!-- Student Attitudes subtopic -->
            <div id="student-attitudes" style="display: none;">
                <div class="topic-page-header">
                    <h1>Student Attitudes &amp; Behaviors</h1>
                    <p>Understanding how students perceive and use AI tools in their learning processes.</p>
                </div>
                <div class="topic-content">
                    <div class="bibliography-container">
                        
                    </div>
                </div>
            </div>

            <!-- Evaluating Tools -->
            <div id="evaluating-tools" style="display: none;">
                <div class="topic-page-header">
                    <h1>Evaluating AI Tools</h1>
                    <p>These resources help us to answer questions about the capabilities of generative AI tools, which tools perform better on certain tasks, and how well AI-detection works.</p>
                </div>
                <div class="topic-content">
                    <div class="subtopic-cards">
                        <div class="subtopic-card" onclick="showSubtopicPage('evaluating-tools', 'coding')">
                            <h3>Coding</h3>
                            <p>Evaluating AI tools' capabilities in programming, code generation, and debugging tasks.</p>
                        </div>
                        <div class="subtopic-card" onclick="showSubtopicPage('evaluating-tools', 'creativity')">
                            <h3>Creativity</h3>
                            <p>Assessing AI's ability to generate creative content and support creative thinking processes.</p>
                        </div>
                        <div class="subtopic-card" onclick="showSubtopicPage('evaluating-tools', 'detection-tools')">
                            <h3>Detection Tools</h3>
                            <p>Evaluation of AI detection technologies and their effectiveness in educational contexts.</p>
                        </div>
                        <div class="subtopic-card" onclick="showSubtopicPage('evaluating-tools', 'ethics-safety')">
                            <h3>Ethics / Safety</h3>
                            <p>Examining ethical considerations and safety concerns in AI tool deployment.</p>
                        </div>
                        <div class="subtopic-card" onclick="showSubtopicPage('evaluating-tools', 'equity-social-justice')">
                            <h3>Equity / Social Justice</h3>
                            <p>Analyzing how AI tools impact educational equity and social justice issues.</p>
                        </div>
                        <div class="subtopic-card" onclick="showSubtopicPage('evaluating-tools', 'error-hallucination')">
                            <h3>Error / Hallucination</h3>
                            <p>Understanding AI errors, hallucinations, and accuracy limitations.</p>
                        </div>
                        <div class="subtopic-card" onclick="showSubtopicPage('evaluating-tools', 'reasoning')">
                            <h3>Reasoning</h3>
                            <p>Testing AI's logical reasoning, problem-solving, and critical thinking capabilities.</p>
                        </div>
                        <div class="subtopic-card" onclick="showSubtopicPage('evaluating-tools', 'usability')">
                            <h3>Usability</h3>
                            <p>Assessing user experience, interface design, and ease of use in AI tools.</p>
                        </div>
                        <div class="subtopic-card" onclick="showSubtopicPage('evaluating-tools', 'translation')">
                            <h3>Translation</h3>
                            <p>Evaluating AI translation capabilities and multilingual support quality.</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Detection Tools subtopic -->
            <div id="detection-tools" style="display: none;">
                <div class="topic-page-header">
                    <h1>Detection Tools</h1>
                    <p>Evaluation of AI detection technologies and their effectiveness in educational contexts.</p>
                </div>
                <div class="topic-content">
                    <div class="bibliography-container">
                        

                        

                        

                        

                        

                        

                        

                        

                        

                        

                        

                        
                    </div>
                </div>
            </div>

            <!-- Equity / Social Justice subtopic -->
            <div id="equity-social-justice" style="display: none;">
                <div class="topic-page-header">
                    <h1>Equity / Social Justice</h1>
                    <p>Analyzing how AI tools impact educational equity and social justice issues.</p>
                </div>
                <div class="topic-content">
                    <div class="bibliography-container">
                        
                    </div>
                </div>
            </div>

            <!-- Reasoning subtopic -->
            <div id="reasoning" style="display: none;">
                <div class="topic-page-header">
                    <h1>Reasoning</h1>
                    <p>Testing AI's logical reasoning, problem-solving, and critical thinking capabilities.</p>
                </div>
                <div class="topic-content">
                    <div class="bibliography-container">
                        
                    </div>
                </div>
            </div>

            <!-- Ethics / Safety subtopic -->
            <div id="ethics-safety" style="display: none;">
                <div class="topic-page-header">
                    <h1>Ethics / Safety</h1>
                    <p>Examining ethical considerations and safety concerns in AI tool deployment.</p>
                </div>
                <div class="topic-content">
                    <div class="bibliography-container">
                        

                        
                    </div>
                </div>
            </div>

            <!-- Usability subtopic -->
            <div id="usability" style="display: none;">
                <div class="topic-page-header">
                    <h1>Usability</h1>
                    <p>Assessing user experience, interface design, and ease of use in AI tools.</p>
                </div>
                <div class="topic-content">
                    <div class="bibliography-container">
                        

                        

                        

                        

                        

                        

                        
                    </div>
                </div>
            </div>

            <!-- Coding subtopic (placeholder) -->
            <div id="coding" style="display: none;">
                <div class="topic-page-header">
                    <h1>Coding</h1>
                    <p>Evaluating AI tools' capabilities in programming, code generation, and debugging tasks.</p>
                </div>
                <div class="topic-content">
                    <div class="bibliography-container">
                        <!-- Entries will be dynamically loaded here -->
                    </div>
                    <div class="empty-content-placeholder">
                        <div class="placeholder-message">
                            <i class="fas fa-code" style="font-size: 2.5rem; color: #57068c; margin-bottom: 15px;"></i>
                            <h3>Content in Development</h3>
                            <p>VIP Evaluating Tools subteam is currently curating resources on AI coding capabilities. We welcome your contributions and findings.</p>
                            <button class="contribute-btn" style="margin-top: 15px;" onclick="openContributePopup()">Share Your Research</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Creativity subtopic (placeholder) -->
            <div id="creativity" style="display: none;">
                <div class="topic-page-header">
                    <h1>Creativity</h1>
                    <p>Assessing AI's ability to generate creative content and support creative thinking processes.</p>
                </div>
                <div class="topic-content">
                    <div class="bibliography-container">
                        <!-- Entries will be dynamically loaded here -->
                    </div>
                    <div class="empty-content-placeholder">
                        <div class="placeholder-message">
                            <i class="fas fa-palette" style="font-size: 2.5rem; color: #57068c; margin-bottom: 15px;"></i>
                            <h3>Content in Development</h3>
                            <p>VIP Evaluating Tools subteam is currently curating resources on AI creativity and creative content generation. We welcome your contributions and findings.</p>
                            <button class="contribute-btn" style="margin-top: 15px;" onclick="openContributePopup()">Share Your Research</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Error / Hallucination subtopic -->
            <div id="error-hallucination" style="display: none;">
                <div class="topic-page-header">
                    <h1>Error / Hallucination</h1>
                    <p>Understanding AI errors, hallucinations, and accuracy limitations.</p>
                </div>
                <div class="topic-content">
                    <div class="bibliography-container">
                        
                    </div>
                </div>
            </div>

            <!-- Translation subtopic (placeholder) -->
            <div id="translation" style="display: none;">
                <div class="topic-page-header">
                    <h1>Translation</h1>
                    <p>Evaluating AI translation capabilities and multilingual support quality.</p>
                </div>
                <div class="topic-content">
                    <div class="bibliography-container">
                        <!-- Entries will be dynamically loaded here -->
                    </div>
                    <div class="empty-content-placeholder">
                        <div class="placeholder-message">
                            <i class="fas fa-language" style="font-size: 2.5rem; color: #57068c; margin-bottom: 15px;"></i>
                            <h3>Content in Development</h3>
                            <p>VIP Evaluating Tools subteam is currently curating resources on AI translation capabilities. We welcome your contributions and findings.</p>
                            <button class="contribute-btn" style="margin-top: 15px;" onclick="openContributePopup()">Share Your Research</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Assessing Impacts -->
            <div id="assessing-impacts" style="display: none;">
                <div class="topic-page-header">
                    <h1>Assessing Impacts</h1>
                    <p>Research on current and likely risks and benefits of AI on student learning through technological assessments.</p>
                </div>
                <div class="topic-content">
                    <div class="subtopic-cards">
                        <div class="subtopic-card" onclick="showSubtopicPage('assessing-impacts', 'learning-outcomes')">
                            <h3>Learning Outcomes</h3>
                            <p>Measuring how AI tools affect student learning, comprehension, and skill development.</p>
                        </div>
                        <div class="subtopic-card" onclick="showSubtopicPage('assessing-impacts', 'academic-integrity')">
                            <h3>Academic Integrity</h3>
                            <p>Assessment of AI's effect on academic honesty and institutional integrity measures.</p>
                        </div>
                        <div class="subtopic-card" onclick="showSubtopicPage('assessing-impacts', 'assessment-validity')">
                            <h3>Assessment Validity</h3>
                            <p>How AI tools impact the reliability and validity of educational assessments and grading practices.</p>
                        </div>
                        <div class="subtopic-card" onclick="showSubtopicPage('assessing-impacts', 'student-wellbeing')">
                            <h3>Student Experience + Wellbeing</h3>
                            <p>Impact of AI on student stress, motivation, confidence, and overall educational experience.</p>
                        </div>
                        <div class="subtopic-card" onclick="showSubtopicPage('assessing-impacts', 'equity-access')">
                            <h3>Equity + Access</h3>
                            <p>How AI tools affect educational equity and access across different student populations.</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Learning Outcomes subtopic -->
            <div id="learning-outcomes" style="display: none;">
                <div class="topic-page-header">
                    <h1>Learning Outcomes</h1>
                    <p>Measuring how AI tools affect student learning, comprehension, and skill development.</p>
                </div>
                <div class="topic-content">
                    <div class="bibliography-container">
                        

                        

                        

                        

                        

                        

                        

                        
                    </div>
                </div>
            </div>

            <!-- Innovating EdTech -->
            <div id="innovating-edtech" style="display: none;">
                <div class="topic-page-header">
                    <h1>Innovating EdTech</h1>
                    <p>These resources help us to answer questions like: What gaps exist in the education marketplace? What teaching and learning tools are absent, inadequate, or insufficient? How might we innovate to fill those gaps?</p>
                </div>
                <div class="topic-content">
                    <div class="subtopic-cards">
                        <div class="subtopic-card" onclick="showSubtopicPage('innovating-edtech', 'ai-tutoring')">
                            <h3>AI Tutoring &amp; Learning Support</h3>
                            <p>Tools that act as instructors, mentors, or study aids including tutorbots, homework helpers, and adaptive learning systems.</p>
                        </div>
                        <div class="subtopic-card" onclick="showSubtopicPage('innovating-edtech', 'writing-content-generation')">
                            <h3>Writing &amp; Content Generation Tools</h3>
                            <p>Tools that help students create or refine text and media, including writing assistants and translation tools.</p>
                        </div>
                        <div class="subtopic-card" onclick="showSubtopicPage('innovating-edtech', 'detection-integrity')">
                            <h3>Detection &amp; Academic Integrity Tools</h3>
                            <p>Tools that monitor or verify the authenticity of work, including AI-writing detectors and plagiarism checkers.</p>
                        </div>
                        <div class="subtopic-card" onclick="showSubtopicPage('innovating-edtech', 'organizational-productivity')">
                            <h3>Organizational &amp; Productivity Tools</h3>
                            <p>Tools that structure learning and manage large projects, such as note-taking and research assistants.</p>
                        </div>
                        <div class="subtopic-card" onclick="showSubtopicPage('innovating-edtech', 'feedback-assessment')">
                            <h3>Feedback &amp; Assessment Tools</h3>
                            <p>AI that evaluates or comments on student work, including automated grading and feedback generators.</p>
                        </div>
                        <div class="subtopic-card" onclick="showSubtopicPage('innovating-edtech', 'accessibility-inclusion')">
                            <h3>Accessibility &amp; Inclusion Tools</h3>
                            <p>AI that expands educational access through speech-to-text, captioning, and assistive technologies.</p>
                        </div>
                        <div class="subtopic-card" onclick="showSubtopicPage('innovating-edtech', 'learning-analytics')">
                            <h3>Classroom &amp; Learning Analytics</h3>
                            <p>AI systems that track and interpret educational activity, including analytics dashboards and early warning systems.</p>
                        </div>
                        <div class="subtopic-card" onclick="showSubtopicPage('innovating-edtech', 'scheduling')">
                            <h3>Scheduling</h3>
                            <p>Tools that facilitate appointment and meeting scheduling for educational contexts.</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Prototype Development subtopic -->
            <div id="prototype-development" style="display: none;">
                <div class="topic-page-header">
                    <h1>Prototype Development</h1>
                    <p>Creating and iterating on educational technology prototypes that leverage AI.</p>
                </div>
                <div class="topic-content">
                    <div class="bibliography-container">
                        
                    </div>
                </div>
            </div>

            <!-- AI Tutoring & Learning Support subtopic -->
            <div id="ai-tutoring" style="display: none;">
                <div class="topic-page-header">
                    <h1>AI Tutoring &amp; Learning Support</h1>
                    <p>Tools that act as instructors, mentors, or study aids including tutorbots, homework helpers, and adaptive learning systems.</p>
                </div>
                <div class="topic-content">
                    <div class="bibliography-container">
                        
                        
                    </div>
                </div>
            </div>

            <!-- Feedback & Assessment Tools subtopic -->
            <div id="feedback-assessment" style="display: none;">
                <div class="topic-page-header">
                    <h1>Feedback &amp; Assessment Tools</h1>
                    <p>AI that evaluates or comments on student work, including automated grading and feedback generators.</p>
                </div>
                <div class="topic-content">
                    <div class="bibliography-container">
                        
                    </div>
                </div>
            </div>

            <!-- Organizational & Productivity Tools subtopic -->
            <div id="organizational-productivity" style="display: none;">
                <div class="topic-page-header">
                    <h1>Organizational &amp; Productivity Tools</h1>
                    <p>Tools that structure learning and manage large projects, such as note-taking and research assistants.</p>
                </div>
                <div class="topic-content">
                    <div class="bibliography-container">
                        
                        
                    </div>
                </div>
            </div>

            <!-- Writing & Content Generation Tools subtopic -->
            <div id="writing-content-generation" style="display: none;">
                <div class="topic-page-header">
                    <h1>Writing & Content Generation Tools</h1>
                    <p>Tools that help students create or refine text and media, including writing assistants and translation tools.</p>
                </div>
                <div class="topic-content">
                    <div class="bibliography-container">

                    </div>
                    <div class="empty-content-placeholder">
                        <div class="placeholder-message">
                            <i class="fas fa-pen-fancy" style="font-size: 2.5rem; color: #57068c; margin-bottom: 15px;"></i>
                            <h3>Content in Development</h3>
                            <p>We're curating resources on AI writing and content generation tools. Share your findings and research!</p>
                            <button class="contribute-btn" style="margin-top: 15px;" onclick="openContributePopup()">Share Your Research</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Detection & Academic Integrity Tools subtopic -->
            <div id="detection-integrity" style="display: none;">
                <div class="topic-page-header">
                    <h1>Detection & Academic Integrity Tools</h1>
                    <p>Tools that monitor or verify the authenticity of work, including AI-writing detectors and plagiarism checkers.</p>
                </div>
                <div class="topic-content">
                    <div class="bibliography-container">

                    </div>
                    <div class="empty-content-placeholder">
                        <div class="placeholder-message">
                            <i class="fas fa-shield-alt" style="font-size: 2.5rem; color: #57068c; margin-bottom: 15px;"></i>
                            <h3>Content in Development</h3>
                            <p>We're collecting research on AI detection and academic integrity tools. Contribute your insights!</p>
                            <button class="contribute-btn" style="margin-top: 15px;" onclick="openContributePopup()">Share Your Research</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Accessibility & Inclusion Tools subtopic -->
            <div id="accessibility-inclusion" style="display: none;">
                <div class="topic-page-header">
                    <h1>Accessibility & Inclusion Tools</h1>
                    <p>AI that expands educational access through speech-to-text, captioning, and assistive technologies.</p>
                </div>
                <div class="topic-content">
                    <div class="bibliography-container">

                    </div>
                    <div class="empty-content-placeholder">
                        <div class="placeholder-message">
                            <i class="fas fa-universal-access" style="font-size: 2.5rem; color: #57068c; margin-bottom: 15px;"></i>
                            <h3>Content in Development</h3>
                            <p>We're gathering research on AI accessibility and inclusion tools. Share your knowledge!</p>
                            <button class="contribute-btn" style="margin-top: 15px;" onclick="openContributePopup()">Share Your Research</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Classroom & Learning Analytics subtopic -->
            <div id="learning-analytics" style="display: none;">
                <div class="topic-page-header">
                    <h1>Classroom & Learning Analytics</h1>
                    <p>AI systems that track and interpret educational activity, including analytics dashboards and early warning systems.</p>
                </div>
                <div class="topic-content">
                    <div class="bibliography-container">

                    </div>
                    <div class="empty-content-placeholder">
                        <div class="placeholder-message">
                            <i class="fas fa-chart-line" style="font-size: 2.5rem; color: #57068c; margin-bottom: 15px;"></i>
                            <h3>Content in Development</h3>
                            <p>We're compiling research on learning analytics and classroom data systems. Contribute your findings!</p>
                            <button class="contribute-btn" style="margin-top: 15px;" onclick="openContributePopup()">Share Your Research</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Scheduling subtopic -->
            <div id="scheduling" style="display: none;">
                <div class="topic-page-header">
                    <h1>Scheduling</h1>
                    <p>Tools that facilitate appointment and meeting scheduling for educational contexts.</p>
                </div>
                <div class="topic-content">
                    <div class="bibliography-container">

                    </div>
                    <div class="empty-content-placeholder">
                        <div class="placeholder-message">
                            <i class="fas fa-calendar-alt" style="font-size: 2.5rem; color: #57068c; margin-bottom: 15px;"></i>
                            <h3>Content in Development</h3>
                            <p>We're collecting resources on AI-powered scheduling tools for education. Share your insights!</p>
                            <button class="contribute-btn" style="margin-top: 15px;" onclick="openContributePopup()">Share Your Research</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Placeholder for other subtopics -->
            <div id="faculty-perspectives" style="display: none;">
                <div class="topic-page-header">
                    <h1>Faculty Perspectives</h1>
                    <p>Faculty attitudes toward AI integration and their teaching practice adaptations.</p>
                </div>
                <div class="topic-content">
                    <div class="empty-content-placeholder">
                        <div class="placeholder-message">
                            <i class="fas fa-book-open" style="font-size: 2.5rem; color: #57068c; margin-bottom: 15px;"></i>
                            <h3>Content in Development</h3>
                            <p>VIP Understanding Users subteam is currently curating resources for this research area. We welcome your contributions and findings.</p>
                            <button class="contribute-btn" style="margin-top: 15px;" onclick="openContributePopup()">Share Your Research</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Additional Understanding Users subtopics -->
            <div id="administrator-views" style="display: none;">
                <div class="topic-page-header">
                    <h1>Administrator Views</h1>
                    <p>Administrative perspectives on AI policy, implementation, and institutional change.</p>
                </div>
                <div class="topic-content">
                    <div class="empty-content-placeholder">
                        <div class="placeholder-message">
                            <i class="fas fa-book-open" style="font-size: 2.5rem; color: #57068c; margin-bottom: 15px;"></i>
                            <h3>Content in Development</h3>
                            <p>VIP Understanding Users subteam is currently curating resources for this research area. We welcome your contributions and findings.</p>
                            <button class="contribute-btn" style="margin-top: 15px;" onclick="openContributePopup()">Share Your Research</button>
                        </div>
                    </div>
                </div>
            </div>

            <div id="ai-competencies" style="display: none;">
                <div class="topic-page-header">
                    <h1>AI Competencies &amp; Literacy</h1>
                    <p>Assessment of AI literacy levels and competency development across user groups.</p>
                </div>
                <div class="topic-content">
                    <div class="bibliography-container">
                        
                    </div>
                </div>
            </div>

            <!-- Additional Evaluating Tools subtopics -->
            <div id="genai-capabilities" style="display: none;">
                <div class="topic-page-header">
                    <h1>GenAI Tool Capabilities</h1>
                    <p>Assessment of what current generative AI tools can and cannot do for education.</p>
                </div>
                <div class="topic-content">
                    <div class="bibliography-container">
                        
                    </div>
                </div>
            </div>

            <div id="tool-limitations" style="display: none;">
                <div class="topic-page-header">
                    <h1>Tool Limitations &amp; Biases</h1>
                    <p>Understanding the constraints, biases, and failure modes of AI educational tools.</p>
                </div>
                <div class="topic-content">
                    <div class="bibliography-container">
                        
                    </div>
                </div>
            </div>

            <div id="comparative-analysis" style="display: none;">
                <div class="topic-page-header">
                    <h1>Comparative Tool Analysis</h1>
                    <p>Side-by-side comparisons of different AI tools for specific educational tasks.</p>
                </div>
                <div class="topic-content">
                    <div class="empty-content-placeholder">
                        <div class="placeholder-message">
                            <i class="fas fa-book-open" style="font-size: 2.5rem; color: #57068c; margin-bottom: 15px;"></i>
                            <h3>Content in Development</h3>
                            <p>VIP Evaluating Tools subteam is currently curating comparative studies. We welcome your tool evaluation research and findings.</p>
                            <button class="contribute-btn" style="margin-top: 15px;" onclick="openContributePopup()">Share Your Research</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Additional Assessing Impacts subtopics -->
            <div id="academic-integrity" style="display: none;">
                <div class="topic-page-header">
                    <h1>Academic Integrity</h1>
                    <p>Assessment of AI's effect on academic honesty and institutional integrity measures.</p>
                </div>
                <div class="topic-content">
                    <div class="bibliography-container">
                        

                        

                        

                        
                    </div>
                </div>
            </div>

            <!-- Assessment Validity subtopic -->
<div id="assessment-validity" style="display: none;">
    <div class="topic-page-header">
        <h1>Assessment Validity</h1>
        <p>How AI tools impact the reliability and validity of educational assessments and grading practices.</p>
    </div>
    <div class="topic-content">
        <div class="bibliography-container">
            
        </div>
    </div>
</div>

<!-- Student Experience + Wellbeing subtopic -->
<div id="student-wellbeing" style="display: none;">
    <div class="topic-page-header">
        <h1>Student Experience + Wellbeing</h1>
        <p>Impact of AI on student stress, motivation, confidence, and overall educational experience.</p>
    </div>
    <div class="topic-content">
        <div class="bibliography-container">
            
        </div>
    </div>
</div>

            <div id="equity-access" style="display: none;">
                <div class="topic-page-header">
                    <h1>Equity &amp; Access Issues</h1>
                    <p>How AI tools affect educational equity and access across different student populations.</p>
                </div>
                <div class="topic-content">
                    <div class="bibliography-container">
                        

                        

                        
                    </div>
                </div>
            </div>

            <!-- Additional Innovating EdTech subtopics -->
            <div id="user-testing" style="display: none;">
                <div class="topic-page-header">
                    <h1>User Testing &amp; Feedback</h1>
                    <p>Methods for testing educational prototypes with real users and gathering feedback.</p>
                </div>
                <div class="topic-content">
                    <div class="bibliography-container">
                        
                    </div>
                </div>
            </div>

            <div id="integration-strategies" style="display: none;">
                <div class="topic-page-header">
                    <h1>Integration Strategies</h1>
                    <p>Approaches for integrating new AI technologies into existing educational systems.</p>
                </div>
                <div class="topic-content">
                    <div class="empty-content-placeholder">
                        <div class="placeholder-message">
                            <i class="fas fa-book-open" style="font-size: 2.5rem; color: #57068c; margin-bottom: 15px;"></i>
                            <h3>Content in Development</h3>
                            <p>VIP Innovating EdTech subteam is currently curating integration methodologies. We welcome your implementation research and case studies.</p>
                            <button class="contribute-btn" style="margin-top: 15px;" onclick="openContributePopup()">Share Your Research</button>
                        </div>
                    </div>
                </div>
            </div>

            <div id="scalability-assessment" style="display: none;">
                <div class="topic-page-header">
                    <h1>Scalability Assessment</h1>
                    <p>Evaluating the potential for scaling educational technology innovations.</p>
                </div>
                <div class="topic-content">
                    <div class="bibliography-container">
                        
                    </div>
                </div>
            </div>

            <!-- Research Methods & Resources -->
            <div id="research-methods" style="display: none;">
                <div class="topic-page-header">
                    <h1>Research Methods &amp; Resources</h1>
                    <p>These sources will help you identify a research gap, design appropriate research methodologies, interpret your findings, and find publication in a peer-reviewed journal.</p>
                </div>
                <div class="topic-content">
                    <div class="subtopic-cards">
                        <div class="subtopic-card" onclick="showSubtopicPage('research-methods', 'literature-review')">
                            <h3>Literature Review Methods</h3>
                            <p>Systematic approaches to finding, evaluating, and synthesizing existing research in AI education.</p>
                        </div>
                        <div class="subtopic-card" onclick="showSubtopicPage('research-methods', 'collaborative-research')">
                            <h3>Collaborative Research</h3>
                            <p>Best practices for team-based research, project management, and interdisciplinary collaboration.</p>
                        </div>
                        <div class="subtopic-card" onclick="showSubtopicPage('research-methods', 'experimental-design')">
                            <h3>Experimental Design</h3>
                            <p>Methods for designing controlled studies to test AI tool effectiveness and educational interventions.</p>
                        </div>
                        <div class="subtopic-card" onclick="showSubtopicPage('research-methods', 'survey-design')">
                            <h3>Survey Design &amp; Analysis</h3>
                            <p>Best practices for creating effective surveys and analyzing quantitative data in educational research.</p>
                        </div>
                        <div class="subtopic-card" onclick="showSubtopicPage('research-methods', 'interview-focus-groups')">
                            <h3>Interview &amp; Focus Group Methods</h3>
                            <p>Techniques for conducting qualitative interviews and focus groups with students, faculty, and administrators.</p>
                        </div>
                        <div class="subtopic-card" onclick="showSubtopicPage('research-methods', 'data-analysis')">
                            <h3>Data Analysis Techniques</h3>
                            <p>Statistical and qualitative analysis methods for educational research data and findings interpretation.</p>
                        </div>
                        <div class="subtopic-card" onclick="showSubtopicPage('research-methods', 'research-ethics')">
                            <h3>Research Ethics &amp; IRB</h3>
                            <p>Ethical considerations and IRB approval processes for educational research involving human subjects.</p>
                        </div>
                        <div class="subtopic-card" onclick="showSubtopicPage('research-methods', 'academic-writing')">
                            <h3>Academic Writing &amp; Publication</h3>
                            <p>Guidelines for writing research papers, conference presentations, and academic publications.</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Learning Science -->
            <div id="learning-science" style="display: none;">
                <div class="topic-page-header">
                    <h1>Learning Science</h1>
                    <p>Research on the cognitive, psychological, and pedagogical foundations of learning with AI tools.</p>
                </div>
                <div class="topic-content">
                    <div class="subtopic-cards">
                        <div class="subtopic-card" onclick="showSubtopicPage('learning-science', 'writing-composition')">
                            <h3>Writing &amp; Composition</h3>
                            <p>Cognitive and developmental theories of writing processes and instruction.</p>
                        </div>
                        <div class="subtopic-card" onclick="showSubtopicPage('learning-science', 'cognitive-science')">
                            <h3>Cognitive Science</h3>
                            <p>Research on cognitive load, memory, creativity, and learning processes.</p>
                        </div>
                        <div class="subtopic-card" onclick="showSubtopicPage('learning-science', 'reading-literacy')">
                            <h3>Reading &amp; Literacy</h3>
                            <p>Deep reading, textual interpretation, and the ethics of literary engagement.</p>
                        </div>
                        <div class="subtopic-card" onclick="showSubtopicPage('learning-science', 'educational-philosophy')">
                            <h3>Educational Philosophy</h3>
                            <p>Philosophical foundations of education, purpose, measurement, and teacher agency.</p>
                        </div>
                        <div class="subtopic-card" onclick="showSubtopicPage('learning-science', 'ai-ml-foundations')">
                            <h3>AI/ML Foundations</h3>
                            <p>Technical foundations of AI and machine learning relevant to education.</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Writing & Composition subtopic -->
            <div id="writing-composition" style="display: none;">
                <div class="topic-page-header">
                    <h1>Writing &amp; Composition</h1>
                    <p>Cognitive and developmental theories of writing processes and instruction.</p>
                </div>
                <div class="topic-content">
                    <div class="bibliography-container">
                        

                        

                        

                        

                        
                    </div>
                </div>
            </div>

            <!-- Cognitive Science subtopic -->
            <div id="cognitive-science" style="display: none;">
                <div class="topic-page-header">
                    <h1>Cognitive Science</h1>
                    <p>Research on cognitive load, memory, creativity, and learning processes.</p>
                </div>
                <div class="topic-content">
                    <div class="bibliography-container">
                        

                        
                    </div>
                </div>
            </div>

            <!-- Reading & Literacy subtopic -->
            <div id="reading-literacy" style="display: none;">
                <div class="topic-page-header">
                    <h1>Reading &amp; Literacy</h1>
                    <p>Deep reading, textual interpretation, and the ethics of literary engagement.</p>
                </div>
                <div class="topic-content">
                    <div class="bibliography-container">
                        

                        
                    </div>
                </div>
            </div>

            <!-- Educational Philosophy subtopic -->
            <div id="educational-philosophy" style="display: none;">
                <div class="topic-page-header">
                    <h1>Educational Philosophy</h1>
                    <p>Philosophical foundations of education, purpose, measurement, and teacher agency.</p>
                </div>
                <div class="topic-content">
                    <div class="bibliography-container">
                        

                        

                        

                        
                    </div>
                </div>
            </div>

            <!-- AI/ML Foundations subtopic -->
            <div id="ai-ml-foundations" style="display: none;">
                <div class="topic-page-header">
                    <h1>AI/ML Foundations</h1>
                    <p>Technical foundations of AI and machine learning relevant to education.</p>
                </div>
                <div class="topic-content">
                    <div class="bibliography-container">
                        

                        
                    </div>
                </div>
            </div>

            <!-- Team Members Page -->
            <div id="team-members" style="display: none;">
                <div class="topic-page-header">
                    <h1>Our Team</h1>
                    <p>Our VIP team is composed of dedicated students and faculty contributing to AI in Education research.</p>
                </div>
                <div class="topic-content">
                    <div id="team-members-list" style="max-width: 800px; margin: 0 auto;">
                        <!-- Content will be populated by JavaScript -->
                    </div>
                </div>
            </div>

            <!-- Contributor Pages will be dynamically generated -->
        </div>
    </main>

    <div class="source-modal" id="sourceModal">
        <div class="source-modal-content">
            <div class="source-modal-header">
                <div class="source-modal-title" id="modalTitle">Source Title</div>
                <button class="close-modal" onclick="closeSourceModal()">Ã—</button>
            </div>
            <div class="source-iframe-container">
                <iframe class="source-iframe" id="sourceIframe" src=""></iframe>
            </div>
        </div>
    </div>

    <footer class="site-footer">
        <div class="container">
            <div class="footer-grid">
               
                
                <div class="footer-column">
                    <h3>About the Team</h3>
                    <ul class="footer-links">
                        <li><a href="https://as.nyu.edu/faculty/alexander-landfair.html" target="_blank">Faculty Advisor: Alexander Landfair</a></li>
                        <li><a href="#" onclick="showTopicPage('team-members'); return false;">Our Team</a></li>
                        <li><a href="https://engineering.nyu.edu/vip-team/ai-education-1" target="_blank">Ongoing Projects</a></li>
                        <li><a href="https://engineering.nyu.edu/vip-team/ai-education-1" target="_blank">Application Process</a></li>
                    </ul>
                </div>
                
                <div class="footer-column">
                    <h3>Partners &amp; Resources</h3>
                    <ul class="footer-links">
                        <li><a href="https://cas.nyu.edu/ewp.html" target="_blank">NYU Expository Writing Program</a></li>
                        <li><a href="https://cas.nyu.edu/ewp/writing-center.html" target="_blank">NYU Writing Center</a></li>
                        <li><a href="https://engineering.nyu.edu/research-innovation/student-research/vertically-integrated-projects" target="_blank">Tandon VIP Program</a></li>                        <li><a href="#">Academic Support</a></li>
                    </ul>
                </div>
            </div>
            
            <div class="footer-bottom">
                <p>Â© 2025 AI in Education VIP Team | NYU Tandon School of Engineering | Professor Alexander Landfair</p>
            </div>
        </div>
    </footer>

    <div class="popup" id="contribute-popup">
        <div class="popup-content">
            <span class="close-btn" onclick="closePopup()">Ã—</span>
            <iframe src="https://docs.google.com/forms/d/e/1FAIpQLSeORMy6rhVbfiJy9oDd_8H13_Br2nAo6AyX45LjN3GNFGVN7A/viewform?embedded=true" width="100%" height="100%" frameborder="0" marginheight="0" marginwidth="0">Loadingâ€¦</iframe>
        </div>
    </div>

    <!-- Admin Panel -->
    <div class="popup" id="admin-panel" style="display: none;">
        <div class="popup-content" style="max-width: 1000px; max-height: 90vh; overflow-y: auto;">
            <span class="close-btn" onclick="closeAdminPanel()">Ã—</span>
            <h2 style="color: #57068c; margin-bottom: 20px;">Admin Console</h2>

            <!-- Tabs -->
            <div style="display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 2px solid #e0e0e0;">
                <button id="users-tab" class="admin-tab active" onclick="switchAdminTab('users')" style="padding: 10px 20px; border: none; background: none; cursor: pointer; font-weight: 600; border-bottom: 3px solid #57068c; color: #57068c;">
                    <i class="fas fa-users"></i> Users
                </button>
                <button id="contributions-tab" class="admin-tab" onclick="switchAdminTab('contributions')" style="padding: 10px 20px; border: none; background: none; cursor: pointer; font-weight: 600; border-bottom: 3px solid transparent; color: #666;">
                    <i class="fas fa-file-alt"></i> Contributions
                </button>
                <button id="semester-config-tab" class="admin-tab" onclick="switchAdminTab('semester-config')" style="padding: 10px 20px; border: none; background: none; cursor: pointer; font-weight: 600; border-bottom: 3px solid transparent; color: #666;">
                    <i class="fas fa-calendar-alt"></i> Semester Config
                </button>
            </div>

            <!-- Users Panel -->
            <div id="admin-users-panel" style="display: block;">
                <div style="margin-bottom: 20px;">
                    <input type="text" id="admin-search" placeholder="Search by email..." style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-family: 'Montserrat', sans-serif;">
                </div>
                <div id="users-list" style="max-height: 500px; overflow-y: auto;">
                    <p style="text-align: center; color: #666; padding: 20px;">Loading users...</p>
                </div>
            </div>

            <!-- Contributions Panel -->
            <div id="admin-contributions-panel" style="display: none;">
                <div style="margin-bottom: 20px; display: flex; gap: 10px; align-items: center;">
                    <input type="text" id="contributions-search" placeholder="Search contributions..." style="flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-family: 'Montserrat', sans-serif;">
                    <button onclick="refreshContributions()" style="padding: 10px 20px; background: #57068c; color: white; border: none; border-radius: 4px; cursor: pointer;">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                    <button onclick="deleteAllContributions()" style="padding: 10px 20px; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer;">
                        <i class="fas fa-trash-alt"></i> Delete All
                    </button>
                    <button onclick="migrateHardcodedEntries()" style="padding: 10px 20px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer;">
                        <i class="fas fa-database"></i> Migrate HTML Entries
                    </button>
                </div>
                <div id="migration-status" style="margin-bottom: 15px; padding: 10px; background: #f8f9fa; border-radius: 4px; display: none;"></div>
                <div id="contributions-list" style="max-height: 500px; overflow-y: auto;">
                    <p style="text-align: center; color: #666; padding: 20px;">Loading contributions...</p>
                </div>
            </div>

            <!-- Semester Configuration Panel -->
            <div id="admin-semester-config-panel" style="display: none;">
                <div style="background: #f0f7ff; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #57068c;">
                    <h3 style="color: #57068c; margin-bottom: 8px; font-size: 1.1rem;"><i class="fas fa-info-circle"></i> About Semester Configuration</h3>
                    <p style="color: #666; margin: 0; font-size: 0.95rem;">Configure semester dates, contribution periods, and pacing requirements for first-year and continuing contributors.</p>
                </div>

                <form id="semester-config-form" onsubmit="saveSemesterConfig(event)">
                    <!-- Semester Dates -->
                    <div style="background: white; padding: 20px; border-radius: 8px; border: 1px solid #e0e0e0; margin-bottom: 20px;">
                        <h3 style="color: #2d2d2d; margin-bottom: 15px; font-size: 1.1rem;"><i class="fas fa-calendar"></i> Semester Dates</h3>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <div>
                                <label style="display: block; font-weight: 500; margin-bottom: 5px; color: #2d2d2d;">Start Date</label>
                                <input type="date" id="semester-start-date" required style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-family: 'Montserrat', sans-serif;">
                            </div>
                            <div>
                                <label style="display: block; font-weight: 500; margin-bottom: 5px; color: #2d2d2d;">End Date</label>
                                <input type="date" id="semester-end-date" required style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-family: 'Montserrat', sans-serif;">
                            </div>
                        </div>
                    </div>

                    <!-- First-Year Contributor Settings -->
                    <div style="background: white; padding: 20px; border-radius: 8px; border: 1px solid #e0e0e0; margin-bottom: 20px;">
                        <h3 style="color: #2d2d2d; margin-bottom: 15px; font-size: 1.1rem;"><i class="fas fa-user-graduate"></i> First-Year Contributors</h3>
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px;">
                            <div>
                                <label style="display: block; font-weight: 500; margin-bottom: 5px; color: #2d2d2d;">Period Length (days)</label>
                                <input type="number" id="first-year-period-length" min="1" required style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-family: 'Montserrat', sans-serif;">
                                <small style="color: #666; font-size: 0.85rem;">e.g., 14 for every 2 weeks</small>
                            </div>
                            <div>
                                <label style="display: block; font-weight: 500; margin-bottom: 5px; color: #2d2d2d;">Min per Period</label>
                                <input type="number" id="first-year-min-per-period" min="1" required style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-family: 'Montserrat', sans-serif;">
                                <small style="color: #666; font-size: 0.85rem;">Minimum required</small>
                            </div>
                            <div>
                                <label style="display: block; font-weight: 500; margin-bottom: 5px; color: #2d2d2d;">Max per Period</label>
                                <input type="number" id="first-year-max-per-period" min="1" required style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-family: 'Montserrat', sans-serif;">
                                <small style="color: #666; font-size: 0.85rem;">Maximum allowed</small>
                            </div>
                        </div>
                    </div>

                    <!-- Continuing Contributor Settings -->
                    <div style="background: white; padding: 20px; border-radius: 8px; border: 1px solid #e0e0e0; margin-bottom: 20px;">
                        <h3 style="color: #2d2d2d; margin-bottom: 15px; font-size: 1.1rem;"><i class="fas fa-user-check"></i> Continuing Contributors</h3>
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px;">
                            <div>
                                <label style="display: block; font-weight: 500; margin-bottom: 5px; color: #2d2d2d;">Period Length (days)</label>
                                <input type="number" id="continuing-period-length" min="1" required style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-family: 'Montserrat', sans-serif;">
                                <small style="color: #666; font-size: 0.85rem;">e.g., 30 for monthly</small>
                            </div>
                            <div>
                                <label style="display: block; font-weight: 500; margin-bottom: 5px; color: #2d2d2d;">Min per Period</label>
                                <input type="number" id="continuing-min-per-period" min="1" required style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-family: 'Montserrat', sans-serif;">
                                <small style="color: #666; font-size: 0.85rem;">Minimum required</small>
                            </div>
                            <div>
                                <label style="display: block; font-weight: 500; margin-bottom: 5px; color: #2d2d2d;">Max per Period</label>
                                <input type="number" id="continuing-max-per-period" min="1" required style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-family: 'Montserrat', sans-serif;">
                                <small style="color: #666; font-size: 0.85rem;">Maximum allowed</small>
                            </div>
                        </div>
                    </div>

                    <!-- Save Button -->
                    <div style="display: flex; justify-content: flex-end; gap: 10px;">
                        <button type="button" onclick="loadSemesterConfig()" style="padding: 12px 24px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600;">
                            <i class="fas fa-undo"></i> Reset
                        </button>
                        <button type="submit" style="padding: 12px 24px; background: #57068c; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600;">
                            <i class="fas fa-save"></i> Save Configuration
                        </button>
                    </div>
                </form>

                <div id="semester-config-status" style="margin-top: 15px; padding: 12px; border-radius: 4px; display: none;"></div>
            </div>
        </div>
    </div>

    <!-- Contribution Modal -->
    <div class="popup" id="contribution-modal" style="display: none;">
        <div class="popup-content" style="max-width: 800px; max-height: 90vh; overflow-y: auto;">
            <span class="close-btn" onclick="closeContributionModal()">Ã—</span>
            <h2 style="color: #57068c; margin-bottom: 20px;">Add New Research Entry</h2>

            <form id="contribution-form" onsubmit="submitContribution(event)" novalidate>
                <!-- Admin: Contribute on behalf of team member -->
                <div id="admin-contributor-selector" style="display: none; margin-bottom: 20px; padding: 15px; background: #f0f7ff; border-left: 4px solid #57068c; border-radius: 4px;">
                    <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #2d2d2d;">
                        <i class="fas fa-user-shield"></i> Contributing as Admin on behalf of:
                    </label>
                    <div style="position: relative;">
                        <select id="behalf-of-user" onchange="updateContributorPreview()" style="width: 100%; padding: 10px 10px 10px 50px; border: 1px solid #ddd; border-radius: 4px; font-family: 'Montserrat', sans-serif;">
                            <option value="">-- Select team member --</option>
                        </select>
                        <img id="contributor-preview-img" src="" style="display: none; position: absolute; left: 10px; top: 50%; transform: translateY(-50%); width: 32px; height: 32px; border-radius: 50%; object-fit: cover; border: 2px solid #57068c;">
                    </div>
                    <small style="color: #666; display: block; margin-top: 5px;">Leave blank to contribute under your own name</small>
                </div>

                <!-- Step 1: Category Selection (Topic, Subtopic, and Secondary Categories) -->
                <div id="step-category" class="contribution-step">
                    <h3 style="color: #2d2d2d; margin-bottom: 15px;">Select Primary Category</h3>

                    <!-- Topic Selection -->
                    <h4 style="color: #57068c; margin-bottom: 10px; font-size: 0.95rem;">Select Topic</h4>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-bottom: 20px;">
                        <label class="topic-option">
                            <input type="radio" name="topic" value="evaluating-tools" required="" onchange="updateSubtopicOptions()">
                            <span><i class="fas fa-tools"></i> Evaluating Tools</span>
                        </label>
                        <label class="topic-option">
                            <input type="radio" name="topic" value="understanding-users" required="" onchange="updateSubtopicOptions()">
                            <span><i class="fas fa-users"></i> Understanding Users</span>
                        </label>
                        <label class="topic-option">
                            <input type="radio" name="topic" value="assessing-impacts" required="" onchange="updateSubtopicOptions()">
                            <span><i class="fas fa-chart-line"></i> Assessing Impacts</span>
                        </label>
                        <label class="topic-option">
                            <input type="radio" name="topic" value="innovating-edtech" required="" onchange="updateSubtopicOptions()">
                            <span><i class="fas fa-lightbulb"></i> Innovating EdTech</span>
                        </label>
                        <label class="topic-option">
                            <input type="radio" name="topic" value="learning-science" required="" onchange="updateSubtopicOptions()">
                            <span><i class="fas fa-brain"></i> Learning Science</span>
                        </label>
                        <label class="topic-option">
                            <input type="radio" name="topic" value="research-methods" required="" onchange="updateSubtopicOptions()">
                            <span><i class="fas fa-book"></i> Research Methods</span>
                        </label>
                    </div>

                    <!-- Subtopic Selection -->
                    <div id="subtopic-section" style="display: none;">
                        <h4 style="color: #57068c; margin-bottom: 10px; font-size: 0.95rem;">Select Subtopic</h4>
                        <select id="subtopic-select" name="subtopic" required="" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-family: 'Montserrat', sans-serif; margin-bottom: 20px;">
                            <option value="">-- Select a subtopic --</option>
                        </select>

                        <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #57068c;">
                            <h4 style="margin: 0 0 10px 0; color: #57068c; font-size: 0.95rem;">
                                <i class="fas fa-info-circle"></i> Add Secondary Categories (Optional)
                            </h4>
                            <p style="margin: 0 0 15px 0; color: #666; font-size: 0.9rem;">
                                If this source is relevant to multiple topics, you can add up to 2 additional categories.
                            </p>
                            <div id="secondary-categories-container">
                                <!-- Secondary categories will be added here -->
                            </div>
                            <button type="button" id="add-secondary-category-btn" onclick="addSecondaryCategory()"
                                    style="padding: 8px 16px; background: white; border: 2px dashed #57068c; color: #57068c; border-radius: 4px; cursor: pointer; font-family: 'Montserrat', sans-serif; font-weight: 600; font-size: 0.9rem;">
                                <i class="fas fa-plus"></i> Add Secondary Category
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Step 2: Bibliographic Information -->
                <div id="step-bibliography" class="contribution-step" style="display: none;">
                    <h3 style="color: #2d2d2d; margin-bottom: 15px;">Bibliographic Information</h3>

                    <!-- DOI Auto-fill Section -->
                    <div id="doi-autofill-section" style="margin-bottom: 25px; padding: 20px; background: linear-gradient(135deg, #f8f0ff 0%, #fff 100%); border: 2px solid #57068c; border-radius: 8px;">
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                            <i class="fas fa-magic" style="color: #57068c; font-size: 1.2rem;"></i>
                            <h4 style="margin: 0; color: #57068c; font-size: 1rem;">Quick Entry with DOI</h4>
                        </div>
                        <p style="margin: 0 0 15px 0; color: #666; font-size: 0.9rem;">
                            Have a DOI? Enter it below and we'll automatically fill in all the bibliographic details for you!
                        </p>
                        <div style="display: flex; gap: 10px; align-items: flex-start;">
                            <div style="flex: 1;">
                                <input type="text" id="doi-autofill-input" placeholder="e.g., 10.1007/s40593-020-00216-z or https://doi.org/10.1007/..."
                                       onkeypress="if(event.key === 'Enter') { event.preventDefault(); fetchFromDOI(); }"
                                       style="width: 100%; padding: 12px; border: 2px solid #57068c; border-radius: 4px; font-family: 'Montserrat', sans-serif; font-size: 0.95rem;">
                                <small style="color: #666; display: block; margin-top: 5px;">
                                    Enter the DOI or paste a DOI URL (press Enter or click Fetch Details)
                                </small>
                            </div>
                            <button type="button" onclick="fetchFromDOI()" id="fetch-doi-btn"
                                    style="padding: 12px 24px; background: #57068c; color: white; border: none; border-radius: 4px; cursor: pointer; font-family: 'Montserrat', sans-serif; font-weight: 600; white-space: nowrap; height: 48px;">
                                <i class="fas fa-search"></i> Fetch Details
                            </button>
                        </div>
                        <div id="doi-loading" style="display: none; margin-top: 15px; padding: 12px; background: white; border-radius: 4px; border-left: 4px solid #57068c;">
                            <i class="fas fa-spinner fa-spin"></i> Fetching citation data from CrossRef...
                        </div>
                        <div id="doi-success" style="display: none; margin-top: 15px; padding: 12px; background: #d4edda; border-radius: 4px; border-left: 4px solid #28a745; color: #155724;">
                            <i class="fas fa-check-circle"></i> Successfully loaded! Review the details below and proceed.
                        </div>
                        <div id="doi-error" style="display: none; margin-top: 15px; padding: 12px; background: #f8d7da; border-radius: 4px; border-left: 4px solid #dc3545; color: #721c24;">
                            <i class="fas fa-exclamation-triangle"></i> <span id="doi-error-message">Could not fetch data. Please enter manually.</span>
                        </div>
                        <div style="margin-top: 15px; text-align: center;">
                            <a href="#" onclick="showManualEntry(); return false;" id="manual-entry-link"
                               style="color: #57068c; text-decoration: none; font-size: 0.9rem; font-weight: 500;">
                                <i class="fas fa-edit"></i> Don't have a DOI? Enter manually instead
                            </a>
                        </div>
                    </div>

                    <!-- Manual Entry Fields (initially hidden if DOI autofill succeeds) -->
                    <div id="manual-bibliography-fields">
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; font-weight: 500; margin-bottom: 5px; color: #2d2d2d;">Authors *</label>
                            <input type="text" id="authors" name="authors" required="" placeholder="e.g., Smith, J., &amp; Johnson, A." style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-family: 'Montserrat', sans-serif;">
                            <small style="color: #666;">Format: Last, F., &amp; Last, F.</small>
                        </div>

                    <div style="margin-bottom: 15px;">
                        <label style="display: block; font-weight: 500; margin-bottom: 5px; color: #2d2d2d;">Year *</label>
                        <input type="number" id="year" name="year" required="" placeholder="e.g., 2024" min="1900" max="2100" style="width: 150px; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-family: 'Montserrat', sans-serif;">
                    </div>

                    <div style="margin-bottom: 15px;">
                        <label style="display: block; font-weight: 500; margin-bottom: 5px; color: #2d2d2d;">Title *</label>
                        <input type="text" id="title" name="title" required="" placeholder="Article or book title" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-family: 'Montserrat', sans-serif;">
                    </div>

                    <div style="margin-bottom: 15px;">
                        <label style="display: block; font-weight: 500; margin-bottom: 5px; color: #2d2d2d;">Publication Type *</label>
                        <select id="pub-type" name="pubType" required="" onchange="togglePublicationFields()" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-family: 'Montserrat', sans-serif;">
                            <option value="">-- Select type --</option>
                            <option value="journal">Journal Article</option>
                            <option value="book">Book</option>
                            <option value="chapter">Book Chapter</option>
                            <option value="conference">Conference Paper</option>
                            <option value="preprint">Preprint (arXiv, bioRxiv, etc.)</option>
                            <option value="report">Report</option>
                            <option value="website">Website/Blog</option>
                        </select>
                    </div>

                    <!-- Journal-specific fields -->
                    <div id="journal-fields" style="display: none;">
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; font-weight: 500; margin-bottom: 5px; color: #2d2d2d;">Journal Name *</label>
                            <input type="text" id="journal" name="journal" placeholder="Journal of Educational Research" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-family: 'Montserrat', sans-serif;">
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 15px;">
                            <div>
                                <label style="display: block; font-weight: 500; margin-bottom: 5px; color: #2d2d2d;">Volume</label>
                                <input type="text" id="volume" name="volume" placeholder="12" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-family: 'Montserrat', sans-serif;">
                            </div>
                            <div>
                                <label style="display: block; font-weight: 500; margin-bottom: 5px; color: #2d2d2d;">Issue</label>
                                <input type="text" id="issue" name="issue" placeholder="3" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-family: 'Montserrat', sans-serif;">
                            </div>
                            <div>
                                <label style="display: block; font-weight: 500; margin-bottom: 5px; color: #2d2d2d;">Pages</label>
                                <input type="text" id="pages" name="pages" placeholder="123-145" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-family: 'Montserrat', sans-serif;">
                            </div>
                        </div>
                    </div>

                    <!-- Book-specific fields -->
                    <div id="book-fields" style="display: none;">
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; font-weight: 500; margin-bottom: 5px; color: #2d2d2d;">Publisher *</label>
                            <input type="text" id="publisher" name="publisher" placeholder="Academic Press" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-family: 'Montserrat', sans-serif;">
                        </div>
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; font-weight: 500; margin-bottom: 5px; color: #2d2d2d;">Location</label>
                            <input type="text" id="location" name="location" placeholder="New York, NY" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-family: 'Montserrat', sans-serif;">
                        </div>
                    </div>

                    <!-- Chapter-specific fields -->
                    <div id="chapter-fields" style="display: none;">
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; font-weight: 500; margin-bottom: 5px; color: #2d2d2d;">Book Title *</label>
                            <input type="text" id="book-title" name="bookTitle" placeholder="Title of the book" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-family: 'Montserrat', sans-serif;">
                        </div>
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; font-weight: 500; margin-bottom: 5px; color: #2d2d2d;">Editors</label>
                            <input type="text" id="editors" name="editors" placeholder="A. Editor &amp; B. Editor (Eds.)" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-family: 'Montserrat', sans-serif;">
                        </div>
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; font-weight: 500; margin-bottom: 5px; color: #2d2d2d;">Publisher *</label>
                            <input type="text" id="chapter-publisher" name="chapterPublisher" placeholder="Academic Press" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-family: 'Montserrat', sans-serif;">
                        </div>
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; font-weight: 500; margin-bottom: 5px; color: #2d2d2d;">Pages</label>
                            <input type="text" id="chapter-pages" name="chapterPages" placeholder="pp. 45-67" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-family: 'Montserrat', sans-serif;">
                        </div>
                    </div>

                    <!-- URL field (optional for most, required for website) -->
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; font-weight: 500; margin-bottom: 5px; color: #2d2d2d;">URL <span id="url-required" style="display: none;">(required)</span></label>
                        <input type="url" id="url" name="url" placeholder="https://..." style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-family: 'Montserrat', sans-serif;">
                    </div>

                        <div style="margin-bottom: 15px;">
                            <label style="display: block; font-weight: 500; margin-bottom: 5px; color: #2d2d2d;">DOI (if available)</label>
                            <input type="text" id="doi" name="doi" placeholder="10.1000/xyz123" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-family: 'Montserrat', sans-serif;">
                        </div>
                    </div>
                    <!-- End of manual-bibliography-fields -->
                </div>

                <!-- Step 3: Summary (for non-EdTech entries) -->
                <div id="step-summary" class="contribution-step" style="display: none;">
                    <h3 style="color: #2d2d2d; margin-bottom: 15px;">Your Summary &amp; Commentary</h3>

                    <div style="margin-bottom: 20px;">
                        <label style="display: block; font-weight: 500; margin-bottom: 5px; color: #2d2d2d;">Summary &amp; Commentary *</label>
                        <textarea id="summary" name="summary" required="" placeholder="Summarize the key findings, arguments, or content of this work, and share your thoughts, critique, or how this relates to your work..." rows="12" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-family: 'Montserrat', sans-serif; resize: vertical;"></textarea>
                        <small style="color: #666;">Minimum 100 characters. Include both a summary of the work and your response/commentary.</small>
                    </div>
                </div>

                <!-- Step 2: EdTech Product Identification (for Innovating EdTech only) -->
                <div id="step-edtech-product" class="contribution-step" style="display: none;">
                    <h3 style="color: #2d2d2d; margin-bottom: 15px;">EdTech Product Information</h3>

                    <div style="margin-bottom: 20px;">
                        <label style="display: block; font-weight: 500; margin-bottom: 5px; color: #2d2d2d;">Product/EdTech Name *</label>
                        <input type="text" id="edtech-product-name" placeholder="e.g., ChatGPT, Grammarly, Duolingo" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-family: 'Montserrat', sans-serif;">
                    </div>

                    <div style="margin-bottom: 20px;">
                        <label style="display: block; font-weight: 500; margin-bottom: 10px; color: #2d2d2d;">Product URL (optional)</label>
                        <input type="url" id="edtech-product-url" placeholder="https://..." style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-family: 'Montserrat', sans-serif;">
                    </div>

                    <div style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #57068c;">
                        <label style="display: block; font-weight: 500; margin-bottom: 10px; color: #2d2d2d;">
                            <i class="fas fa-tags"></i> Select up to 3 product categories *
                        </label>
                        <small style="color: #666; display: block; margin-bottom: 15px;">Choose the categories that best describe this EdTech product</small>
                        <div id="edtech-categories-checklist" style="display: grid; grid-template-columns: 1fr; gap: 8px;">
                            <!-- Categories will be populated here -->
                        </div>
                        <div id="category-limit-warning" style="display: none; margin-top: 10px; padding: 10px; background: #fff3cd; border-left: 4px solid #ffc107; color: #856404; border-radius: 4px;">
                            <i class="fas fa-exclamation-triangle"></i> Maximum 3 categories allowed
                        </div>
                    </div>
                </div>

                <!-- Step 3: EdTech Product Analysis (for Innovating EdTech only) -->
                <div id="step-edtech-analysis" class="contribution-step" style="display: none;">
                    <h3 style="color: #2d2d2d; margin-bottom: 15px;">Product Analysis</h3>

                    <div style="margin-bottom: 20px;">
                        <label style="display: block; font-weight: 500; margin-bottom: 5px; color: #2d2d2d;">Target Consumers *</label>
                        <input type="text" id="edtech-target-consumers" placeholder="e.g., K-12 Teachers, University Students, Administrators" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-family: 'Montserrat', sans-serif;">
                        <small style="color: #666;">Who is this product designed for?</small>
                    </div>

                    <div style="margin-bottom: 20px;">
                        <label style="display: block; font-weight: 500; margin-bottom: 5px; color: #2d2d2d;">Pain Point / Challenge Addressed *</label>
                        <textarea id="edtech-pain-point" rows="4" placeholder="What specific problem or challenge does this product attempt to solve?" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-family: 'Montserrat', sans-serif; resize: vertical;"></textarea>
                    </div>

                    <div style="margin-bottom: 20px;">
                        <label style="display: block; font-weight: 500; margin-bottom: 5px; color: #2d2d2d;">Nearest Competitors</label>
                        <input type="text" id="edtech-competitors" placeholder="e.g., Product A, Product B, Product C" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-family: 'Montserrat', sans-serif;">
                        <small style="color: #666;">List similar products or alternatives</small>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                        <div>
                            <label style="display: block; font-weight: 500; margin-bottom: 5px; color: #2d2d2d;">Business Model *</label>
                            <select id="edtech-business-model" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-family: 'Montserrat', sans-serif;">
                                <option value="">-- Select --</option>
                                <option value="B2B">B2B (Business to Business)</option>
                                <option value="B2C">B2C (Business to Consumer)</option>
                                <option value="C2C">C2C (Consumer to Consumer)</option>
                                <option value="B2B2C">B2B2C (Business to Business to Consumer)</option>
                                <option value="B2G">B2G (Business to Government)</option>
                            </select>
                        </div>

                        <div>
                            <label style="display: block; font-weight: 500; margin-bottom: 5px; color: #2d2d2d;">Economic Model *</label>
                            <select id="edtech-economic-model" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-family: 'Montserrat', sans-serif;">
                                <option value="">-- Select --</option>
                                <option value="subscription">Subscription</option>
                                <option value="freemium">Freemium</option>
                                <option value="retail">Retail/One-time Purchase</option>
                                <option value="usage-based">Usage-based/Pay-per-use</option>
                                <option value="ad-supported">Ad-supported</option>
                                <option value="enterprise-license">Enterprise License</option>
                                <option value="free">Free/Open Source</option>
                            </select>
                        </div>
                    </div>

                    <div style="margin-bottom: 20px;">
                        <label style="display: block; font-weight: 500; margin-bottom: 5px; color: #2d2d2d;">Key Differentiators *</label>
                        <textarea id="edtech-differentiators" rows="4" placeholder="What makes this product different from competitors?" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-family: 'Montserrat', sans-serif; resize: vertical;"></textarea>
                    </div>

                    <div style="margin-bottom: 20px;">
                        <label style="display: block; font-weight: 500; margin-bottom: 5px; color: #2d2d2d;">Affordances *</label>
                        <textarea id="edtech-affordances" rows="4" placeholder="What capabilities and opportunities does this product enable?" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-family: 'Montserrat', sans-serif; resize: vertical;"></textarea>
                    </div>

                    <div style="margin-bottom: 20px;">
                        <label style="display: block; font-weight: 500; margin-bottom: 5px; color: #2d2d2d;">Limitations *</label>
                        <textarea id="edtech-limitations" rows="4" placeholder="What are the known limitations or drawbacks of this product?" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-family: 'Montserrat', sans-serif; resize: vertical;"></textarea>
                    </div>
                </div>

                <!-- Navigation & Submit -->
                <div style="display: flex; justify-content: space-between; align-items: center; gap: 10px; padding-top: 20px; border-top: 1px solid #ddd;">
                    <button type="button" id="back-btn" onclick="goBackStep()" style="display: none; padding: 10px 20px; background: white; border: 2px solid #57068c; color: #57068c; border-radius: 4px; cursor: pointer; font-family: 'Montserrat', sans-serif;">
                        â† Back
                    </button>
                    <div style="flex: 1;"></div>
                    <button type="button" id="save-draft-btn" onclick="saveContributionDraft()" style="display: none; padding: 10px 20px; background: white; border: 2px solid #57068c; color: #57068c; border-radius: 4px; cursor: pointer; font-family: 'Montserrat', sans-serif;">
                        <i class="fas fa-save"></i> Save Draft
                    </button>
                    <button type="button" id="next-btn" onclick="goNextStep()" style="display: none; padding: 10px 20px; background: #57068c; color: white; border: none; border-radius: 4px; cursor: pointer; font-family: 'Montserrat', sans-serif;">
                        Next â†’
                    </button>
                    <button type="submit" id="submit-btn" style="display: none; padding: 10px 30px; background: #57068c; color: white; border: none; border-radius: 4px; cursor: pointer; font-family: 'Montserrat', sans-serif; font-weight: 600;">
                        Submit Entry
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Contribution Modal -->
    <div class="popup" id="edit-contribution-modal" style="display: none;">
        <div class="popup-content" style="max-width: 800px; max-height: 90vh; overflow-y: auto;">
            <span class="close-btn" onclick="closeEditContribution()">Ã—</span>
            <h2 style="color: #57068c; margin-bottom: 20px;">Edit Research Entry</h2>

            <form id="edit-contribution-form" onsubmit="saveEditedContribution(event)" style="display: grid; gap: 20px;" novalidate>
                <input type="hidden" id="edit-contribution-id">

                <!-- Topic & Subtopic Selection -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div>
                        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #2d2d2d;">Primary Topic</label>
                        <select id="edit-topic" required="" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-family: 'Montserrat', sans-serif;" onchange="updateEditSubtopicOptions()">
                            <option value="">Select Topic</option>
                            <option value="evaluating-tools">Evaluating Tools</option>
                            <option value="understanding-users">Understanding Users</option>
                            <option value="assessing-impacts">Assessing Impacts</option>
                            <option value="innovating-edtech">Innovating EdTech</option>
                            <option value="learning-science">Learning Science</option>
                            <option value="research-methods">Research Methods</option>
                        </select>
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #2d2d2d;">Primary Subtopic</label>
                        <select id="edit-subtopic" required="" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-family: 'Montserrat', sans-serif;">
                            <option value="">Select Subtopic</option>
                        </select>
                    </div>
                </div>

                <!-- Secondary Categories -->
                <div style="padding: 15px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #57068c;">
                    <h4 style="margin: 0 0 10px 0; color: #57068c; font-size: 0.95rem;">
                        <i class="fas fa-info-circle"></i> Secondary Categories (Optional)
                    </h4>
                    <p style="margin: 0 0 15px 0; color: #666; font-size: 0.9rem;">
                        Add up to 2 additional categories if this source is relevant to multiple topics.
                    </p>
                    <div id="edit-secondary-categories-container">
                        <!-- Secondary categories will be added here -->
                    </div>
                    <button type="button" id="edit-add-secondary-category-btn" onclick="addEditSecondaryCategory()"
                            style="padding: 8px 16px; background: white; border: 2px dashed #57068c; color: #57068c; border-radius: 4px; cursor: pointer; font-family: 'Montserrat', sans-serif; font-weight: 600; font-size: 0.9rem;">
                        <i class="fas fa-plus"></i> Add Secondary Category
                    </button>
                </div>

                <!-- Bibliography Fields (for regular research entries) -->
                <div id="edit-bibliography-fields">

                <!-- DOI Auto-fill Section for Edit Modal -->
                <div id="edit-doi-autofill-section" style="margin-bottom: 20px; padding: 20px; background: linear-gradient(135deg, #f8f0ff 0%, #fff 100%); border: 2px solid #57068c; border-radius: 8px;">
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                        <i class="fas fa-magic" style="color: #57068c; font-size: 1.2rem;"></i>
                        <h4 style="margin: 0; color: #57068c; font-size: 1rem;">Auto-fill from DOI</h4>
                    </div>
                    <p style="margin: 0 0 15px 0; color: #666; font-size: 0.9rem;">
                        Have a DOI? Enter it below to automatically update all bibliographic details.
                    </p>
                    <div style="display: flex; gap: 10px; align-items: flex-start;">
                        <div style="flex: 1;">
                            <input type="text" id="edit-doi-autofill-input" placeholder="e.g., 10.1007/s40593-020-00216-z or https://doi.org/10.1007/..."
                                   onkeypress="if(event.key === 'Enter') { event.preventDefault(); fetchFromDOIEdit(); }"
                                   style="width: 100%; padding: 12px; border: 2px solid #57068c; border-radius: 4px; font-family: 'Montserrat', sans-serif; font-size: 0.95rem;">
                            <small style="color: #666; display: block; margin-top: 5px;">
                                Enter the DOI or paste a DOI URL (press Enter or click Fetch)
                            </small>
                        </div>
                        <button type="button" onclick="fetchFromDOIEdit()" id="edit-fetch-doi-btn"
                                style="padding: 12px 24px; background: #57068c; color: white; border: none; border-radius: 4px; cursor: pointer; font-family: 'Montserrat', sans-serif; font-weight: 600; white-space: nowrap; height: 48px;">
                            <i class="fas fa-search"></i> Fetch
                        </button>
                    </div>
                    <div id="edit-doi-loading" style="display: none; margin-top: 15px; padding: 12px; background: white; border-radius: 4px; border-left: 4px solid #57068c;">
                        <i class="fas fa-spinner fa-spin"></i> Fetching citation data...
                    </div>
                    <div id="edit-doi-success" style="display: none; margin-top: 15px; padding: 12px; background: #d4edda; border-radius: 4px; border-left: 4px solid #28a745; color: #155724;">
                        <i class="fas fa-check-circle"></i> Successfully loaded! Review and save changes.
                    </div>
                    <div id="edit-doi-error" style="display: none; margin-top: 15px; padding: 12px; background: #f8d7da; border-radius: 4px; border-left: 4px solid #dc3545; color: #721c24;">
                        <i class="fas fa-exclamation-triangle"></i> <span id="edit-doi-error-message">Could not fetch data.</span>
                    </div>
                </div>

                <div>
                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #2d2d2d;">Title</label>
                    <input type="text" id="edit-bib-title" required="" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-family: 'Montserrat', sans-serif;">
                </div>

                <div>
                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #2d2d2d;">Author(s)</label>
                    <input type="text" id="edit-bib-authors" required="" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-family: 'Montserrat', sans-serif;">
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div>
                        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #2d2d2d;">Year</label>
                        <input type="text" id="edit-bib-year" required="" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-family: 'Montserrat', sans-serif;">
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #2d2d2d;">URL</label>
                        <input type="url" id="edit-bib-url" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-family: 'Montserrat', sans-serif;">
                    </div>
                </div>

                <div>
                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #2d2d2d;">Publication Type</label>
                    <select id="edit-bib-pubtype" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-family: 'Montserrat', sans-serif;" onchange="updateEditPubTypeFields()">
                        <option value="journal">Journal Article</option>
                        <option value="book">Book</option>
                        <option value="chapter">Book Chapter</option>
                        <option value="conference">Conference Paper</option>
                        <option value="preprint">Preprint (arXiv, bioRxiv, etc.)</option>
                        <option value="report">Report</option>
                        <option value="website">Website/Blog</option>
                        <option value="other">Other</option>
                    </select>
                </div>

                <!-- Journal Fields -->
                <div id="edit-journal-fields" style="display: grid; gap: 15px;">
                    <div>
                        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #2d2d2d;">Journal Name</label>
                        <input type="text" id="edit-bib-journal" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-family: 'Montserrat', sans-serif;">
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px;">
                        <div>
                            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #2d2d2d;">Volume</label>
                            <input type="text" id="edit-bib-volume" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-family: 'Montserrat', sans-serif;">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #2d2d2d;">Issue</label>
                            <input type="text" id="edit-bib-issue" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-family: 'Montserrat', sans-serif;">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #2d2d2d;">Pages</label>
                            <input type="text" id="edit-bib-pages" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-family: 'Montserrat', sans-serif;">
                        </div>
                    </div>
                </div>

                <!-- Book Fields -->
                <div id="edit-book-fields" style="display: none; gap: 15px;">
                    <div>
                        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #2d2d2d;">Publisher</label>
                        <input type="text" id="edit-bib-publisher" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-family: 'Montserrat', sans-serif;">
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #2d2d2d;">Location</label>
                        <input type="text" id="edit-bib-location" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-family: 'Montserrat', sans-serif;">
                    </div>
                </div>

                <!-- Summary -->
                <div id="edit-summary-field">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #2d2d2d;">Summary/Annotation</label>
                    <textarea id="edit-summary" required="" rows="6" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-family: 'Montserrat', sans-serif; resize: vertical;"></textarea>
                </div>

                <!-- Tags -->
                <div>
                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #2d2d2d;">Tags (comma-separated)</label>
                    <input type="text" id="edit-tags" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-family: 'Montserrat', sans-serif;">
                </div>

                </div>
                <!-- End Bibliography Fields -->

                <!-- EdTech Product Fields (for edtech product entries) -->
                <div id="edit-edtech-fields" style="display: none;">
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; font-weight: 500; margin-bottom: 5px; color: #2d2d2d;">Product/EdTech Name *</label>
                        <input type="text" id="edit-edtech-product-name" placeholder="e.g., ChatGPT, Grammarly, Duolingo" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-family: 'Montserrat', sans-serif;">
                    </div>

                    <div style="margin-bottom: 20px;">
                        <label style="display: block; font-weight: 500; margin-bottom: 10px; color: #2d2d2d;">Product URL (optional)</label>
                        <input type="url" id="edit-edtech-product-url" placeholder="https://..." style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-family: 'Montserrat', sans-serif;">
                    </div>

                    <div style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #57068c;">
                        <label style="display: block; font-weight: 500; margin-bottom: 10px; color: #2d2d2d;">
                            <i class="fas fa-tags"></i> Select up to 3 product categories *
                        </label>
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px;">
                            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                <input type="checkbox" class="edit-edtech-category-checkbox" value="text-generation" style="cursor: pointer;">
                                <span>Text Generation</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                <input type="checkbox" class="edit-edtech-category-checkbox" value="image-generation" style="cursor: pointer;">
                                <span>Image Generation</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                <input type="checkbox" class="edit-edtech-category-checkbox" value="video-generation" style="cursor: pointer;">
                                <span>Video Generation</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                <input type="checkbox" class="edit-edtech-category-checkbox" value="ai-tutoring" style="cursor: pointer;">
                                <span>AI Tutoring and Learning Support</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                <input type="checkbox" class="edit-edtech-category-checkbox" value="detection" style="cursor: pointer;">
                                <span>Detection and Academic Integrity</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                <input type="checkbox" class="edit-edtech-category-checkbox" value="organization" style="cursor: pointer;">
                                <span>Organization and Productivity</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                <input type="checkbox" class="edit-edtech-category-checkbox" value="feedback" style="cursor: pointer;">
                                <span>Feedback and Assessment</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                <input type="checkbox" class="edit-edtech-category-checkbox" value="accessibility" style="cursor: pointer;">
                                <span>Accessibility and Inclusion</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                <input type="checkbox" class="edit-edtech-category-checkbox" value="classroom-management" style="cursor: pointer;">
                                <span>Classroom Management</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                <input type="checkbox" class="edit-edtech-category-checkbox" value="classroom-analytics" style="cursor: pointer;">
                                <span>Classroom Learning and Analytics</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                <input type="checkbox" class="edit-edtech-category-checkbox" value="scheduling" style="cursor: pointer;">
                                <span>Scheduling</span>
                            </label>
                        </div>
                    </div>

                    <div style="margin-bottom: 20px;">
                        <label style="display: block; font-weight: 500; margin-bottom: 5px; color: #2d2d2d;">Target Consumers *</label>
                        <textarea id="edit-edtech-target-consumers" placeholder="Who is this product designed for?" rows="3" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-family: 'Montserrat', sans-serif; resize: vertical;"></textarea>
                    </div>

                    <div style="margin-bottom: 20px;">
                        <label style="display: block; font-weight: 500; margin-bottom: 5px; color: #2d2d2d;">Pain Point *</label>
                        <textarea id="edit-edtech-pain-point" placeholder="What problem does this product solve?" rows="3" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-family: 'Montserrat', sans-serif; resize: vertical;"></textarea>
                    </div>

                    <div style="margin-bottom: 20px;">
                        <label style="display: block; font-weight: 500; margin-bottom: 5px; color: #2d2d2d;">Competitors (optional)</label>
                        <input type="text" id="edit-edtech-competitors" placeholder="Similar products or competitors" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-family: 'Montserrat', sans-serif;">
                    </div>

                    <div style="margin-bottom: 20px;">
                        <label style="display: block; font-weight: 500; margin-bottom: 5px; color: #2d2d2d;">Business Model *</label>
                        <select id="edit-edtech-business-model" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-family: 'Montserrat', sans-serif;">
                            <option value="">Select business model</option>
                            <option value="B2C">B2C (Business to Consumer)</option>
                            <option value="B2B">B2B (Business to Business)</option>
                            <option value="B2B2C">B2B2C (Business to Business to Consumer)</option>
                            <option value="B2G">B2G (Business to Government)</option>
                        </select>
                    </div>

                    <div style="margin-bottom: 20px;">
                        <label style="display: block; font-weight: 500; margin-bottom: 5px; color: #2d2d2d;">Economic Model *</label>
                        <select id="edit-edtech-economic-model" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-family: 'Montserrat', sans-serif;">
                            <option value="">Select economic model</option>
                            <option value="Freemium">Freemium</option>
                            <option value="Subscription">Subscription</option>
                            <option value="One-time purchase">One-time purchase</option>
                            <option value="Free (ad-supported)">Free (ad-supported)</option>
                            <option value="Free (open source)">Free (open source)</option>
                            <option value="Enterprise licensing">Enterprise licensing</option>
                        </select>
                    </div>

                    <div style="margin-bottom: 20px;">
                        <label style="display: block; font-weight: 500; margin-bottom: 5px; color: #2d2d2d;">Key Differentiators *</label>
                        <textarea id="edit-edtech-differentiators" placeholder="What makes this product unique or different from competitors?" rows="3" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-family: 'Montserrat', sans-serif; resize: vertical;"></textarea>
                    </div>

                    <div style="margin-bottom: 20px;">
                        <label style="display: block; font-weight: 500; margin-bottom: 5px; color: #2d2d2d;">Affordances *</label>
                        <textarea id="edit-edtech-affordances" placeholder="What capabilities or features does this product enable?" rows="3" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-family: 'Montserrat', sans-serif; resize: vertical;"></textarea>
                    </div>

                    <div style="margin-bottom: 20px;">
                        <label style="display: block; font-weight: 500; margin-bottom: 5px; color: #2d2d2d;">Limitations *</label>
                        <textarea id="edit-edtech-limitations" placeholder="What are the constraints, drawbacks, or areas for improvement?" rows="3" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-family: 'Montserrat', sans-serif; resize: vertical;"></textarea>
                    </div>
                </div>

                <!-- Contributor -->
                <div>
                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #2d2d2d;">Contributor</label>
                    <select id="edit-contributor" required style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-family: 'Montserrat', sans-serif;">
                        <option value="">Select Contributor</option>
                    </select>
                    <small style="color: #666; margin-top: 4px; display: block;">Select the contributor who created this annotation</small>
                </div>

                <!-- Buttons -->
                <div style="display: flex; gap: 10px; justify-content: space-between;">
                    <button type="button" onclick="deleteContributionFromModal()" style="padding: 10px 30px; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer; font-family: 'Montserrat', sans-serif; font-weight: 600;">
                        <i class="fas fa-trash"></i> Delete
                    </button>
                    <div style="display: flex; gap: 10px;">
                        <button type="button" onclick="closeEditContribution()" style="padding: 10px 30px; background: #666; color: white; border: none; border-radius: 4px; cursor: pointer; font-family: 'Montserrat', sans-serif; font-weight: 600;">
                            Cancel
                        </button>
                        <button type="submit" style="padding: 10px 30px; background: #57068c; color: white; border: none; border-radius: 4px; cursor: pointer; font-family: 'Montserrat', sans-serif; font-weight: 600;">
                            Save Changes
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Perspective Modal -->
    <div class="popup" id="add-perspective-modal" style="display: none;">
        <div class="popup-content" style="max-width: 600px; max-height: 90vh; overflow-y: auto;">
            <span class="close-btn" onclick="closeAddPerspective()">Ã—</span>
            <h2 style="color: #57068c; margin-bottom: 10px;">Add Your Perspective</h2>
            <p style="color: #666; margin-bottom: 20px; font-size: 0.95rem;">
                Share your thoughts, insights, or questions about this source.
            </p>

            <form id="add-perspective-form" onsubmit="submitPerspective(event)" style="display: grid; gap: 20px;">
                <input type="hidden" id="perspective-entry-id">

                <!-- Admin: Add perspective on behalf of team member -->
                <div id="admin-perspective-selector" style="display: none; padding: 15px; background: #f0f7ff; border-left: 4px solid #57068c; border-radius: 4px;">
                    <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #2d2d2d; font-size: 0.9rem;">
                        <i class="fas fa-user-shield"></i> Adding perspective as Admin on behalf of:
                    </label>
                    <div style="position: relative;">
                        <select id="perspective-behalf-of-user" onchange="updatePerspectivePreview()" style="width: 100%; padding: 10px 10px 10px 50px; border: 1px solid #ddd; border-radius: 4px; font-family: 'Montserrat', sans-serif; font-size: 0.9rem;">
                            <option value="">-- Select team member --</option>
                        </select>
                        <img id="perspective-preview-img" src="" style="display: none; position: absolute; left: 10px; top: 50%; transform: translateY(-50%); width: 32px; height: 32px; border-radius: 50%; object-fit: cover; border: 2px solid #57068c;">
                    </div>
                    <small style="color: #666; display: block; margin-top: 5px;">Leave blank to add perspective under your own name</small>
                </div>

                <!-- Source Info (Read-only display) -->
                <div style="padding: 15px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #57068c;">
                    <h4 style="margin: 0 0 5px 0; color: #2d2d2d; font-size: 0.9rem;">Source</h4>
                    <p id="perspective-source-info" style="margin: 0; color: #666; font-size: 0.85rem; line-height: 1.5;"></p>
                </div>

                <!-- Perspective Text -->
                <div>
                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #2d2d2d;">
                        Your Perspective <span style="color: #dc3545;">*</span>
                    </label>
                    <textarea id="perspective-text" required
                              rows="6"
                              placeholder="Share your analysis, critique, questions, or how this source relates to your experience..."
                              style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 4px; font-family: 'Montserrat', sans-serif; font-size: 0.95rem; resize: vertical;"></textarea>
                    <small style="color: #666; display: block; margin-top: 5px;">
                        Minimum 50 characters.
                    </small>
                </div>

                <!-- Buttons -->
                <div style="display: flex; gap: 10px; justify-content: flex-end;">
                    <button type="button" onclick="closeAddPerspective()"
                            style="padding: 10px 20px; background: #666; color: white; border: none; border-radius: 4px; cursor: pointer; font-family: 'Montserrat', sans-serif; font-weight: 600;">
                        Cancel
                    </button>
                    <button type="button" onclick="savePerspectiveDraft(event)"
                            style="padding: 10px 20px; background: white; border: 2px solid #57068c; color: #57068c; border-radius: 4px; cursor: pointer; font-family: 'Montserrat', sans-serif; font-weight: 600;">
                        <i class="fas fa-save"></i> Save Draft
                    </button>
                    <button type="submit" id="submit-perspective-btn"
                            style="padding: 10px 30px; background: #57068c; color: white; border: none; border-radius: 4px; cursor: pointer; font-family: 'Montserrat', sans-serif; font-weight: 600;">
                        <i class="fas fa-comment"></i> Add Perspective
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Duplicate Detection Modal -->
    <div class="popup" id="duplicate-detection-modal" style="display: none;">
        <div class="popup-content" style="max-width: 700px; max-height: 90vh; overflow-y: auto;">
            <span class="close-btn" onclick="closeDuplicateDetection()">Ã—</span>
            <h2 style="color: #ff9800; margin-bottom: 10px;">
                <i class="fas fa-exclamation-triangle"></i> Possible Duplicate Detected
            </h2>
            <p style="color: #666; margin-bottom: 20px; font-size: 0.95rem;">
                We found an existing entry that appears very similar to yours. Is this the same source?
            </p>

            <!-- Existing Entry Display -->
            <div style="padding: 20px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #ff9800; margin-bottom: 20px;">
                <h4 style="margin: 0 0 10px 0; color: #2d2d2d; font-size: 1rem;">Existing Entry:</h4>
                <div id="duplicate-existing-citation" style="margin-bottom: 15px; color: #333; font-size: 0.9rem; line-height: 1.6;"></div>
                <div style="border-top: 1px solid #ddd; padding-top: 15px; margin-top: 15px;">
                    <strong style="color: #57068c; display: block; margin-bottom: 8px;">Summary:</strong>
                    <div id="duplicate-existing-summary" style="color: #555; font-size: 0.85rem; line-height: 1.5; font-style: italic;"></div>
                </div>
                <div style="margin-top: 10px; font-size: 0.8rem; color: #666;">
                    <strong>Location:</strong> <span id="duplicate-existing-location"></span>
                </div>
            </div>

            <!-- Your Entry Display -->
            <div style="padding: 20px; background: #e3f2fd; border-radius: 8px; border-left: 4px solid #57068c; margin-bottom: 25px;">
                <h4 style="margin: 0 0 10px 0; color: #2d2d2d; font-size: 1rem;">Your Entry:</h4>
                <div id="duplicate-your-citation" style="margin-bottom: 15px; color: #333; font-size: 0.9rem; line-height: 1.6;"></div>
                <div style="border-top: 1px solid #ccc; padding-top: 15px; margin-top: 15px;">
                    <strong style="color: #57068c; display: block; margin-bottom: 8px;">Your Summary:</strong>
                    <div id="duplicate-your-summary" style="color: #555; font-size: 0.85rem; line-height: 1.5; font-style: italic;"></div>
                </div>
            </div>

            <!-- Decision Buttons -->
            <div style="display: flex; gap: 15px; justify-content: center;">
                <button onclick="confirmDuplicate()"
                        style="padding: 15px 30px; background: #57068c; color: white; border: none; border-radius: 4px; cursor: pointer; font-family: 'Montserrat', sans-serif; font-weight: 600; font-size: 1rem; flex: 1;">
                    <i class="fas fa-check-circle"></i> Yes, Add My Perspective
                </button>
                <button onclick="rejectDuplicate()"
                        style="padding: 15px 30px; background: #666; color: white; border: none; border-radius: 4px; cursor: pointer; font-family: 'Montserrat', sans-serif; font-weight: 600; font-size: 1rem; flex: 1;">
                    <i class="fas fa-times-circle"></i> No, Different Source
                </button>
            </div>

            <!-- Hidden data -->
            <input type="hidden" id="duplicate-existing-id">
            <input type="hidden" id="duplicate-form-data">
        </div>
    </div>

    <!-- Edit Perspective Modal (Admin only) -->
    <div class="popup" id="edit-perspective-modal" style="display: none;">
        <div class="popup-content" style="max-width: 600px; max-height: 90vh; overflow-y: auto;">
            <span class="close-btn" onclick="closeEditPerspective()">Ã—</span>
            <h2 style="color: #57068c; margin-bottom: 10px;">Edit Perspective</h2>
            <p style="color: #666; margin-bottom: 20px; font-size: 0.95rem;">
                Update the perspective text below.
            </p>

            <form id="edit-perspective-form" onsubmit="submitEditPerspective(event)" style="display: grid; gap: 20px;">
                <input type="hidden" id="edit-perspective-entry-id">
                <input type="hidden" id="edit-perspective-original-data">

                <!-- Source Info (Read-only display) -->
                <div style="padding: 15px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #57068c;">
                    <h4 style="margin: 0 0 5px 0; color: #2d2d2d; font-size: 0.9rem;">Source</h4>
                    <p id="edit-perspective-source-info" style="margin: 0; color: #666; font-size: 0.85rem; line-height: 1.5;"></p>
                </div>

                <!-- Perspective Text -->
                <div>
                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #2d2d2d;">
                        Perspective Text <span style="color: #dc3545;">*</span>
                    </label>
                    <textarea id="edit-perspective-text" required
                              rows="6"
                              placeholder="Edit the perspective text..."
                              style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 4px; font-family: 'Montserrat', sans-serif; font-size: 0.95rem; resize: vertical;"></textarea>
                    <small style="color: #666; display: block; margin-top: 5px;">
                        Minimum 50 characters.
                    </small>
                </div>

                <!-- Buttons -->
                <div style="display: flex; gap: 10px; justify-content: flex-end;">
                    <button type="button" onclick="closeEditPerspective()"
                            style="padding: 10px 20px; background: #666; color: white; border: none; border-radius: 4px; cursor: pointer; font-family: 'Montserrat', sans-serif; font-weight: 600;">
                        Cancel
                    </button>
                    <button type="submit" id="submit-edit-perspective-btn"
                            style="padding: 10px 30px; background: #57068c; color: white; border: none; border-radius: 4px; cursor: pointer; font-family: 'Montserrat', sans-serif; font-weight: 600;">
                        <i class="fas fa-save"></i> Save Changes
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- My Drafts Modal -->
    <div class="popup" id="my-drafts-modal" style="display: none;">
        <div class="popup-content" style="max-width: 900px; max-height: 90vh; overflow-y: auto;">
            <span class="close-btn" onclick="closeMyDrafts()">Ã—</span>
            <h2 style="color: #57068c; margin-bottom: 10px;">
                <i class="fas fa-file-alt"></i> My Drafts
            </h2>
            <p style="color: #666; margin-bottom: 20px; font-size: 0.95rem;">
                Manage your saved drafts for contributions and perspectives.
            </p>

            <!-- Tabs for Contributions and Perspectives -->
            <div style="display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 2px solid #e0e0e0;">
                <button id="drafts-contributions-tab" onclick="switchDraftsTab('contributions')"
                        style="padding: 10px 20px; background: none; border: none; border-bottom: 3px solid #57068c; color: #57068c; cursor: pointer; font-family: 'Montserrat', sans-serif; font-weight: 600;">
                    <i class="fas fa-plus-circle"></i> Contributions
                </button>
                <button id="drafts-perspectives-tab" onclick="switchDraftsTab('perspectives')"
                        style="padding: 10px 20px; background: none; border: none; border-bottom: 3px solid transparent; color: #666; cursor: pointer; font-family: 'Montserrat', sans-serif; font-weight: 600;">
                    <i class="fas fa-comment"></i> Perspectives
                </button>
            </div>

            <!-- Loading State -->
            <div id="drafts-loading" style="display: none; text-align: center; padding: 40px; color: #666;">
                <i class="fas fa-spinner fa-spin" style="font-size: 2rem; margin-bottom: 10px;"></i>
                <p>Loading your drafts...</p>
            </div>

            <!-- Empty State -->
            <div id="drafts-empty" style="display: none; text-align: center; padding: 40px; color: #666;">
                <i class="fas fa-inbox" style="font-size: 3rem; margin-bottom: 15px; opacity: 0.5;"></i>
                <p style="font-size: 1.1rem; margin-bottom: 5px;">No drafts yet</p>
                <p style="font-size: 0.9rem;">Start a contribution or perspective and save it as a draft to see it here.</p>
            </div>

            <!-- Drafts List -->
            <div id="drafts-list" style="display: grid; gap: 15px;">
                <!-- Drafts will be populated here by JavaScript -->
            </div>
        </div>
    </div>

    <!-- Reading List Modal -->
    <div class="popup" id="reading-list-modal" style="display: none;">
        <div class="popup-content" style="max-width: 900px; max-height: 90vh; overflow-y: auto;">
            <span class="close-btn" onclick="closeReadingList()">Ã—</span>
            <h2 style="color: #57068c; margin-bottom: 20px;">
                <i class="fas fa-star"></i> My Reading List
            </h2>

            <div id="reading-list-content" style="min-height: 200px;">
                <div style="text-align: center; padding: 40px; color: #666;">
                    <i class="fas fa-spinner fa-spin" style="font-size: 2rem; margin-bottom: 10px;"></i>
                    <p>Loading your reading list...</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Utility: Levenshtein distance for fuzzy string matching
        function levenshteinDistance(str1, str2) {
            const s1 = str1.toLowerCase().trim();
            const s2 = str2.toLowerCase().trim();

            const len1 = s1.length;
            const len2 = s2.length;

            // Create a 2D array for dynamic programming
            const matrix = Array(len1 + 1).fill(null).map(() => Array(len2 + 1).fill(0));

            // Initialize first column and row
            for (let i = 0; i <= len1; i++) matrix[i][0] = i;
            for (let j = 0; j <= len2; j++) matrix[0][j] = j;

            // Fill in the rest of the matrix
            for (let i = 1; i <= len1; i++) {
                for (let j = 1; j <= len2; j++) {
                    const cost = s1[i - 1] === s2[j - 1] ? 0 : 1;
                    matrix[i][j] = Math.min(
                        matrix[i - 1][j] + 1,      // deletion
                        matrix[i][j - 1] + 1,      // insertion
                        matrix[i - 1][j - 1] + cost // substitution
                    );
                }
            }

            return matrix[len1][len2];
        }

        // Calculate similarity percentage (0-100, where 100 is identical)
        function calculateSimilarity(str1, str2) {
            const distance = levenshteinDistance(str1, str2);
            const maxLength = Math.max(str1.length, str2.length);
            if (maxLength === 0) return 100;
            return ((maxLength - distance) / maxLength) * 100;
        }

        // Check if two strings are similar based on threshold (default 85%)
        function isSimilar(str1, str2, threshold = 85) {
            return calculateSimilarity(str1, str2) >= threshold;
        }

        // All the JavaScript functionality from the original site, adapted for AI in Education
        function populateTeamMembersList() {
            // Use dynamic contributor API to get all contributors from DOM
            if (!window.contributorAPI) {
                console.warn('contributorAPI not yet loaded, retrying in 500ms...');
                setTimeout(populateTeamMembersList, 500);
                return;
            }

            // Get all contributors dynamically from the DOM
            const allContributors = window.contributorAPI.getAllContributors();

            // Create array of contributors with their counts
            const contributors = allContributors.map(contributor => ({
                id: contributor.id,
                name: contributor.name,
                count: contributor.count,
                perspectivesCount: contributor.perspectivesCount || 0,
                isFaculty: contributor.id === 'alexander-landfair'
            }));

            // Separate faculty and students, sort students by total contribution count
            const faculty = contributors.filter(c => c.isFaculty);
            const students = contributors.filter(c => !c.isFaculty)
                .sort((a, b) => {
                    const totalA = a.count + (a.perspectivesCount || 0);
                    const totalB = b.count + (b.perspectivesCount || 0);
                    return totalB - totalA; // Sort descending by total count
                });

            // Build the HTML
            const container = document.getElementById('team-members-list');
            if (!container) return;

            let html = '';

            // Faculty section
            html += '<h2 style="color: #57068c; margin-top: 30px; margin-bottom: 20px;">Faculty Advisor</h2>';
            html += '<ul style="list-style: none; padding-left: 0; line-height: 2;">';
            faculty.forEach(contributor => {
                const totalCount = contributor.count + (contributor.perspectivesCount || 0);
                html += `
                    <li style="padding: 8px 0; border-bottom: 1px solid #eee;">
                        <a href="#" onclick="showContributorPage('${contributor.id}'); return false;" style="color: #57068c; text-decoration: none;">
                            <strong>${contributor.name}</strong>
                        </a>
                        <span style="background-color: #e9ddf5; color: #57068c; padding: 2px 8px; border-radius: 10px; font-size: 0.85em; font-weight: 600; margin-left: 8px; display: inline-block; min-width: 24px; text-align: center;">
                            ${totalCount}
                        </span>
                        <span style="color: #666;"> - Faculty Advisor, NYU Expository Writing Program</span>
                    </li>
                `;
            });
            html += '</ul>';

            // Student section
            html += '<h2 style="color: #57068c; margin-top: 40px; margin-bottom: 20px;">Student Research Contributors</h2>';
            html += '<ul style="list-style: none; padding-left: 0; line-height: 2;">';
            students.forEach(contributor => {
                const totalCount = contributor.count + (contributor.perspectivesCount || 0);
                html += `
                    <li style="padding: 8px 0; border-bottom: 1px solid #eee;">
                        <a href="#" onclick="showContributorPage('${contributor.id}'); return false;" style="color: #333; text-decoration: none;">
                            ${contributor.name}
                        </a>
                        <span style="background-color: #e9ddf5; color: #57068c; padding: 2px 8px; border-radius: 10px; font-size: 0.85em; font-weight: 600; margin-left: 8px; display: inline-block; min-width: 24px; text-align: center;">
                            ${totalCount}
                        </span>
                    </li>
                `;
            });
            html += '</ul>';

            // Footer
            html += `
                <p style="margin-top: 30px; color: #666; font-style: italic;">
                    Interested in joining our team? Visit our <a href="https://engineering.nyu.edu/vip-team/ai-education-1" target="_blank" style="color: #57068c;">VIP program page</a> to learn about the application process.
                </p>
            `;

            container.innerHTML = html;
        }

        // Make populateTeamMembersList globally accessible
        window.populateTeamMembersList = populateTeamMembersList;

        // Make updateContentPlaceholders globally accessible
        window.updateContentPlaceholders = updateContentPlaceholders;

        document.addEventListener('DOMContentLoaded', function() {
            initializeNavigationState();
            initializeSearch();
            initializePathwayNavigation();
            initializePopupSystem();
            initializeAnnotations();
            initializeFilteringSystem();
            updateEntryCounter();
            populateTeamMembersList();
            updateContentPlaceholders();
            logDebugInfo();
            // Initialize entry counts on landing page
            setTimeout(updateTopicCardCounts, 500);
        });

        window.addEventListener('load', function() {
            updateEntryCounter();
            setupImprovedPathwayNavigation();
            initializeHeaderEffects();
            // Update counts after everything is fully loaded
            setTimeout(updateTopicCardCounts, 1000);
        });

        let navigationState = {
            currentView: 'landing',
            topicId: null,
            subtopicId: null,
            subsubtopicId: null,
            pathwayName: null,
            filterTag: null
        };

        const knownTopics = [
            'evaluating-tools',
            'understanding-users',
            'assessing-impacts',
            'innovating-edtech',
            'learning-science',
            'research-methods'
        ];

        const knownSubtopics = [
            // Evaluating Tools subtopics
            'coding',
            'creativity',
            'detection-tools',
            'ethics-safety',
            'equity-social-justice',
            'error-hallucination',
            'reasoning',
            'usability',
            'translation',

            // Understanding Users subtopics
            'general',
            'administrators',
            'students',
            'faculty',

            // Assessing Impacts subtopics
            'learning-outcomes',
            'academic-integrity',
            'assessment-validity',
            'student-wellbeing',
            'equity-access',

            // Innovating EdTech subtopics
            'ai-tutoring',
            'writing-content-generation',
            'detection-integrity',
            'organizational-productivity',
            'feedback-assessment',
            'accessibility-inclusion',
            'learning-analytics',
            'scheduling',

            // Learning Science subtopics
            'writing-composition',
            'cognitive-science',
            'reading-literacy',
            'educational-philosophy',
            'ai-ml-foundations',

            // Research Methods & Resources subtopics
            'literature-review',
            'collaborative-research',
            'experimental-design',
            'survey-design',
            'interview-focus-groups',
            'data-analysis',
            'research-ethics',
            'academic-writing',

            // Legacy subtopics (for backward compatibility)
            'student-attitudes',
            'faculty-perspectives',
            'administrator-views',
            'ai-competencies',
            'ai-detection',
            'genai-capabilities',
            'tool-limitations',
            'comparative-analysis',
            'prototype-development',
            'user-testing',
            'integration-strategies',
            'scalability-assessment'
        ];

        function parseURLAndNavigate() {
            const urlParams = new URLSearchParams(window.location.search);
            const topic = urlParams.get('topic');
            const subtopic = urlParams.get('subtopic');
            const contributor = urlParams.get('contributor');

            if (contributor) {
                // Show contributor page
                showContributorPage(contributor, true);
            } else if (subtopic && topic) {
                // Show subtopic page
                showSubtopicPage(topic, subtopic, true);
            } else if (topic) {
                // Show topic page
                showTopicPage(topic, true);
            } else {
                // Show landing page
                showLandingPage(true);
            }
        }

        function initializeNavigationState() {
            // Parse URL on initial load
            parseURLAndNavigate();

            // Handle browser back/forward buttons
            window.addEventListener('popstate', function(event) {
                if (event.state) {
                    // Navigate based on stored state
                    if (event.state.currentView === 'contributor') {
                        showContributorPage(event.state.contributorId, true);
                    } else if (event.state.currentView === 'subtopic') {
                        showSubtopicPage(event.state.topicId, event.state.subtopicId, true);
                    } else if (event.state.currentView === 'topic') {
                        showTopicPage(event.state.topicId, true);
                    } else {
                        showLandingPage(true);
                    }
                } else {
                    // If no state, parse URL
                    parseURLAndNavigate();
                }
            });
        }

        function initializeHeaderEffects() {
            const headerTitle = document.querySelector('.header-title');
            
            if (!headerTitle) return;
            
            const scrollThreshold = 150;
            
            function updateTitleVisibility() {
                const scrollPosition = window.scrollY || window.pageYOffset;
                
                if (scrollPosition >= scrollThreshold) {
                    headerTitle.classList.add('visible');
                } else {
                    headerTitle.classList.remove('visible');
                }
            }
            
            window.addEventListener('scroll', updateTitleVisibility);
            updateTitleVisibility();
        }

        function updateBreadcrumbs() {
            const breadcrumbs = document.querySelector('.breadcrumbs');
            if (!breadcrumbs) return;

            let breadcrumbsHTML = `<a href="${window.location.pathname}" data-nav="home">Home</a>`;

            switch (navigationState.currentView) {
                case 'landing':
                    break;

                case 'topic':
                    const topicElement = document.getElementById(navigationState.topicId);
                    const topicName = topicElement ? topicElement.querySelector('.topic-page-header h1').textContent : 'Topic';
                    breadcrumbsHTML += `
                        <span class="separator">â€º</span>
                        <span class="current">${topicName}</span>
                    `;
                    break;

                case 'subtopic':
                    const topicElem = document.getElementById(navigationState.topicId);
                    const subtopicElem = document.getElementById(navigationState.subtopicId);

                    const topicTitle = topicElem ? topicElem.querySelector('.topic-page-header h1').textContent : 'Topic';
                    const subtopicTitle = subtopicElem ? subtopicElem.querySelector('.topic-page-header h1').textContent : 'Subtopic';

                    breadcrumbsHTML += `
                        <span class="separator">â€º</span>
                        <a href="${window.location.pathname}?topic=${navigationState.topicId}" data-nav="topic" data-topic="${navigationState.topicId}">${topicTitle}</a>
                        <span class="separator">â€º</span>
                        <span class="current">${subtopicTitle}</span>
                    `;
                    break;

                case 'pathway':
                    breadcrumbsHTML += `
                        <span class="separator">â€º</span>
                        <span class="current">Research Path: ${navigationState.pathwayName}</span>
                    `;
                    break;

                case 'filtered':
                    breadcrumbsHTML += `
                        <span class="separator">â€º</span>
                        <span class="current">Research Path: ${navigationState.filterTag.split('-').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ')}</span>
                    `;
                    break;

                case 'contributor':
                    const contributorNames = {
                        'alexander-landfair': 'Alexander Landfair',
                        'cate-hackett': 'Cate Hackett',
                        'dan-ahimbisibwe': 'Dan Ahimbisibwe',
                        'debika-dharma-lingam': 'Debika Dharma Lingam',
                        'elan-hebert': 'Elan Hebert',
                        'ethan-lu': 'Ethan Lu',
                        'jesse-noppe-brandon': 'Jesse Noppe-Brandon',
                        'jiawen-li': 'Jiawen Li',
                        'joseph-jiminian': 'Joseph Jiminian',
                        'josephine-li': 'Josephine Li',
                        'karen-maza-delgado': 'Karen Maza Delgado',
                        'meiling-zhang': 'Meiling Zhang',
                        'muhammad-farhan': 'Muhammad Farhan',
                        'nasrin-alanna-aidi': 'Nasrin Alanna Aidi',
                        'paul-marinos': 'Paul Marinos',
                        'rohan-kapur': 'Rohan Kapur',
                        'sabria-islam': 'Sabria Islam',
                        'srinivas-harish': 'Srinivas Harish',
                        'unmesh-achar': 'Unmesh Achar',
                        'yanze-wu': 'Yanze Wu',
                        'yufei-huang': 'Yufei Huang'
                    };
                    const contributorName = contributorNames[navigationState.contributorId] || 'Contributor';
                    breadcrumbsHTML += `
                        <span class="separator">â€º</span>
                        <a href="#" onclick="showTopicPage('team-members'); return false;" data-nav="team-members">Team Members</a>
                        <span class="separator">â€º</span>
                        <span class="current">${contributorName}</span>
                    `;
                    break;
            }

            breadcrumbs.innerHTML = breadcrumbsHTML;

            // Add click handlers to breadcrumb links
            breadcrumbs.querySelectorAll('a[data-nav]').forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    const navType = this.getAttribute('data-nav');
                    if (navType === 'home') {
                        showLandingPage();
                    } else if (navType === 'topic') {
                        const topicId = this.getAttribute('data-topic');
                        showTopicPage(topicId);
                    }
                });
            });
        }

        function setupImprovedPathwayNavigation() {
            const container = document.querySelector('.pathways-container');
            const cards = container.querySelectorAll('.pathway-card');
            
            if (!container || cards.length === 0) return;
            
            const cardWidth = cards[0].offsetWidth;
            const gapWidth = parseInt(window.getComputedStyle(container).getPropertyValue('gap')) || 20;
            const containerWidth = container.clientWidth;
            
            const visibleCards = Math.floor(containerWidth / (cardWidth + gapWidth));
            
            const prevBtn = document.querySelector('.pathway-nav.prev');
            const nextBtn = document.querySelector('.pathway-nav.next');
            
            if (prevBtn && nextBtn) {
                const scrollAmount = visibleCards * (cardWidth + gapWidth);
                
                prevBtn.onclick = function() {
                    if (container.scrollLeft < scrollAmount/2) {
                        const maxScroll = container.scrollWidth - containerWidth;
                        container.scrollTo({ 
                            left: maxScroll, 
                            behavior: 'smooth' 
                        });
                    } else {
                        container.scrollBy({ 
                            left: -scrollAmount, 
                            behavior: 'smooth' 
                        });
                    }
                };
                
                nextBtn.onclick = function() {
                    const maxScroll = container.scrollWidth - containerWidth;
                    if (container.scrollLeft > maxScroll - scrollAmount/2) {
                        container.scrollTo({ 
                            left: 0, 
                            behavior: 'smooth' 
                        });
                    } else {
                        container.scrollBy({ 
                            left: scrollAmount, 
                            behavior: 'smooth' 
                        });
                    }
                };
            }
            
            container.style.scrollSnapType = 'x proximity';
            container.querySelectorAll('.pathway-card').forEach(card => {
                card.style.scrollSnapAlign = 'start';
            });
        }

        function initializeSearch() {
            const headerSearch = document.getElementById('header-search');
            const headerSearchResults = document.getElementById('header-search-results');
            const heroSearch = document.getElementById('hero-search');
            const heroSearchResults = document.getElementById('hero-search-results');
            
            if (headerSearch && headerSearchResults) {
                headerSearch.addEventListener('input', function() {
                    const query = this.value.trim();
                    if (query.length >= 2) {
                        const results = performSearch(query);
                        displaySearchResults(results, headerSearchResults, headerSearch);
                    } else {
                        headerSearchResults.style.display = 'none';
                    }
                });
                
                headerSearch.addEventListener('focus', function() {
                    if (this.value.trim().length >= 2) {
                        const results = performSearch(this.value.trim());
                        displaySearchResults(results, headerSearchResults, headerSearch);
                    }
                });
            }
            
            if (heroSearch && heroSearchResults) {
                heroSearch.addEventListener('input', function() {
                    const query = this.value.trim();
                    if (query.length >= 2) {
                        const results = performSearch(query);
                        displaySearchResults(results, heroSearchResults, heroSearch);
                    } else {
                        heroSearchResults.style.display = 'none';
                    }
                });
                
                heroSearch.addEventListener('focus', function() {
                    if (this.value.trim().length >= 2) {
                        const results = performSearch(this.value.trim());
                        displaySearchResults(results, heroSearchResults, heroSearch);
                    }
                });
            }
            
            document.addEventListener('click', function(e) {
                if (!e.target.closest('.search-container')) {
                    if (headerSearchResults) headerSearchResults.style.display = 'none';
                    if (heroSearchResults) heroSearchResults.style.display = 'none';
                }
            });
        }

        function performSearch(query) {
            if (!query || query.length < 2) return [];
            
            query = query.toLowerCase();
            const results = [];
            
            // Search in topic titles
            document.querySelectorAll('.topic-page-header h1').forEach(topicHeader => {
                const topicName = topicHeader.textContent;
                const topicContainer = topicHeader.closest('[id]');
                if (!topicContainer) return;
                
                const topicId = topicContainer.id;
                
                if (topicName.toLowerCase().includes(query)) {
                    results.push({
                        type: 'topic',
                        id: topicId,
                        title: topicName,
                        context: 'Topic'
                    });
                }
            });
            
            // Search in subtopic titles
            document.querySelectorAll('.subtopic-card h3').forEach(subtopicHeader => {
                const subtopicName = subtopicHeader.textContent;
                const subtopicCard = subtopicHeader.closest('.subtopic-card');
                if (!subtopicCard) return;
                
                const topicContainer = subtopicCard.closest('[id]');
                if (!topicContainer) return;
                
                if (subtopicName.toLowerCase().includes(query)) {
                    const onclickAttr = subtopicCard.getAttribute('onclick');
                    if (onclickAttr) {
                        const match = onclickAttr.match(/showSubtopicPage\('([^']+)',\s*'([^']+)'\)/);
                        if (match) {
                            const topicId = match[1];
                            const subtopicId = match[2];
                            
                            results.push({
                                type: 'subtopic',
                                topicId: topicId,
                                subtopicId: subtopicId,
                                title: subtopicName,
                                context: `Subtopic in ${topicContainer.querySelector('h1')?.textContent || 'Topic'}`
                            });
                        }
                    }
                }
            });

            // Search in citations
            document.querySelectorAll('.bib-citation').forEach(citation => {
                const citationText = citation.textContent.trim();
                
                if (citationText.toLowerCase().includes(query)) {
                    const bibEntry = citation.closest('.bib-entry');
                    if (!bibEntry) return;
                    
                    let currentNode = citation;
                    let containerId = null;
                    
                    while (currentNode && !containerId) {
                        currentNode = currentNode.parentElement;
                        if (!currentNode) break;
                        
                        if (currentNode.id) {
                            if (knownTopics.includes(currentNode.id) || 
                                knownSubtopics.includes(currentNode.id)) {
                                containerId = currentNode.id;
                                break;
                            }
                        }
                    }
                    
                    if (containerId) {
                        const containerElement = document.getElementById(containerId);
                        const headerText = containerElement ? 
                            containerElement.querySelector('.topic-page-header h1')?.textContent || 'Topic' : 
                            'Topic';
                        
                        results.push({
                            type: 'citation',
                            element: citation,
                            bibEntry: bibEntry,
                            topicId: containerId,
                            title: citationText.length > 60 ? citationText.substring(0, 60) + '...' : citationText,
                            context: `Citation in ${headerText}`
                        });
                    }
                }
            });

            // Search in annotation authors (contributors)
            document.querySelectorAll('.annotation-author').forEach(authorDiv => {
                const authorText = authorDiv.textContent.trim();

                if (authorText.toLowerCase().includes(query)) {
                    const annotation = authorDiv.closest('.bib-annotation');
                    if (!annotation) return;

                    const bibEntry = annotation.closest('.bib-entry');
                    if (!bibEntry) return;

                    const citation = bibEntry.querySelector('.bib-citation');
                    if (!citation) return;

                    const citationText = citation.textContent.trim();

                    let currentNode = annotation;
                    let containerId = null;

                    while (currentNode && !containerId) {
                        currentNode = currentNode.parentElement;
                        if (!currentNode) break;

                        if (currentNode.id) {
                            if (knownTopics.includes(currentNode.id) ||
                                knownSubtopics.includes(currentNode.id)) {
                                containerId = currentNode.id;
                                break;
                            }
                        }
                    }

                    if (containerId) {
                        const containerElement = document.getElementById(containerId);
                        const headerText = containerElement ?
                            containerElement.querySelector('.topic-page-header h1')?.textContent || 'Topic' :
                            'Topic';

                        // Extract contributor name and generate ID
                        const match = authorText.match(/^(.+?)\s+\d{1,2}\/\d{1,2}\/\d{4}/);
                        const contributorName = match ? match[1].trim() : authorText.split(/\d/)[0].trim();
                        const contributorId = contributorName.toLowerCase()
                            .replace(/[^a-z0-9\s-]/g, '')
                            .replace(/\s+/g, '-')
                            .replace(/-+/g, '-');

                        results.push({
                            type: 'contributor',
                            element: citation,
                            bibEntry: bibEntry,
                            topicId: containerId,
                            contributorId: contributorId,
                            contributorName: contributorName,
                            title: citationText.length > 60 ? citationText.substring(0, 60) + '...' : citationText,
                            context: `Annotated by ${contributorName} in ${headerText}`
                        });
                    }
                }
            });

            return results;
        }

        function displaySearchResults(results, resultsContainer, inputElement) {
            resultsContainer.innerHTML = '';
            
            if (results.length === 0) {
                resultsContainer.innerHTML = '<div class="search-result-item">No results found</div>';
                resultsContainer.style.display = 'block';
                return;
            }
            
            results.forEach(result => {
                const resultItem = document.createElement('div');
                resultItem.className = 'search-result-item';
                
                const title = document.createElement('div');
                title.className = 'result-title';
                title.textContent = result.title;
                
                const context = document.createElement('div');
                context.className = 'result-context';
                context.textContent = result.context;
                
                resultItem.appendChild(title);
                resultItem.appendChild(context);
                
                resultItem.addEventListener('click', () => {
                    resultsContainer.style.display = 'none';

                    if (result.type === 'topic') {
                        showTopicPage(result.id);
                    }
                    else if (result.type === 'subtopic') {
                        showSubtopicPage(result.topicId, result.subtopicId);
                    }
                    else if (result.type === 'contributor' && result.contributorId) {
                        // Navigate to contributor page instead of scrolling to citation
                        showContributorPage(result.contributorId);
                    }
                    else if (result.type === 'citation') {
                        showTopicPage(result.topicId);

                        setTimeout(() => {
                            if (result.element) {
                                result.element.scrollIntoView({ behavior: 'smooth', block: 'center' });
                                result.element.classList.add('highlight');
                                setTimeout(() => {
                                    result.element.classList.remove('highlight');
                                }, 2000);
                            }
                        }, 300);
                    }
                });
                
                resultsContainer.appendChild(resultItem);
            });
            
            resultsContainer.style.display = 'block';
        }

        function toggleHeaderMenu() {
            const dropdown = document.getElementById('header-dropdown');
            dropdown.classList.toggle('show');
        }

        // Dark Mode Toggle Function
        function toggleDarkMode() {
            const body = document.body;
            const currentTheme = body.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';

            body.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);

            // Update toggle button text and icon
            const darkModeText = document.getElementById('dark-mode-text');
            const darkModeToggle = document.getElementById('dark-mode-toggle');
            const icon = darkModeToggle.querySelector('i');

            // Update logo
            const logo = document.getElementById('header-logo');

            if (newTheme === 'dark') {
                darkModeText.textContent = 'Light Mode';
                icon.className = 'fas fa-sun';
                if (logo) logo.src = 'https://i.imgur.com/OoiuRmJ.png';
            } else {
                darkModeText.textContent = 'Dark Mode';
                icon.className = 'fas fa-moon';
                if (logo) logo.src = 'https://i.imgur.com/HpJ1Z46.png';
            }
        }

        // Initialize dark mode on page load
        function initializeDarkMode() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.body.setAttribute('data-theme', savedTheme);

            // Update button text and icon based on saved theme
            const darkModeText = document.getElementById('dark-mode-text');
            const darkModeToggle = document.getElementById('dark-mode-toggle');
            const logo = document.getElementById('header-logo');

            if (darkModeToggle) {
                const icon = darkModeToggle.querySelector('i');
                if (savedTheme === 'dark') {
                    darkModeText.textContent = 'Light Mode';
                    icon.className = 'fas fa-sun';
                    if (logo) logo.src = 'https://i.imgur.com/OoiuRmJ.png';
                } else {
                    darkModeText.textContent = 'Dark Mode';
                    icon.className = 'fas fa-moon';
                    if (logo) logo.src = 'https://i.imgur.com/HpJ1Z46.png';
                }
            }
        }

        // Call initialization when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeDarkMode);
        } else {
            initializeDarkMode();
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', function(event) {
            const dropdown = document.getElementById('header-dropdown');
            const menuTrigger = document.querySelector('.menu-trigger');

            if (dropdown && !dropdown.contains(event.target) && !menuTrigger.contains(event.target)) {
                dropdown.classList.remove('show');
            }
        });

        function showLandingPage(skipHistory) {
            navigationState = {
                currentView: 'landing',
                topicId: null,
                subtopicId: null,
                subsubtopicId: null,
                pathwayName: null,
                filterTag: null
            };

            document.querySelectorAll('.topic-pages > div').forEach(page => {
                page.style.display = 'none';
            });

            document.querySelector('.topic-pages').style.display = 'none';
            document.querySelector('.landing-page').style.display = 'block';

            document.body.classList.remove('show-topics', 'show-breadcrumbs');

            document.querySelector('.header-title').classList.remove('visible');

            const filteredResults = document.getElementById('filtered-results');
            if (filteredResults) {
                filteredResults.style.display = 'none';
            }

            // Update browser URL using History API
            if (!skipHistory) {
                const url = window.location.pathname;
                history.pushState(navigationState, 'AI in Education VIP Research Exchange', url);
            }

            // Rebuild entries index when returning to homepage
            if (window.entriesIndexAPI && window.entriesIndexAPI.rebuildIndex) {
                window.entriesIndexAPI.rebuildIndex();
            }

            window.scrollTo(0, 0);
            updateEntryCounter();
        }

        // Count entries in a specific page
        function countEntriesInPage(pageId) {
            const page = document.getElementById(pageId);
            if (!page) return 0;
            return page.querySelectorAll('.bib-entry').length;
        }

        // Count all entries across a topic (including all subtopics)
        function countEntriesInTopic(topicId) {
            let totalCount = 0;

            // Find the topic page
            const topicPage = document.getElementById(topicId);
            if (!topicPage) return 0;

            // Find all subtopic cards in this topic
            const subtopicCards = topicPage.querySelectorAll('.subtopic-card[onclick]');

            // Extract subtopic IDs from onclick attributes and count entries
            subtopicCards.forEach(card => {
                const onclick = card.getAttribute('onclick');
                if (!onclick) return;

                const match = onclick.match(/showSubtopicPage\('([^']+)',\s*'([^']+)'\)/);
                if (match) {
                    const subtopicId = match[2];
                    totalCount += countEntriesInPage(subtopicId);
                }
            });

            return totalCount;
        }

        // Update entry counts on landing page topic cards
        function updateTopicCardCounts() {
            const topics = [
                { id: 'evaluating-tools', name: 'Evaluating Tools' },
                { id: 'understanding-users', name: 'Understanding Users' },
                { id: 'assessing-impacts', name: 'Assessing Impacts' },
                { id: 'innovating-edtech', name: 'Innovating EdTech' },
                { id: 'learning-science', name: 'Learning Science' },
                { id: 'research-methods', name: 'Research Methods' }
            ];

            topics.forEach(topic => {
                const count = countEntriesInTopic(topic.id);
                // Find the h3 in the category-header and update it
                const categoryHeaders = document.querySelectorAll('.category-header');
                categoryHeaders.forEach(header => {
                    const h3 = header.querySelector('h3');
                    if (h3 && h3.textContent.includes(topic.name)) {
                        // Remove any existing count
                        const cleanName = h3.textContent.replace(/\s*\(\d+\)/, '');
                        h3.textContent = `${cleanName} (${count})`;
                    }
                });
            });
        }

        // Update entry counts on subtopic cards
        function updateSubtopicCardCounts(topicId) {
            const topicPage = document.getElementById(topicId);
            if (!topicPage) return;

            const subtopicCards = topicPage.querySelectorAll('.subtopic-card');
            subtopicCards.forEach(card => {
                // Extract subtopic ID from onclick attribute
                const onclick = card.getAttribute('onclick');
                if (!onclick) return;

                const match = onclick.match(/showSubtopicPage\('([^']+)',\s*'([^']+)'\)/);
                if (!match) return;

                const subtopicId = match[2];
                const count = countEntriesInPage(subtopicId);

                // Update the h3 with count
                const h3 = card.querySelector('h3');
                if (h3) {
                    // Remove any existing count
                    const cleanName = h3.textContent.replace(/\s*\(\d+\)/, '');
                    h3.textContent = `${cleanName} (${count})`;
                }
            });
        }

        // Update all entry counts (call after loading contributions)
        function updateEntryCount(pageId) {
            // Update topic cards on landing page
            updateTopicCardCounts();

            // If we're on a topic page with subtopics, update those counts too
            if (pageId) {
                updateSubtopicCardCounts(pageId);
            }
        }

        // Make updateEntryCount globally accessible
        window.updateEntryCount = updateEntryCount;

        function showTopicPage(topicId, skipHistory) {
            navigationState = {
                currentView: 'topic',
                topicId: topicId,
                subtopicId: null,
                subsubtopicId: null,
                pathwayName: null,
                filterTag: null
            };

            document.body.classList.add('show-topics');
            document.body.classList.add('show-breadcrumbs');

            document.querySelectorAll('.topic-pages > div').forEach(div => {
                div.style.display = 'none';
            });

            document.getElementById(topicId).style.display = 'block';

            document.querySelector('.landing-page').style.display = 'none';
            document.querySelector('.topic-pages').style.display = 'block';

            const headerTitle = document.querySelector('.header-title');
            headerTitle.classList.add('visible');

            // Update browser URL using History API
            if (!skipHistory) {
                const url = `${window.location.pathname}?topic=${topicId}`;
                const topicElement = document.getElementById(topicId);
                const pageTitle = topicElement ? topicElement.querySelector('.topic-page-header h1').textContent : 'Topic';
                history.pushState(navigationState, pageTitle, url);
            }

            // Rebuild entries index to update URLs with new topic/subtopic context
            if (window.entriesIndexAPI && window.entriesIndexAPI.rebuildIndex) {
                window.entriesIndexAPI.rebuildIndex();
            }

            // Update entry count for this page
            updateEntryCount(topicId);

            updateBreadcrumbs();
            window.scrollTo(0, 0);
        }

        function showSubtopicPage(topicId, subtopicId, skipHistory) {
            navigationState = {
                currentView: 'subtopic',
                topicId: topicId,
                subtopicId: subtopicId,
                subsubtopicId: null,
                pathwayName: null,
                filterTag: null
            };

            document.body.classList.add('show-topics');
            document.body.classList.add('show-breadcrumbs');

            document.querySelectorAll('.topic-pages > div').forEach(div => {
                div.style.display = 'none';
            });

            document.getElementById(subtopicId).style.display = 'block';

            document.querySelector('.landing-page').style.display = 'none';
            document.querySelector('.topic-pages').style.display = 'block';

            const headerTitle = document.querySelector('.header-title');
            headerTitle.classList.add('visible');

            // Update browser URL using History API
            if (!skipHistory) {
                const url = `${window.location.pathname}?topic=${topicId}&subtopic=${subtopicId}`;
                const subtopicElement = document.getElementById(subtopicId);
                const pageTitle = subtopicElement ? subtopicElement.querySelector('.topic-page-header h1').textContent : 'Subtopic';
                history.pushState(navigationState, pageTitle, url);
            }

            // Rebuild entries index to update URLs with new topic/subtopic context
            if (window.entriesIndexAPI && window.entriesIndexAPI.rebuildIndex) {
                window.entriesIndexAPI.rebuildIndex();
            }

            // Note: Contributions are already loaded globally by loadFirestoreContributions() in entriesIndex.js
            // The global loader handles duplicate prevention with data-contribution-id and data-location attributes
            // No need to clear or reload entries when navigating

            // Update entry count for this page
            updateEntryCount(subtopicId);

            updateBreadcrumbs();
            window.scrollTo(0, 0);
        }

        function showContributorPage(contributorId, skipHistory) {
            // Get contributor info dynamically from entries
            const contributorInfo = window.contributorAPI.getContributorInfo(contributorId);

            if (!contributorInfo) {
                console.error(`Contributor not found: ${contributorId}`);
                alert(`Unable to load contributor page. This may be due to formatting issues. Please check the browser console for details or contact support.`);
                return;
            }

            const contributorName = contributorInfo.name;

            // Find all annotations by this contributor (exclude contributor pages to avoid duplicates)
            const allAnnotations = [];
            document.querySelectorAll('.bib-annotation').forEach(annotation => {
                // Skip annotations that are inside contributor pages
                const parentContributorPage = annotation.closest('[id^="contributor-"]');
                if (!parentContributorPage) {
                    allAnnotations.push(annotation);
                }
            });

            const contributorAnnotations = [];

            console.log(`[Contributor Page] Searching for ${contributorName}`);
            console.log(`[Contributor Page] Found ${allAnnotations.length} total .bib-annotation elements (excluding contributor pages)`);

            let matchingAnnotations = 0;
            const matchedEntries = []; // Track what we match for debugging

            // Helper function to process and add an entry
            const addEntryToList = (bibEntry, topicName, topicId, contributionType = 'original') => {
                if (!bibEntry) return;

                // Clone the entry
                const clonedEntry = bibEntry.cloneNode(true);

                // Keep the entire annotation thread intact for context
                // (If contributor participated, show full discussion including replies/responses)

                // Make IDs unique by prefixing with contributor ID and topic
                const annotationContainer = clonedEntry.querySelector('.bib-annotation-container');
                if (annotationContainer && annotationContainer.id) {
                    const originalId = annotationContainer.id;
                    const newId = `${contributorId}-${topicId}-${originalId}`;
                    annotationContainer.id = newId;

                    // Hide initially
                    annotationContainer.style.display = 'none';
                }

                // Ensure collapse indicator is not expanded
                const indicator = clonedEntry.querySelector('.collapse-indicator');
                if (indicator) {
                    indicator.classList.remove('expanded');
                }

                contributorAnnotations.push({
                    entry: clonedEntry,
                    citation: clonedEntry.querySelector('.bib-citation'),
                    topicName: topicName,
                    topicId: topicId,
                    contributionType: contributionType,
                    entryId: bibEntry.getAttribute('data-contribution-id') || bibEntry.id || ''
                });
            };

            // Helper function to get topic info from an entry
            const getTopicInfo = (bibEntry) => {
                // Find the parent page to determine topic/subtopic
                let parentPage = bibEntry.parentElement;
                while (parentPage && !parentPage.classList.contains('topic-pages')) {
                    if (parentPage.querySelector('.topic-page-header')) {
                        break;
                    }
                    parentPage = parentPage.parentElement;
                }

                let topicName = 'Other';
                let topicId = '';

                if (parentPage && parentPage.querySelector('.topic-page-header')) {
                    const pageHeader = parentPage.querySelector('.topic-page-header h1');
                    const currentPageName = pageHeader ? pageHeader.textContent.trim() : '';
                    const currentPageId = parentPage.id || '';

                    // Check if this is a subtopic by looking for subtopic cards that reference it
                    const allSubtopicCards = document.querySelectorAll('.subtopic-card[onclick]');
                    let parentTopicName = null;

                    for (const card of allSubtopicCards) {
                        const onclick = card.getAttribute('onclick');
                        if (onclick && onclick.includes(`'${currentPageId}'`)) {
                            // Extract parent topic ID from onclick: showSubtopicPage('parent-topic', 'subtopic')
                            const match = onclick.match(/showSubtopicPage\('([^']+)',\s*'([^']+)'\)/);
                            if (match && match[1]) {
                                const parentTopicId = match[1];
                                // Find the parent topic page to get its name
                                const parentTopicPage = document.getElementById(parentTopicId);
                                if (parentTopicPage) {
                                    const parentHeader = parentTopicPage.querySelector('.topic-page-header h1');
                                    if (parentHeader) {
                                        parentTopicName = parentHeader.textContent.trim();
                                    }
                                }
                            }
                            break;
                        }
                    }

                    // Format as "Topic -> Subtopic" or just "Topic"
                    if (parentTopicName) {
                        topicName = `${parentTopicName} â†’ ${currentPageName}`;
                    } else {
                        topicName = currentPageName;
                    }
                    topicId = currentPageId;
                }

                return { topicName, topicId };
            };

            // Track which entry IDs we've already added to avoid duplicates
            const addedEntryIds = new Set();

            // First, find all original annotations by this contributor
            allAnnotations.forEach(annotation => {
                const authorDiv = annotation.querySelector('.annotation-author');
                const authorText = authorDiv ? authorDiv.textContent.trim() : '';

                if (authorDiv && authorDiv.textContent.includes(contributorName)) {
                    matchingAnnotations++;
                    const bibEntry = annotation.closest('.bib-entry');
                    if (bibEntry) {
                        // Use data-contribution-id first for consistent deduplication across multi-category entries
                        const entryId = bibEntry.getAttribute('data-contribution-id') || bibEntry.id || '';
                        const citationPreview = bibEntry.querySelector('.bib-citation')?.textContent.substring(0, 50) || '';
                        matchedEntries.push({ entryId, citationPreview, authorText });

                        // Get topic info and add to list
                        const { topicName, topicId } = getTopicInfo(bibEntry);

                        // Track this entry ID to avoid duplicates when processing perspectives
                        const uniqueKey = `${topicId}-${entryId}`;
                        addedEntryIds.add(uniqueKey);

                        addEntryToList(bibEntry, topicName, topicId, 'original');
                    }
                }
            });

            // Now, find all perspectives added by this contributor
            const allPerspectives = document.querySelectorAll('.perspective-item');
            let matchingPerspectives = 0;
            const processedPerspectiveEntries = new Set(); // Track perspectives by entry ID only (not topic+entry)

            allPerspectives.forEach(perspectiveDiv => {
                // Skip perspectives that are inside contributor pages
                const parentContributorPage = perspectiveDiv.closest('[id^="contributor-"]');
                if (parentContributorPage) return;

                // The author info is in the div with font-size: 0.8rem
                const authorDivs = perspectiveDiv.querySelectorAll('div');
                const authorDiv = Array.from(authorDivs).find(div => {
                    const style = div.getAttribute('style') || '';
                    return style.includes('font-size: 0.8rem');
                });

                if (authorDiv) {
                    const authorText = authorDiv.textContent.trim();
                    // Format is "â€” AuthorName Date", so remove the em dash first
                    const cleanedText = authorText.replace(/^[â€”\-]\s*/, '');
                    // Extract name (before the date)
                    const match = cleanedText.match(/^(.+?)\s+\d{1,2}\/\d{1,2}\/\d{4}/);

                    if (match) {
                        const perspectiveAuthorName = match[1].trim();

                        // Check if this perspective is by our contributor
                        if (perspectiveAuthorName === contributorName) {
                            // Find the parent bib-entry
                            const bibEntry = perspectiveDiv.closest('.bib-entry');
                            if (bibEntry) {
                                const entryId = bibEntry.getAttribute('data-contribution-id') || bibEntry.id || '';

                                // For perspectives, deduplicate by entry ID only (not topic+entry)
                                // since a perspective is added once per entry, regardless of how many topics it appears in
                                if (!processedPerspectiveEntries.has(entryId)) {
                                    processedPerspectiveEntries.add(entryId);
                                    matchingPerspectives++;

                                    const { topicName, topicId } = getTopicInfo(bibEntry);
                                    const uniqueKey = `${topicId}-${entryId}`;

                                    // Only add if we haven't already added this entry (from original annotations)
                                    if (!addedEntryIds.has(uniqueKey)) {
                                        addedEntryIds.add(uniqueKey);
                                        addEntryToList(bibEntry, topicName, topicId, 'perspective');
                                    }
                                }
                            }
                        }
                    }
                }
            });

            console.log(`[Contributor Page] Found ${matchingAnnotations} matching annotations and ${matchingPerspectives} matching perspectives`);
            console.log(`[Contributor Page] Matched entries:`, matchedEntries);

            // Calculate unique contribution count (by entry ID) and separate by type
            const uniqueEntryIds = new Set();
            const originalEntryIds = new Set();
            const perspectiveOnlyEntryIds = new Set();

            contributorAnnotations.forEach(item => {
                // Use ONLY data-contribution-id for unique counting (not item.entry.id which varies by location)
                const entryId = item.entry.getAttribute('data-contribution-id');
                if (entryId) {
                    uniqueEntryIds.add(entryId);
                    if (item.contributionType === 'original') {
                        originalEntryIds.add(entryId);
                    } else if (item.contributionType === 'perspective') {
                        perspectiveOnlyEntryIds.add(entryId);
                    }
                }
            });
            const uniqueCount = uniqueEntryIds.size;
            const originalCount = originalEntryIds.size;
            const perspectiveOnlyCount = perspectiveOnlyEntryIds.size;

            console.log(`[Contributor Page] ${uniqueCount} unique entries: ${originalCount} original contributions, ${perspectiveOnlyCount} perspective-only entries, displayed in ${contributorAnnotations.length} locations`);

            // Create or update contributor page
            let contributorPage = document.getElementById(`contributor-${contributorId}`);
            if (!contributorPage) {
                contributorPage = document.createElement('div');
                contributorPage.id = `contributor-${contributorId}`;
                contributorPage.style.display = 'none';
                document.querySelector('.topic-pages').appendChild(contributorPage);
            }

            // Clear existing content
            contributorPage.innerHTML = '';

            // Create page structure
            const pageHeader = document.createElement('div');
            pageHeader.className = 'topic-page-header';

            // Build clear, unambiguous count text
            // Note: uniqueCount = total entries displayed = originalCount + perspectiveOnlyCount
            let countText = '';

            if (originalCount > 0 && perspectiveOnlyCount > 0) {
                // Has both original entries and entries with added perspectives
                countText = `${uniqueCount} ${uniqueCount === 1 ? 'entry' : 'entries'} (${originalCount} original, ${perspectiveOnlyCount} with added perspectives)`;
            } else if (originalCount > 0 && perspectiveOnlyCount === 0) {
                // Only original contributions
                countText = `${originalCount} original ${originalCount === 1 ? 'entry' : 'entries'}`;
            } else if (originalCount === 0 && perspectiveOnlyCount > 0) {
                // Only entries with perspectives added (no original contributions)
                countText = `${perspectiveOnlyCount} ${perspectiveOnlyCount === 1 ? 'entry' : 'entries'} with added perspectives`;
            } else {
                // No contributions (shouldn't happen if this page is shown)
                countText = '0 entries';
            }

            // Add location info if there are multiple locations
            if (contributorAnnotations.length !== uniqueCount) {
                countText += ` across ${contributorAnnotations.length} ${contributorAnnotations.length === 1 ? 'location' : 'locations'}`;
            }

            pageHeader.innerHTML = `
                <h1>${contributorName}</h1>
                <p>Contributions to the AI in Education VIP Research Exchange (${countText})</p>
            `;

            const topicContent = document.createElement('div');
            topicContent.className = 'topic-content';

            const bibliographyContainer = document.createElement('div');
            bibliographyContainer.className = 'bibliography-container';

            // Group entries by topic
            const entriesByTopic = {};
            contributorAnnotations.forEach(item => {
                const topicKey = item.topicName;
                if (!entriesByTopic[topicKey]) {
                    entriesByTopic[topicKey] = [];
                }
                entriesByTopic[topicKey].push(item);
            });

            // Sort topics alphabetically
            const sortedTopics = Object.keys(entriesByTopic).sort();

            // Create sections for each topic
            sortedTopics.forEach(topicName => {
                const topicEntries = entriesByTopic[topicName];

                // Create topic header
                const topicHeader = document.createElement('div');
                topicHeader.style.cssText = `
                    margin-top: 30px;
                    margin-bottom: 20px;
                    padding-bottom: 10px;
                    border-bottom: 2px solid #57068c;
                `;
                topicHeader.innerHTML = `
                    <h2 style="color: #57068c; font-size: 1.4rem; margin: 0; font-weight: 600;">
                        ${topicName}
                    </h2>
                    <p style="color: #666; font-size: 0.9rem; margin: 5px 0 0 0;">
                        ${topicEntries.length} ${topicEntries.length === 1 ? 'contribution' : 'contributions'}
                    </p>
                `;

                bibliographyContainer.appendChild(topicHeader);

                // Sort entries alphabetically by citation text
                topicEntries.sort((a, b) => {
                    const citationA = (a.citation?.textContent || '').toLowerCase();
                    const citationB = (b.citation?.textContent || '').toLowerCase();
                    return citationA.localeCompare(citationB);
                });

                // Append entries for this topic
                topicEntries.forEach(item => {
                    const entry = item.entry;

                    // Make sure citation has pointer cursor
                    const citation = entry.querySelector('.bib-citation');
                    if (citation) {
                        citation.style.cursor = 'pointer';
                    }

                    bibliographyContainer.appendChild(entry);
                });
            });

            // No local event listener needed - the global document listener handles all pages

            topicContent.appendChild(bibliographyContainer);
            contributorPage.appendChild(pageHeader);
            contributorPage.appendChild(topicContent);

            // Show the page
            navigationState = {
                currentView: 'contributor',
                contributorId: contributorId,
                topicId: null,
                subtopicId: null,
                subsubtopicId: null,
                pathwayName: null,
                filterTag: null
            };

            document.body.classList.add('show-topics');
            document.body.classList.add('show-breadcrumbs');

            document.querySelectorAll('.topic-pages > div').forEach(div => {
                div.style.display = 'none';
            });

            contributorPage.style.display = 'block';

            document.querySelector('.landing-page').style.display = 'none';
            document.querySelector('.topic-pages').style.display = 'block';

            const headerTitle = document.querySelector('.header-title');
            headerTitle.classList.add('visible');

            // Update browser URL using History API
            if (!skipHistory) {
                const url = `${window.location.pathname}?contributor=${contributorId}`;
                history.pushState(navigationState, contributorName, url);
            }

            updateBreadcrumbs();
            window.scrollTo(0, 0);
        }

        function initializePathwayNavigation() {
            const pathwaysContainer = document.querySelector('.pathways-container');
            const prevBtn = document.querySelector('.pathway-nav.prev');
            const nextBtn = document.querySelector('.pathway-nav.next');
            
            if (pathwaysContainer && prevBtn && nextBtn) {
                prevBtn.addEventListener('click', function() {
                    pathwaysContainer.scrollBy({ left: -300, behavior: 'smooth' });
                });
                
                nextBtn.addEventListener('click', function() {
                    pathwaysContainer.scrollBy({ left: 300, behavior: 'smooth' });
                });
            }
            
            const pathwayCards = document.querySelectorAll('.pathway-card');
            pathwayCards.forEach((card, index) => {
                const viewMoreLink = card.querySelector('.view-more');
                if (viewMoreLink) {
                    viewMoreLink.href = '#';
                    viewMoreLink.addEventListener('click', function(e) {
                        e.preventDefault();
                        showPathwayPage(index + 1);
                    });
                }
            });
        }

        function showPathwayPage(pathwayId) {
            const pathwayElement = document.querySelector(`.pathway-card:nth-child(${pathwayId})`);
            const pathwayName = pathwayElement.querySelector('.pathway-title').textContent;
            
            navigationState = {
                currentView: 'pathway',
                topicId: null,
                subtopicId: null,
                subsubtopicId: null,
                pathwayName: pathwayName,
                filterTag: null
            };
            
            document.body.classList.add('show-topics');
            document.body.classList.add('show-breadcrumbs');
            
            let methodsContainer = document.getElementById('research-methods-placeholder');
            if (!methodsContainer) {
                methodsContainer = document.createElement('div');
                methodsContainer.id = 'research-methods-placeholder';
                methodsContainer.className = 'topic-container';
                document.querySelector('.topic-pages').appendChild(methodsContainer);
            }
            
            methodsContainer.innerHTML = `
                <div class="topic-page-header">
                    <h1>${pathwayName}</h1>
                    <p>Research methodology resources for this area are currently being developed.</p>
                </div>
                <div class="topic-content">
                    <div class="empty-content-placeholder">
                        <div class="placeholder-message">
                            <i class="fas fa-tools" style="font-size: 2.5rem; color: #57068c; margin-bottom: 15px;"></i>
                            <h3>Resources Coming Soon</h3>
                            <p>Our VIP team is developing comprehensive guides and resources for this research methodology. Check back soon for tutorials, templates, and best practices.</p>
                            <button class="contribute-btn" style="margin-top: 15px;" onclick="openContributePopup()">Contribute Resources</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.querySelectorAll('.topic-pages > div').forEach(div => {
                div.style.display = 'none';
            });
            
            methodsContainer.style.display = 'block';
            
            document.querySelector('.landing-page').style.display = 'none';
            document.querySelector('.topic-pages').style.display = 'block';
            
            const headerTitle = document.querySelector('.header-title');
            headerTitle.classList.add('visible');
            
            updateBreadcrumbs();
            window.scrollTo(0, 0);
        }

        function initializePopupSystem() {
            const contributeBtn = document.querySelector('.contribute-btn');
            if (contributeBtn) {
                contributeBtn.addEventListener('click', openContributePopup);
            }
            
            const perspectiveButtons = document.querySelectorAll('.add-perspective-btn');
            perspectiveButtons.forEach(button => {
                button.addEventListener('click', openContributePopup);
            });
            
            const closeButtons = document.querySelectorAll('.close-btn');
            closeButtons.forEach(button => {
                button.addEventListener('click', closeContributePopup);
            });
            
            const popups = document.querySelectorAll('.popup');
            popups.forEach(popup => {
                popup.addEventListener('click', function(event) {
                    if (event.target === this) {
                        closeContributePopup();
                    }
                });
            });
            
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    closeContributePopup();
                }
            });
            
            const closeModalBtn = document.querySelector('.close-modal');
            if (closeModalBtn) {
                closeModalBtn.addEventListener('click', closeSourceModal);
            }
        }

        function openContributePopup() {
            // Reset draft ID when opening fresh (not from drafts)
            currentDraftId = null;
            // Open new contribution modal instead of Google Form
            openContributionModal();
        }

        function closeContributePopup() {
            document.getElementById('contribute-popup').style.display = 'none';
            document.body.style.overflow = 'auto';
        }

        function closePopup() {
            closeContributePopup();
        }

        // Contribution Modal Functions
        let currentStep = 1;
        const totalSteps = 3;

        // Subtopic mapping
        const subtopics = {
            'understanding-users': [
                { value: 'general', label: 'General' },
                { value: 'administrators', label: 'Administrators' },
                { value: 'students', label: 'Students' },
                { value: 'faculty', label: 'Faculty' }
            ],
            'evaluating-tools': [
                { value: 'coding', label: 'Coding' },
                { value: 'creativity', label: 'Creativity' },
                { value: 'detection-tools', label: 'Detection Tools' },
                { value: 'ethics-safety', label: 'Ethics & Safety' },
                { value: 'equity-social-justice', label: 'Equity & Social Justice' },
                { value: 'error-hallucination', label: 'Error & Hallucination' },
                { value: 'reasoning', label: 'Reasoning' },
                { value: 'usability', label: 'Usability' },
                { value: 'translation', label: 'Translation' }
            ],
            'assessing-impacts': [
                { value: 'learning-outcomes', label: 'Learning Outcomes' },
                { value: 'academic-integrity', label: 'Academic Integrity' },
                { value: 'assessment-validity', label: 'Assessment Validity' },
                { value: 'student-wellbeing', label: 'Student Wellbeing' },
                { value: 'equity-access', label: 'Equity & Access' }
            ],
            'innovating-edtech': [
                { value: 'ai-tutoring', label: 'AI Tutoring & Learning Support' },
                { value: 'writing-content-generation', label: 'Writing & Content Generation Tools' },
                { value: 'detection-integrity', label: 'Detection & Academic Integrity Tools' },
                { value: 'organizational-productivity', label: 'Organizational & Productivity Tools' },
                { value: 'feedback-assessment', label: 'Feedback & Assessment' },
                { value: 'accessibility-inclusion', label: 'Accessibility & Inclusion' },
                { value: 'learning-analytics', label: 'Classroom & Learning Analytics' },
                { value: 'scheduling', label: 'Scheduling' }
            ],
            'learning-science': [
                { value: 'writing-composition', label: 'Writing & Composition' },
                { value: 'cognitive-science', label: 'Cognitive Science' },
                { value: 'reading-literacy', label: 'Reading & Literacy' },
                { value: 'educational-philosophy', label: 'Educational Philosophy' },
                { value: 'ai-ml-foundations', label: 'AI/ML Foundations' }
            ],
            'research-methods': [
                { value: 'literature-review', label: 'Literature Review' },
                { value: 'collaborative-research', label: 'Collaborative Research' },
                { value: 'experimental-design', label: 'Experimental Design' },
                { value: 'survey-design', label: 'Survey Design' },
                { value: 'interview-focus-groups', label: 'Interview & Focus Groups' },
                { value: 'data-analysis', label: 'Data Analysis' },
                { value: 'research-ethics', label: 'Research Ethics' },
                { value: 'academic-writing', label: 'Academic Writing' }
            ]
        };

        // Secondary category management
        let secondaryCategoryCount = 0;
        const MAX_SECONDARY_CATEGORIES = 2;

        function addSecondaryCategory() {
            if (secondaryCategoryCount >= MAX_SECONDARY_CATEGORIES) {
                alert('Maximum 2 secondary categories allowed');
                return;
            }

            secondaryCategoryCount++;
            const container = document.getElementById('secondary-categories-container');
            const categoryDiv = document.createElement('div');
            categoryDiv.className = `secondary-category-${secondaryCategoryCount}`;
            categoryDiv.style.cssText = 'margin-bottom: 15px; padding: 15px; background: white; border-radius: 8px; border: 1px solid #ddd;';

            categoryDiv.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <h5 style="margin: 0; color: #57068c; font-size: 0.9rem;">Secondary Category ${secondaryCategoryCount}</h5>
                    <button type="button" onclick="removeSecondaryCategory(${secondaryCategoryCount})"
                            style="padding: 4px 8px; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.8rem;">
                        <i class="fas fa-times"></i> Remove
                    </button>
                </div>
                <div style="margin-bottom: 10px;">
                    <label style="display: block; font-weight: 500; margin-bottom: 5px; color: #2d2d2d; font-size: 0.9rem;">Topic</label>
                    <select class="secondary-topic" data-index="${secondaryCategoryCount}" onchange="updateSecondarySubtopics(${secondaryCategoryCount})"
                            style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-family: 'Montserrat', sans-serif; font-size: 0.9rem;">
                        <option value="">-- Select topic --</option>
                        <option value="evaluating-tools">Evaluating Tools</option>
                        <option value="understanding-users">Understanding Users</option>
                        <option value="assessing-impacts">Assessing Impacts</option>
                        <option value="innovating-edtech">Innovating EdTech</option>
                        <option value="learning-science">Learning Science</option>
                        <option value="research-methods">Research Methods</option>
                    </select>
                </div>
                <div>
                    <label style="display: block; font-weight: 500; margin-bottom: 5px; color: #2d2d2d; font-size: 0.9rem;">Subtopic</label>
                    <select class="secondary-subtopic" data-index="${secondaryCategoryCount}"
                            style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-family: 'Montserrat', sans-serif; font-size: 0.9rem;">
                        <option value="">-- Select topic first --</option>
                    </select>
                </div>
            `;

            container.appendChild(categoryDiv);

            // Update button visibility
            if (secondaryCategoryCount >= MAX_SECONDARY_CATEGORIES) {
                document.getElementById('add-secondary-category-btn').style.display = 'none';
            }
        }

        function removeSecondaryCategory(index) {
            const categoryDiv = document.querySelector(`.secondary-category-${index}`);
            if (categoryDiv) {
                categoryDiv.remove();
                secondaryCategoryCount--;

                // Show add button if below max
                if (secondaryCategoryCount < MAX_SECONDARY_CATEGORIES) {
                    document.getElementById('add-secondary-category-btn').style.display = 'block';
                }
            }
        }

        function updateSecondarySubtopics(index) {
            const topicSelect = document.querySelector(`.secondary-topic[data-index="${index}"]`);
            const subtopicSelect = document.querySelector(`.secondary-subtopic[data-index="${index}"]`);

            if (!topicSelect || !subtopicSelect) return;

            const selectedTopic = topicSelect.value;
            subtopicSelect.innerHTML = '<option value="">-- Select a subtopic --</option>';

            if (selectedTopic && subtopics[selectedTopic]) {
                subtopics[selectedTopic].forEach(subtopic => {
                    const option = document.createElement('option');
                    option.value = subtopic.value;
                    option.textContent = subtopic.label;
                    subtopicSelect.appendChild(option);
                });
            }
        }

        function getSecondaryCategories() {
            const categories = [];
            const topicSelects = document.querySelectorAll('.secondary-topic');

            topicSelects.forEach(topicSelect => {
                const index = topicSelect.getAttribute('data-index');
                const subtopicSelect = document.querySelector(`.secondary-subtopic[data-index="${index}"]`);

                if (topicSelect.value && subtopicSelect.value) {
                    categories.push({
                        topic: topicSelect.value,
                        subtopic: subtopicSelect.value
                    });
                }
            });

            return categories;
        }

        async function openContributionModal(skipValidation = false) {
            // Check if user has permission to contribute (skip if loading a draft)
            const currentUser = window.auth.getCurrentUser();
            if (!currentUser && !skipValidation) {
                showNotification('Please sign in to add entries.', 'error');
                return;
            }

            // Alumni can only edit existing entries, not create new ones (skip if loading a draft)
            if (!skipValidation && currentUser.role === 'alumni') {
                showNotification('As an alumni, you can edit your previous contributions but cannot add new entries.', 'info');
                return;
            }

            // Check for contributor roles (including new types) (skip if loading a draft)
            if (!skipValidation) {
                const isContributor = currentUser.role === 'contributor' ||
                                      currentUser.role === 'first-year-contributor' ||
                                      currentUser.role === 'continuing-contributor' ||
                                      currentUser.role === 'admin';

                if (!isContributor) {
                    showNotification('Please sign in with a contributor or admin account to add entries.', 'error');
                    return;
                }

                // Check contribution pacing for first-year and continuing contributors
                if (window.auth.requiresPacing()) {
                    try {
                        const progressData = await window.auth.getProgressStatus();

                        if (!progressData.canContribute && progressData.nextAllowedDate) {
                            const nextDate = new Date(progressData.nextAllowedDate);
                            const dateStr = nextDate.toLocaleDateString('en-US', {
                                year: 'numeric',
                                month: 'long',
                                day: 'numeric'
                            });

                            alert(
                                `You've reached the maximum for the current period!\n\n` +
                                `You've submitted ${progressData.contributionsThisPeriod} out of ${progressData.maxContributionsPerPeriod} ` +
                                `allowed contributions for Period ${progressData.currentPeriod}.\n\n` +
                                `Please wait until ${dateStr} to submit your next contribution.`
                            );
                            return;
                        }
                    } catch (error) {
                        console.error('Error checking contribution pacing:', error);
                        // Allow contribution to proceed if check fails
                    }
                }
            }

            // If admin, show the "contribute on behalf of" selector
            const adminSelector = document.getElementById('admin-contributor-selector');
            const behalfOfSelect = document.getElementById('behalf-of-user');

            if (currentUser && currentUser.role === 'admin') {
                adminSelector.style.display = 'block';

                // Populate team members dropdown
                try {
                    const db = window.firebaseApp.db;
                    const usersSnapshot = await db.collection('users')
                        .where('role', 'in', ['contributor', 'admin', 'alumni'])
                        .get();

                    // Clear existing options except the first one
                    behalfOfSelect.innerHTML = '<option value="">-- Select team member (or leave blank for yourself) --</option>';

                    // Add users sorted by name
                    const users = [];
                    usersSnapshot.forEach(doc => {
                        const userData = doc.data();
                        users.push({
                            email: doc.id,
                            name: userData.name || doc.id,
                            role: userData.role,
                            picture: userData.picture || ''
                        });
                    });

                    users.sort((a, b) => a.name.localeCompare(b.name));

                    users.forEach(user => {
                        const option = document.createElement('option');
                        option.value = JSON.stringify({ email: user.email, name: user.name, picture: user.picture });
                        option.textContent = `${user.name} (${user.role})`;
                        behalfOfSelect.appendChild(option);
                    });
                } catch (error) {
                    console.error('Error loading team members:', error);
                }
            } else {
                adminSelector.style.display = 'none';
            }

            currentStep = 1;
            document.getElementById('contribution-modal').style.display = 'flex';
            document.body.style.overflow = 'hidden';

            // Only reset form if not loading a draft
            if (!skipValidation) {
                document.getElementById('contribution-form').reset();
            }

            showStep(1);
        }

        function closeContributionModal() {
            document.getElementById('contribution-modal').style.display = 'none';
            document.body.style.overflow = 'auto';

            // Reset secondary categories
            document.getElementById('secondary-categories-container').innerHTML = '';
            secondaryCategoryCount = 0;
            document.getElementById('add-secondary-category-btn').style.display = 'block';

            // Reset draft ID
            currentDraftId = null;
        }

        // ============================================================================
        // DRAFT MANAGEMENT FUNCTIONS
        // ============================================================================

        let currentDraftId = null; // Track if we're editing an existing contribution draft
        let currentPerspectiveDraftId = null; // Track if we're editing an existing perspective draft
        let currentDraftsTab = 'contributions'; // Track which tab is active in drafts modal

        /**
         * Save contribution form as draft
         */
        async function saveContributionDraft() {
            const saveDraftBtn = document.getElementById('save-draft-btn');
            const originalContent = saveDraftBtn.innerHTML;

            try {
                // Show loading state
                saveDraftBtn.disabled = true;
                saveDraftBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';

                const form = document.getElementById('contribution-form');
                const formData = new FormData(form);

                // Collect form data
                const draftData = {
                    topic: formData.get('topic'),
                    subtopic: formData.get('subtopic'),
                    authors: document.getElementById('authors').value,
                    year: document.getElementById('year').value,
                    title: document.getElementById('title').value,
                    pubType: document.getElementById('pub-type').value,
                    journal: document.getElementById('journal')?.value || '',
                    volume: document.getElementById('volume')?.value || '',
                    pages: document.getElementById('pages')?.value || '',
                    publisher: document.getElementById('publisher')?.value || '',
                    editors: document.getElementById('editors')?.value || '',
                    bookTitle: document.getElementById('book-title')?.value || '',
                    conference: document.getElementById('conference')?.value || '',
                    preprint: document.getElementById('preprint')?.value || '',
                    reportNumber: document.getElementById('report-number')?.value || '',
                    reportInstitution: document.getElementById('report-institution')?.value || '',
                    thesis: document.getElementById('thesis')?.value || '',
                    doi: document.getElementById('doi')?.value || '',
                    url: document.getElementById('url-input')?.value || '',
                    summary: document.getElementById('summary').value,
                    behalfOf: document.getElementById('behalf-of-user').value,
                    secondaryCategories: getSecondaryCategories(),
                    currentStep: currentStep
                };

                // Generate title for draft
                const title = draftData.title || 'Untitled contribution';

                // Save draft to Firebase
                const saveDraftFunc = firebase.functions().httpsCallable('saveDraft');
                const result = await saveDraftFunc({
                    draftId: currentDraftId,
                    draftType: 'contribution',
                    draftData: draftData,
                    title: title
                });

                if (result.data.success) {
                    currentDraftId = result.data.draftId;
                    alert('âœ“ Draft saved successfully!');
                }
            } catch (error) {
                console.error('Error saving draft:', error);
                alert('Failed to save draft. Please try again.');
            } finally {
                // Restore button state
                saveDraftBtn.disabled = false;
                saveDraftBtn.innerHTML = originalContent;
            }
        }

        /**
         * Save perspective form as draft
         */
        async function savePerspectiveDraft(event) {
            const saveDraftBtn = event ? event.target : event;
            const originalContent = saveDraftBtn ? saveDraftBtn.innerHTML : '<i class="fas fa-save"></i> Save Draft';

            try {
                const entryId = document.getElementById('perspective-entry-id').value;
                const perspectiveText = document.getElementById('perspective-text').value;
                const behalfOf = document.getElementById('perspective-behalf-of-user').value;

                if (!perspectiveText || perspectiveText.length < 50) {
                    alert('Please write at least 50 characters before saving as draft.');
                    return;
                }

                // Show loading state
                if (saveDraftBtn) {
                    saveDraftBtn.disabled = true;
                    saveDraftBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
                }

                // Get source info for title
                const sourceInfo = document.getElementById('perspective-source-info').textContent;

                const draftData = {
                    entryId: entryId,
                    perspectiveText: perspectiveText,
                    behalfOf: behalfOf,
                    sourceInfo: sourceInfo
                };

                const title = sourceInfo.substring(0, 60) + '...';

                // Save draft to Firebase
                const saveDraftFunc = firebase.functions().httpsCallable('saveDraft');
                const result = await saveDraftFunc({
                    draftId: currentPerspectiveDraftId,
                    draftType: 'perspective',
                    draftData: draftData,
                    title: title
                });

                if (result.data.success) {
                    currentPerspectiveDraftId = result.data.draftId;
                    alert('âœ“ Draft saved successfully!');
                }
            } catch (error) {
                console.error('Error saving draft:', error);
                alert('Failed to save draft. Please try again.');
            } finally {
                // Restore button state
                if (saveDraftBtn) {
                    saveDraftBtn.disabled = false;
                    saveDraftBtn.innerHTML = originalContent;
                }
            }
        }

        /**
         * Open My Drafts modal
         */
        async function openMyDrafts() {
            document.getElementById('my-drafts-modal').style.display = 'flex';
            document.body.style.overflow = 'hidden';
            currentDraftsTab = 'contributions';
            await loadDrafts('contribution'); // Use singular form to match draftType
        }

        /**
         * Close My Drafts modal
         */
        function closeMyDrafts() {
            document.getElementById('my-drafts-modal').style.display = 'none';
            document.body.style.overflow = 'auto';
        }

        /**
         * Switch between drafts tabs
         */
        async function switchDraftsTab(tab) {
            currentDraftsTab = tab;

            // Update tab styling
            const contributionsTab = document.getElementById('drafts-contributions-tab');
            const perspectivesTab = document.getElementById('drafts-perspectives-tab');

            if (tab === 'contributions') {
                contributionsTab.style.borderBottom = '3px solid #57068c';
                contributionsTab.style.color = '#57068c';
                perspectivesTab.style.borderBottom = '3px solid transparent';
                perspectivesTab.style.color = '#666';
            } else {
                perspectivesTab.style.borderBottom = '3px solid #57068c';
                perspectivesTab.style.color = '#57068c';
                contributionsTab.style.borderBottom = '3px solid transparent';
                contributionsTab.style.color = '#666';
            }

            // Convert plural tab name to singular draftType
            const draftType = tab === 'contributions' ? 'contribution' : 'perspective';
            await loadDrafts(draftType);
        }

        /**
         * Load drafts from Firebase
         */
        async function loadDrafts(draftType) {
            const loadingEl = document.getElementById('drafts-loading');
            const emptyEl = document.getElementById('drafts-empty');
            const listEl = document.getElementById('drafts-list');

            loadingEl.style.display = 'block';
            emptyEl.style.display = 'none';
            listEl.style.display = 'none';

            try {
                const getDraftsFunc = firebase.functions().httpsCallable('getDrafts');
                const result = await getDraftsFunc({ draftType: draftType });

                loadingEl.style.display = 'none';

                if (!result.data.drafts || result.data.drafts.length === 0) {
                    emptyEl.style.display = 'block';
                    return;
                }

                // Display drafts
                listEl.innerHTML = '';
                result.data.drafts.forEach(draft => {
                    const draftCard = createDraftCard(draft);
                    listEl.appendChild(draftCard);
                });

                listEl.style.display = 'grid';
            } catch (error) {
                console.error('Error loading drafts:', error);
                loadingEl.style.display = 'none';
                emptyEl.style.display = 'block';
                emptyEl.innerHTML = '<p style="color: #dc3545;">Failed to load drafts. Please try again.</p>';
            }
        }

        /**
         * Create draft card element
         */
        function createDraftCard(draft) {
            const card = document.createElement('div');
            card.style.cssText = 'padding: 20px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #57068c;';

            const updatedDate = new Date(draft.updatedAt).toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });

            card.innerHTML = `
                <div style="margin-bottom: 15px;">
                    <h4 style="margin: 0 0 5px 0; color: #2d2d2d; font-size: 1rem;">${draft.title}</h4>
                    <p style="margin: 0; color: #666; font-size: 0.85rem;">
                        <i class="fas fa-clock"></i> Last updated: ${updatedDate}
                    </p>
                </div>
                <div style="display: flex; gap: 10px;">
                    <button onclick="loadDraftIntoForm('${draft.id}', '${draft.draftType}')"
                            style="flex: 1; padding: 8px 16px; background: #57068c; color: white; border: none; border-radius: 4px; cursor: pointer; font-family: 'Montserrat', sans-serif; font-weight: 600;">
                        <i class="fas fa-edit"></i> Continue Editing
                    </button>
                    <button onclick="confirmDeleteDraft('${draft.id}')"
                            style="padding: 8px 16px; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer; font-family: 'Montserrat', sans-serif; font-weight: 600;">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            `;

            return card;
        }

        /**
         * Load a draft into its corresponding form
         */
        async function loadDraftIntoForm(draftId, draftType) {
            try {
                // Fetch the specific draft
                const getDraftsFunc = firebase.functions().httpsCallable('getDrafts');
                const result = await getDraftsFunc({});
                const draft = result.data.drafts.find(d => d.id === draftId);

                if (!draft) {
                    alert('Draft not found.');
                    return;
                }

                // Close drafts modal
                closeMyDrafts();

                if (draftType === 'contribution') {
                    // Open contribution modal and populate
                    currentDraftId = draftId;
                    await openContributionModal(true); // Skip validation when loading draft

                    // Wait for modal to open
                    setTimeout(() => {
                        const data = draft.draftData;

                        // Populate form fields
                        if (data.topic) {
                            document.querySelector(`input[name="topic"][value="${data.topic}"]`)?.click();
                        }
                        if (data.subtopic) {
                            setTimeout(() => {
                                document.getElementById('subtopic-select').value = data.subtopic;
                            }, 100);
                        }
                        if (data.authors) document.getElementById('authors').value = data.authors;
                        if (data.year) document.getElementById('year').value = data.year;
                        if (data.title) document.getElementById('title').value = data.title;
                        if (data.pubType) {
                            document.getElementById('pub-type').value = data.pubType;
                            togglePublicationFields();
                        }
                        if (data.journal) document.getElementById('journal').value = data.journal;
                        if (data.volume) document.getElementById('volume').value = data.volume;
                        if (data.pages) document.getElementById('pages').value = data.pages;
                        if (data.publisher) document.getElementById('publisher').value = data.publisher;
                        if (data.editors) document.getElementById('editors').value = data.editors;
                        if (data.bookTitle) document.getElementById('book-title').value = data.bookTitle;
                        if (data.conference) document.getElementById('conference').value = data.conference;
                        if (data.preprint) document.getElementById('preprint').value = data.preprint;
                        if (data.reportNumber) document.getElementById('report-number').value = data.reportNumber;
                        if (data.reportInstitution) document.getElementById('report-institution').value = data.reportInstitution;
                        if (data.thesis) document.getElementById('thesis').value = data.thesis;
                        if (data.doi) document.getElementById('doi').value = data.doi;
                        if (data.url) document.getElementById('url-input').value = data.url;
                        if (data.summary) document.getElementById('summary').value = data.summary;
                        if (data.behalfOf) document.getElementById('behalf-of-user').value = data.behalfOf;

                        // Restore secondary categories
                        if (data.secondaryCategories && Array.isArray(data.secondaryCategories)) {
                            // Clear existing secondary categories
                            document.getElementById('secondary-categories-container').innerHTML = '';
                            secondaryCategoryCount = 0;
                            document.getElementById('add-secondary-category-btn').style.display = 'block';

                            // Add each secondary category
                            data.secondaryCategories.forEach((category, index) => {
                                addSecondaryCategory();
                                // Wait a bit for the category to be added to the DOM
                                setTimeout(() => {
                                    const topicSelect = document.querySelector(`.secondary-topic[data-index="${index + 1}"]`);
                                    const subtopicSelect = document.querySelector(`.secondary-subtopic[data-index="${index + 1}"]`);

                                    if (topicSelect && category.topic) {
                                        topicSelect.value = category.topic;
                                        updateSecondarySubtopics(index + 1);

                                        // Wait for subtopics to populate
                                        setTimeout(() => {
                                            if (subtopicSelect && category.subtopic) {
                                                subtopicSelect.value = category.subtopic;
                                            }
                                        }, 50);
                                    }
                                }, 50 * (index + 1));
                            });
                        }

                        // Restore step
                        if (data.currentStep) {
                            showStep(data.currentStep);
                        }
                    }, 200);

                } else if (draftType === 'perspective') {
                    // Set the perspective draft ID for tracking
                    currentPerspectiveDraftId = draftId;

                    // Open perspective modal and populate
                    setTimeout(() => {
                        const data = draft.draftData;
                        document.getElementById('perspective-entry-id').value = data.entryId;
                        document.getElementById('perspective-text').value = data.perspectiveText;
                        if (data.behalfOf) document.getElementById('perspective-behalf-of-user').value = data.behalfOf;
                        document.getElementById('perspective-source-info').textContent = data.sourceInfo;

                        document.getElementById('add-perspective-modal').style.display = 'flex';
                        document.body.style.overflow = 'hidden';
                    }, 200);
                }
            } catch (error) {
                console.error('Error loading draft:', error);
                alert('Failed to load draft. Please try again.');
            }
        }

        /**
         * Confirm and delete a draft
         */
        async function confirmDeleteDraft(draftId) {
            if (!confirm('Are you sure you want to delete this draft?')) {
                return;
            }

            try {
                const deleteDraftFunc = firebase.functions().httpsCallable('deleteDraft');
                await deleteDraftFunc({ draftId: draftId });

                alert('âœ“ Draft deleted successfully!');
                await loadDrafts(currentDraftsTab);
            } catch (error) {
                console.error('Error deleting draft:', error);
                alert('Failed to delete draft. Please try again.');
            }
        }

        // ============================================================================
        // END DRAFT MANAGEMENT FUNCTIONS
        // ============================================================================

        function updateContributorPreview() {
            const select = document.getElementById('behalf-of-user');
            const img = document.getElementById('contributor-preview-img');

            if (select.value) {
                try {
                    const userData = JSON.parse(select.value);
                    if (userData.picture) {
                        img.src = userData.picture;
                        img.style.display = 'block';
                    } else {
                        img.style.display = 'none';
                    }
                } catch (e) {
                    img.style.display = 'none';
                }
            } else {
                img.style.display = 'none';
            }
        }

        function updatePerspectivePreview() {
            const select = document.getElementById('perspective-behalf-of-user');
            const img = document.getElementById('perspective-preview-img');

            if (select.value) {
                try {
                    const userData = JSON.parse(select.value);
                    if (userData.picture) {
                        img.src = userData.picture;
                        img.style.display = 'block';
                    } else {
                        img.style.display = 'none';
                    }
                } catch (e) {
                    img.style.display = 'none';
                }
            } else {
                img.style.display = 'none';
            }
        }

        function updateSubtopicOptions() {
            const selectedTopic = document.querySelector('input[name="topic"]:checked').value;
            const subtopicSelect = document.getElementById('subtopic-select');
            const subtopicSection = document.getElementById('subtopic-section');

            // Clear existing options
            subtopicSelect.innerHTML = '<option value="">-- Select a subtopic --</option>';

            // Add subtopics for selected topic
            subtopics[selectedTopic].forEach(subtopic => {
                const option = document.createElement('option');
                option.value = subtopic.value;
                option.textContent = subtopic.label;
                subtopicSelect.appendChild(option);
            });

            // Show subtopic section
            subtopicSection.style.display = 'block';

            // If innovating-edtech is selected, populate the EdTech categories checklist
            if (selectedTopic === 'innovating-edtech') {
                populateEdTechCategories();
            }
        }

        // EdTech-specific functions
        function populateEdTechCategories() {
            const container = document.getElementById('edtech-categories-checklist');
            container.innerHTML = '';

            subtopics['innovating-edtech'].forEach(category => {
                const checkboxDiv = document.createElement('div');
                checkboxDiv.style.cssText = 'padding: 10px; background: white; border: 1px solid #ddd; border-radius: 4px;';

                const label = document.createElement('label');
                label.style.cssText = 'display: flex; align-items: center; cursor: pointer;';

                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.value = category.value;
                checkbox.className = 'edtech-category-checkbox';
                checkbox.onchange = handleEdTechCategorySelection;
                checkbox.style.cssText = 'margin-right: 10px; width: 18px; height: 18px; cursor: pointer;';

                const labelText = document.createElement('span');
                labelText.textContent = category.label;
                labelText.style.color = '#2d2d2d';

                label.appendChild(checkbox);
                label.appendChild(labelText);
                checkboxDiv.appendChild(label);
                container.appendChild(checkboxDiv);
            });
        }

        function handleEdTechCategorySelection() {
            const checkboxes = document.querySelectorAll('.edtech-category-checkbox');
            const checkedCount = Array.from(checkboxes).filter(cb => cb.checked).length;
            const warning = document.getElementById('category-limit-warning');

            if (checkedCount > 3) {
                this.checked = false;
                warning.style.display = 'block';
            } else {
                warning.style.display = 'none';
            }
        }

        function isEdTechContribution() {
            const selectedTopic = document.querySelector('input[name="topic"]:checked');
            return selectedTopic && selectedTopic.value === 'innovating-edtech';
        }

        function togglePublicationFields() {
            const pubType = document.getElementById('pub-type').value;

            // Hide all fields first
            document.getElementById('journal-fields').style.display = 'none';
            document.getElementById('book-fields').style.display = 'none';
            document.getElementById('chapter-fields').style.display = 'none';

            // Remove required from all conditional fields
            ['journal', 'publisher', 'book-title', 'chapter-publisher'].forEach(id => {
                const field = document.getElementById(id);
                if (field) field.removeAttribute('required');
            });

            // Show and set required for appropriate fields
            if (pubType === 'journal' || pubType === 'conference') {
                document.getElementById('journal-fields').style.display = 'block';
                document.getElementById('journal').setAttribute('required', 'required');
            } else if (pubType === 'book') {
                document.getElementById('book-fields').style.display = 'block';
                document.getElementById('publisher').setAttribute('required', 'required');
            } else if (pubType === 'chapter') {
                document.getElementById('chapter-fields').style.display = 'block';
                document.getElementById('book-title').setAttribute('required', 'required');
                document.getElementById('chapter-publisher').setAttribute('required', 'required');
            }

            // Handle URL required for website
            const urlField = document.getElementById('url');
            const urlRequired = document.getElementById('url-required');
            if (pubType === 'website') {
                urlField.setAttribute('required', 'required');
                urlRequired.style.display = 'inline';
            } else {
                urlField.removeAttribute('required');
                urlRequired.style.display = 'none';
            }
        }

        function showStep(step) {
            // Determine if this is an EdTech contribution
            const isEdTech = isEdTechContribution();

            // Hide all steps (both regular and EdTech)
            const allSteps = ['category', 'bibliography', 'summary', 'edtech-product', 'edtech-analysis'];
            allSteps.forEach(stepId => {
                const stepElement = document.getElementById(`step-${stepId}`);
                if (stepElement) stepElement.style.display = 'none';
            });

            // Manage required attributes based on contribution type
            if (isEdTech) {
                // EdTech: Remove required from bibliography/summary fields, add to EdTech fields
                ['authors', 'year', 'title', 'pub-type', 'summary'].forEach(id => {
                    const field = document.getElementById(id);
                    if (field) field.removeAttribute('required');
                });

                // EdTech fields are validated manually in goNextStep, so they don't need required attribute
            } else {
                // Regular research: Add required to bibliography/summary fields, remove from EdTech fields
                document.getElementById('authors')?.setAttribute('required', 'required');
                document.getElementById('year')?.setAttribute('required', 'required');
                document.getElementById('title')?.setAttribute('required', 'required');
                document.getElementById('pub-type')?.setAttribute('required', 'required');
                document.getElementById('summary')?.setAttribute('required', 'required');

                // Remove required from EdTech fields
                ['edtech-product-name', 'edtech-product-url'].forEach(id => {
                    const field = document.getElementById(id);
                    if (field) field.removeAttribute('required');
                });
            }

            // Define step mapping based on contribution type
            let stepMapping;
            if (isEdTech) {
                stepMapping = ['category', 'edtech-product', 'edtech-analysis'];
            } else {
                stepMapping = ['category', 'bibliography', 'summary'];
            }

            // Show current step
            const currentStepElement = document.getElementById(`step-${stepMapping[step-1]}`);
            if (currentStepElement) currentStepElement.style.display = 'block';

            // Update buttons
            document.getElementById('back-btn').style.display = step > 1 ? 'block' : 'none';
            document.getElementById('next-btn').style.display = step < totalSteps ? 'block' : 'none';
            document.getElementById('submit-btn').style.display = step === totalSteps ? 'block' : 'none';
            document.getElementById('save-draft-btn').style.display = 'block'; // Always show save draft

            currentStep = step;
        }

        function goNextStep() {
            const isEdTech = isEdTechContribution();

            // Validate current step before proceeding
            if (currentStep === 1) {
                // Validate topic selection
                const topicSelected = document.querySelector('input[name="topic"]:checked');
                if (!topicSelected) {
                    alert('Please select a topic');
                    return;
                }
                // Validate subtopic selection
                const subtopic = document.getElementById('subtopic-select').value;
                if (!subtopic) {
                    alert('Please select a subtopic');
                    return;
                }
            } else if (currentStep === 2) {
                if (isEdTech) {
                    // Validate EdTech product fields
                    const productName = document.getElementById('edtech-product-name').value.trim();
                    if (!productName) {
                        alert('Please enter the product name');
                        document.getElementById('edtech-product-name').focus();
                        return;
                    }

                    // Validate at least one category is selected
                    const checkedCategories = document.querySelectorAll('.edtech-category-checkbox:checked');
                    if (checkedCategories.length === 0) {
                        alert('Please select at least one product category');
                        return;
                    }
                } else {
                    // Validate bibliography fields
                    const required = ['authors', 'year', 'title', 'pub-type'];
                    const pubType = document.getElementById('pub-type').value;

                    for (let fieldId of required) {
                        const field = document.getElementById(fieldId);
                        if (!field.value) {
                            alert('Please fill in all required bibliographic fields');
                            field.focus();
                            return;
                        }
                    }

                    // Validate pub-type specific required fields
                    if (pubType === 'journal' && !document.getElementById('journal').value) {
                        alert('Please enter the journal name');
                        return;
                    }
                    if ((pubType === 'book' || pubType === 'report') && !document.getElementById('publisher').value) {
                        alert('Please enter the publisher');
                        return;
                    }
                    if (pubType === 'chapter') {
                        if (!document.getElementById('book-title').value || !document.getElementById('chapter-publisher').value) {
                            alert('Please fill in all required chapter fields');
                            return;
                        }
                    }
                    if (pubType === 'website' && !document.getElementById('url').value) {
                        alert('Please enter the URL for the website');
                        return;
                    }
                }
            }

            if (currentStep < totalSteps) {
                showStep(currentStep + 1);
            }
        }

        function goBackStep() {
            if (currentStep > 1) {
                showStep(currentStep - 1);
            }
        }

        // DOI Auto-fill Functions
        function showManualEntry() {
            // Just scroll down to the manual fields
            document.getElementById('manual-bibliography-fields').scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        async function fetchFromDOI() {
            const input = document.getElementById('doi-autofill-input').value.trim();

            if (!input) {
                alert('Please enter a DOI');
                return;
            }

            // Extract DOI from URL or use as-is
            let doi = input;
            if (input.includes('doi.org/')) {
                const match = input.match(/doi\.org\/(.+?)(?:\?|#|$)/);
                if (match && match[1]) {
                    doi = match[1].trim();
                }
            } else {
                doi = input.replace(/^doi:\s*/i, '').trim();
            }

            // Show loading state
            document.getElementById('doi-loading').style.display = 'block';
            document.getElementById('doi-success').style.display = 'none';
            document.getElementById('doi-error').style.display = 'none';
            document.getElementById('fetch-doi-btn').disabled = true;

            try {
                // Try CrossRef API first
                const crossrefResponse = await fetch(`https://api.crossref.org/works/${encodeURIComponent(doi)}`, {
                    headers: {
                        'Accept': 'application/json'
                    }
                });

                if (crossrefResponse.ok) {
                    // CrossRef success
                    const data = await crossrefResponse.json();
                    const work = data.message;
                    populateBibliographyFields(work, doi);

                    document.getElementById('doi-loading').style.display = 'none';
                    document.getElementById('doi-success').style.display = 'block';
                    document.getElementById('fetch-doi-btn').disabled = false;
                } else {
                    // CrossRef failed, try DataCite (for arXiv, datasets, etc.)
                    console.log('CrossRef failed, trying DataCite...');
                    const dataciteResponse = await fetch(`https://api.datacite.org/dois/${encodeURIComponent(doi)}`, {
                        headers: {
                            'Accept': 'application/json'
                        }
                    });

                    if (!dataciteResponse.ok) {
                        throw new Error(`Both CrossRef and DataCite APIs failed`);
                    }

                    const dataciteData = await dataciteResponse.json();
                    populateBibliographyFieldsFromDataCite(dataciteData.data, doi);

                    document.getElementById('doi-loading').style.display = 'none';
                    document.getElementById('doi-success').style.display = 'block';
                    document.getElementById('fetch-doi-btn').disabled = false;
                }

            } catch (error) {
                console.error('DOI fetch error:', error);
                document.getElementById('doi-loading').style.display = 'none';
                document.getElementById('doi-error').style.display = 'block';
                document.getElementById('doi-error-message').textContent = `Could not fetch data: ${error.message}. Please enter manually below.`;
                document.getElementById('fetch-doi-btn').disabled = false;
            }
        }

        function populateBibliographyFields(work, doi) {
            // Authors
            if (work.author && work.author.length > 0) {
                const authors = work.author.map(a => {
                    if (a.family && a.given) {
                        return `${a.family}, ${a.given.charAt(0)}.`;
                    } else if (a.family) {
                        return a.family;
                    }
                    return '';
                }).filter(a => a).join(', & ');
                document.getElementById('authors').value = authors;
            }

            // Year
            if (work.published) {
                const dateparts = work.published['date-parts'];
                if (dateparts && dateparts[0] && dateparts[0][0]) {
                    document.getElementById('year').value = dateparts[0][0];
                }
            } else if (work['published-online']) {
                const dateparts = work['published-online']['date-parts'];
                if (dateparts && dateparts[0] && dateparts[0][0]) {
                    document.getElementById('year').value = dateparts[0][0];
                }
            }

            // Title
            if (work.title && work.title[0]) {
                document.getElementById('title').value = work.title[0];
            }

            // Publication type mapping
            const typeMap = {
                'journal-article': 'journal',
                'book': 'book',
                'book-chapter': 'chapter',
                'proceedings-article': 'conference',
                'posted-content': 'preprint'
            };
            const pubType = typeMap[work.type] || 'journal';
            document.getElementById('pub-type').value = pubType;

            // Trigger the change event to show appropriate fields
            togglePublicationFields();

            // Journal-specific fields
            if (pubType === 'journal' || pubType === 'conference') {
                if (work['container-title'] && work['container-title'][0]) {
                    document.getElementById('journal').value = work['container-title'][0];
                }
                if (work.volume) {
                    document.getElementById('volume').value = work.volume.toString();
                }
                if (work.issue) {
                    document.getElementById('issue').value = work.issue.toString();
                }
                if (work.page) {
                    document.getElementById('pages').value = work.page;
                }
            }

            // Book-specific fields
            if (pubType === 'book') {
                if (work.publisher) {
                    document.getElementById('publisher').value = work.publisher;
                }
            }

            // Chapter-specific fields
            if (pubType === 'chapter') {
                if (work['container-title'] && work['container-title'][0]) {
                    document.getElementById('book-title').value = work['container-title'][0];
                }
                if (work.publisher) {
                    document.getElementById('chapter-publisher').value = work.publisher;
                }
                if (work.page) {
                    document.getElementById('chapter-pages').value = work.page;
                }
            }

            // URL
            if (work.URL) {
                document.getElementById('url').value = work.URL;
            } else if (doi) {
                document.getElementById('url').value = `https://doi.org/${doi}`;
            }

            // DOI
            document.getElementById('doi').value = work.DOI || doi;
        }

        function populateBibliographyFieldsFromDataCite(data, doi) {
            const attrs = data.attributes;

            // Authors
            if (attrs.creators && attrs.creators.length > 0) {
                const authors = attrs.creators.map(a => {
                    if (a.familyName && a.givenName) {
                        return `${a.familyName}, ${a.givenName.charAt(0)}.`;
                    } else if (a.name) {
                        return a.name;
                    }
                    return '';
                }).filter(a => a).join(', & ');
                document.getElementById('authors').value = authors;
            }

            // Year
            if (attrs.publicationYear) {
                document.getElementById('year').value = attrs.publicationYear;
            }

            // Title
            if (attrs.titles && attrs.titles[0]) {
                document.getElementById('title').value = attrs.titles[0].title;
            }

            // Publication type - DataCite uses different type names
            const typeMap = {
                'JournalArticle': 'journal',
                'Book': 'book',
                'BookChapter': 'chapter',
                'ConferencePaper': 'conference',
                'Preprint': 'preprint',
                'Report': 'report',
                'Dataset': 'other',
                'Software': 'other'
            };
            const resourceType = attrs.types?.resourceTypeGeneral || 'Text';
            const pubType = typeMap[resourceType] || 'preprint'; // Default to preprint for arXiv/etc
            document.getElementById('pub-type').value = pubType;

            // Trigger the change event to show appropriate fields
            togglePublicationFields();

            // Container/Journal info
            if (attrs.container && attrs.container.title) {
                document.getElementById('journal').value = attrs.container.title;
            }

            // Publisher
            if (attrs.publisher) {
                if (pubType === 'book') {
                    document.getElementById('publisher').value = attrs.publisher;
                } else if (pubType === 'chapter') {
                    document.getElementById('chapter-publisher').value = attrs.publisher;
                } else {
                    // For preprints/reports, put publisher in journal field if not already filled
                    if (!document.getElementById('journal').value) {
                        document.getElementById('journal').value = attrs.publisher;
                    }
                }
            }

            // URL
            if (attrs.url) {
                document.getElementById('url').value = attrs.url;
            } else if (doi) {
                document.getElementById('url').value = `https://doi.org/${doi}`;
            }

            // DOI
            document.getElementById('doi').value = attrs.doi || doi;
        }

        // DOI Auto-fill for Edit Modal
        async function fetchFromDOIEdit() {
            const input = document.getElementById('edit-doi-autofill-input').value.trim();

            if (!input) {
                alert('Please enter a DOI');
                return;
            }

            // Extract DOI from URL or use as-is
            let doi = input;
            if (input.includes('doi.org/')) {
                const match = input.match(/doi\.org\/(.+?)(?:\?|#|$)/);
                if (match && match[1]) {
                    doi = match[1].trim();
                }
            } else {
                doi = input.replace(/^doi:\s*/i, '').trim();
            }

            // Show loading state
            document.getElementById('edit-doi-loading').style.display = 'block';
            document.getElementById('edit-doi-success').style.display = 'none';
            document.getElementById('edit-doi-error').style.display = 'none';
            document.getElementById('edit-fetch-doi-btn').disabled = true;

            try {
                // Try CrossRef API first
                const crossrefResponse = await fetch(`https://api.crossref.org/works/${encodeURIComponent(doi)}`, {
                    headers: {
                        'Accept': 'application/json'
                    }
                });

                if (crossrefResponse.ok) {
                    // CrossRef success
                    const data = await crossrefResponse.json();
                    const work = data.message;
                    populateEditBibliographyFields(work, doi);

                    document.getElementById('edit-doi-loading').style.display = 'none';
                    document.getElementById('edit-doi-success').style.display = 'block';
                    document.getElementById('edit-fetch-doi-btn').disabled = false;
                } else {
                    // CrossRef failed, try DataCite (for arXiv, datasets, etc.)
                    console.log('CrossRef failed, trying DataCite for edit...');
                    const dataciteResponse = await fetch(`https://api.datacite.org/dois/${encodeURIComponent(doi)}`, {
                        headers: {
                            'Accept': 'application/json'
                        }
                    });

                    if (!dataciteResponse.ok) {
                        throw new Error(`Both CrossRef and DataCite APIs failed`);
                    }

                    const dataciteData = await dataciteResponse.json();
                    populateEditBibliographyFieldsFromDataCite(dataciteData.data, doi);

                    document.getElementById('edit-doi-loading').style.display = 'none';
                    document.getElementById('edit-doi-success').style.display = 'block';
                    document.getElementById('edit-fetch-doi-btn').disabled = false;
                }

            } catch (error) {
                console.error('DOI fetch error:', error);
                document.getElementById('edit-doi-loading').style.display = 'none';
                document.getElementById('edit-doi-error').style.display = 'block';
                document.getElementById('edit-doi-error-message').textContent = `Could not fetch data: ${error.message}`;
                document.getElementById('edit-fetch-doi-btn').disabled = false;
            }
        }

        function populateEditBibliographyFields(work, doi) {
            // Authors
            if (work.author && work.author.length > 0) {
                const authors = work.author.map(a => {
                    if (a.family && a.given) {
                        return `${a.family}, ${a.given.charAt(0)}.`;
                    } else if (a.family) {
                        return a.family;
                    }
                    return '';
                }).filter(a => a).join(', & ');
                document.getElementById('edit-bib-authors').value = authors;
            }

            // Year
            if (work.published) {
                const dateparts = work.published['date-parts'];
                if (dateparts && dateparts[0] && dateparts[0][0]) {
                    document.getElementById('edit-bib-year').value = dateparts[0][0];
                }
            } else if (work['published-online']) {
                const dateparts = work['published-online']['date-parts'];
                if (dateparts && dateparts[0] && dateparts[0][0]) {
                    document.getElementById('edit-bib-year').value = dateparts[0][0];
                }
            }

            // Title
            if (work.title && work.title[0]) {
                document.getElementById('edit-bib-title').value = work.title[0];
            }

            // Publication type mapping
            const typeMap = {
                'journal-article': 'journal',
                'book': 'book',
                'book-chapter': 'chapter',
                'proceedings-article': 'conference',
                'posted-content': 'preprint'
            };
            const pubType = typeMap[work.type] || 'journal';
            document.getElementById('edit-bib-pubtype').value = pubType;

            // Trigger the change event to show appropriate fields
            updateEditPubTypeFields();

            // Journal-specific fields
            if (pubType === 'journal') {
                if (work['container-title'] && work['container-title'][0]) {
                    document.getElementById('edit-bib-journal').value = work['container-title'][0];
                }
                if (work.volume) {
                    document.getElementById('edit-bib-volume').value = work.volume.toString();
                }
                if (work.issue) {
                    document.getElementById('edit-bib-issue').value = work.issue.toString();
                }
                if (work.page) {
                    document.getElementById('edit-bib-pages').value = work.page;
                }
            }

            // Book-specific fields
            if (pubType === 'book') {
                if (work.publisher) {
                    document.getElementById('edit-bib-publisher').value = work.publisher;
                }
            }

            // Chapter-specific fields
            if (pubType === 'chapter') {
                if (work['container-title'] && work['container-title'][0]) {
                    document.getElementById('edit-bib-booktitle').value = work['container-title'][0];
                }
                if (work.publisher) {
                    document.getElementById('edit-bib-chapter-publisher').value = work.publisher;
                }
                if (work.page) {
                    document.getElementById('edit-bib-chapter-pages').value = work.page;
                }
            }

            // URL
            if (work.URL) {
                document.getElementById('edit-bib-url').value = work.URL;
            } else if (doi) {
                document.getElementById('edit-bib-url').value = `https://doi.org/${doi}`;
            }

            // DOI
            if (document.getElementById('edit-bib-doi')) {
                document.getElementById('edit-bib-doi').value = work.DOI || doi;
            }
        }

        function populateEditBibliographyFieldsFromDataCite(data, doi) {
            const attrs = data.attributes;

            // Authors
            if (attrs.creators && attrs.creators.length > 0) {
                const authors = attrs.creators.map(a => {
                    if (a.familyName && a.givenName) {
                        return `${a.familyName}, ${a.givenName.charAt(0)}.`;
                    } else if (a.name) {
                        return a.name;
                    }
                    return '';
                }).filter(a => a).join(', & ');
                document.getElementById('edit-bib-authors').value = authors;
            }

            // Year
            if (attrs.publicationYear) {
                document.getElementById('edit-bib-year').value = attrs.publicationYear;
            }

            // Title
            if (attrs.titles && attrs.titles[0]) {
                document.getElementById('edit-bib-title').value = attrs.titles[0].title;
            }

            // Publication type
            const typeMap = {
                'JournalArticle': 'journal',
                'Book': 'book',
                'BookChapter': 'chapter',
                'ConferencePaper': 'conference',
                'Preprint': 'preprint',
                'Report': 'report',
                'Dataset': 'other',
                'Software': 'other'
            };
            const resourceType = attrs.types?.resourceTypeGeneral || 'Text';
            const pubType = typeMap[resourceType] || 'preprint'; // Default to preprint for arXiv/etc
            document.getElementById('edit-bib-pubtype').value = pubType;

            // Trigger the change event to show appropriate fields
            updateEditPubTypeFields();

            // Container/Journal info
            if (attrs.container && attrs.container.title) {
                document.getElementById('edit-bib-journal').value = attrs.container.title;
            }

            // Publisher
            if (attrs.publisher) {
                if (pubType === 'book' && document.getElementById('edit-bib-publisher')) {
                    document.getElementById('edit-bib-publisher').value = attrs.publisher;
                } else if (pubType === 'chapter' && document.getElementById('edit-bib-chapter-publisher')) {
                    document.getElementById('edit-bib-chapter-publisher').value = attrs.publisher;
                } else {
                    // For preprints/reports, put publisher in journal field if not already filled
                    if (!document.getElementById('edit-bib-journal').value) {
                        document.getElementById('edit-bib-journal').value = attrs.publisher;
                    }
                }
            }

            // URL
            if (attrs.url) {
                document.getElementById('edit-bib-url').value = attrs.url;
            } else if (doi) {
                document.getElementById('edit-bib-url').value = `https://doi.org/${doi}`;
            }

            // DOI
            if (document.getElementById('edit-bib-doi')) {
                document.getElementById('edit-bib-doi').value = attrs.doi || doi;
            }
        }

        async function submitContribution(event) {
            event.preventDefault();

            const isEdTech = isEdTechContribution();

            // Remove 'required' from fields in hidden steps to prevent validation errors
            const hiddenSteps = document.querySelectorAll('.contribution-step[style*="display: none"]');
            hiddenSteps.forEach(step => {
                step.querySelectorAll('[required]').forEach(field => {
                    field.removeAttribute('required');
                });
            });

            // Get form data
            const primaryTopic = document.querySelector('input[name="topic"]:checked').value;
            const primarySubtopic = document.getElementById('subtopic-select').value;
            const secondaryCategories = getSecondaryCategories();

            // Validate based on contribution type
            if (isEdTech) {
                // Validate EdTech required fields
                const requiredFields = [
                    { id: 'edtech-product-name', name: 'Product Name' },
                    { id: 'edtech-target-consumers', name: 'Target Consumers' },
                    { id: 'edtech-pain-point', name: 'Pain Point' },
                    { id: 'edtech-business-model', name: 'Business Model' },
                    { id: 'edtech-economic-model', name: 'Economic Model' },
                    { id: 'edtech-differentiators', name: 'Key Differentiators' },
                    { id: 'edtech-affordances', name: 'Affordances' },
                    { id: 'edtech-limitations', name: 'Limitations' }
                ];

                for (let field of requiredFields) {
                    const value = document.getElementById(field.id).value.trim();
                    if (!value) {
                        alert(`Please fill in the ${field.name} field`);
                        document.getElementById(field.id).focus();
                        return;
                    }
                }
            } else {
                // Validate summary length for non-EdTech
                const summary = document.getElementById('summary').value;
                if (summary.length < 100) {
                    alert('Summary must be at least 100 characters');
                    return;
                }
            }

            // Determine who to attribute the contribution to
            let contributorEmail, contributorName, contributorPicture;
            const behalfOfSelect = document.getElementById('behalf-of-user');
            const currentUser = window.auth.getCurrentUser();

            if (currentUser.role === 'admin' && behalfOfSelect.value) {
                // Admin contributing on behalf of someone else
                const selectedUser = JSON.parse(behalfOfSelect.value);
                contributorEmail = selectedUser.email;
                contributorName = selectedUser.name;
                contributorPicture = selectedUser.picture || '';
            } else {
                // Contributing under own name
                contributorEmail = currentUser.email;
                contributorName = currentUser.name;
                contributorPicture = currentUser.picture || '';
            }

            let formData;

            // Show loading state
            const submitBtn = document.getElementById('submit-btn');
            submitBtn.disabled = true;
            submitBtn.textContent = 'Submitting...';

            if (isEdTech) {
                // Build EdTech product data
                const checkedCategories = Array.from(document.querySelectorAll('.edtech-category-checkbox:checked'))
                    .map(cb => cb.value);

                formData = {
                    type: 'edtech-product',
                    primaryCategory: {
                        topic: primaryTopic,
                        subtopic: primarySubtopic
                    },
                    secondaryCategories: secondaryCategories,
                    topic: primaryTopic,
                    subtopic: primarySubtopic,
                    edtechProduct: {
                        name: document.getElementById('edtech-product-name').value.trim(),
                        url: document.getElementById('edtech-product-url').value.trim() || null,
                        categories: checkedCategories,
                        targetConsumers: document.getElementById('edtech-target-consumers').value.trim(),
                        painPoint: document.getElementById('edtech-pain-point').value.trim(),
                        competitors: document.getElementById('edtech-competitors').value.trim() || null,
                        businessModel: document.getElementById('edtech-business-model').value,
                        economicModel: document.getElementById('edtech-economic-model').value,
                        differentiators: document.getElementById('edtech-differentiators').value.trim(),
                        affordances: document.getElementById('edtech-affordances').value.trim(),
                        limitations: document.getElementById('edtech-limitations').value.trim()
                    },
                    authorEmail: contributorEmail,
                    authorName: contributorName,
                    authorPicture: contributorPicture,
                    userEmail: contributorEmail,
                    createdAt: new Date().toISOString(),
                    status: 'published'
                };
            } else {
                // Build regular bibliography data
                formData = {
                    type: 'research-entry',
                    primaryCategory: {
                        topic: primaryTopic,
                        subtopic: primarySubtopic
                    },
                    secondaryCategories: secondaryCategories,
                    topic: primaryTopic,
                    subtopic: primarySubtopic,
                    bibliography: {
                        authors: document.getElementById('authors').value,
                        year: parseInt(document.getElementById('year').value),
                        title: document.getElementById('title').value,
                        pubType: document.getElementById('pub-type').value,
                        journal: document.getElementById('journal').value || null,
                        volume: document.getElementById('volume').value || null,
                        issue: document.getElementById('issue').value || null,
                        pages: document.getElementById('pages').value || null,
                        publisher: document.getElementById('publisher').value || null,
                        location: document.getElementById('location').value || null,
                        bookTitle: document.getElementById('book-title').value || null,
                        editors: document.getElementById('editors').value || null,
                        chapterPublisher: document.getElementById('chapter-publisher').value || null,
                        chapterPages: document.getElementById('chapter-pages').value || null,
                        url: document.getElementById('url').value || null,
                        doi: document.getElementById('doi').value || null
                    },
                    summary: document.getElementById('summary').value,
                    authorEmail: contributorEmail,
                    authorName: contributorName,
                    authorPicture: contributorPicture,
                    userEmail: contributorEmail,
                    createdAt: new Date().toISOString(),
                    status: 'pending'
                };

                // Check for potential duplicates before submitting (only for research entries)
                try {
                    const submitBtn = document.getElementById('submit-btn');
                    submitBtn.disabled = true;
                    submitBtn.textContent = 'Checking for duplicates...';

                    const duplicate = await checkForDuplicates(formData.bibliography);

                    if (duplicate) {
                        // Reset button
                        submitBtn.disabled = false;
                        submitBtn.textContent = 'Submit Entry';

                        // Show duplicate detection modal
                        showDuplicateDetectionModal(duplicate, formData);
                        return; // Stop submission
                    }

                    // No duplicates found, proceed with submission
                    submitBtn.textContent = 'Submitting...';
                } catch (error) {
                    console.error('Error checking for duplicates:', error);
                    // If duplicate check fails, proceed with submission anyway
                }
            }

            try {
                // Call Firebase function to save contribution
                const saveContribution = window.firebaseApp.functions.httpsCallable('saveContribution');
                const result = await saveContribution(formData);

                if (result.data.success) {
                    const periodInfo = result.data.period ? ` (Period ${result.data.period})` : '';
                    alert(`Thank you for your contribution! Your entry has been published and is now live on the site.${periodInfo}`);

                    // Delete the draft if it was loaded from drafts
                    if (currentDraftId) {
                        try {
                            const deleteDraftFunc = firebase.functions().httpsCallable('deleteDraft');
                            await deleteDraftFunc({ draftId: currentDraftId });
                            currentDraftId = null; // Reset
                        } catch (error) {
                            console.error('Error deleting draft after submission:', error);
                            // Don't show error to user, submission was successful
                        }
                    }

                    closeContributionModal();

                    // Refresh progress dashboard if applicable
                    if (window.refreshProgressDashboard) {
                        window.refreshProgressDashboard();
                    }

                    // Reload the page to show the new contribution
                    window.location.reload();
                } else {
                    throw new Error(result.data.error || 'Failed to save contribution');
                }
            } catch (error) {
                console.error('Error submitting contribution:', error);

                // Show user-friendly error message
                let errorMessage = 'Error submitting contribution: ';

                if (error.code === 'failed-precondition' || error.message.includes('periods ahead')) {
                    // This is a pacing error from the backend
                    errorMessage = error.message;
                } else {
                    errorMessage += error.message;
                }

                alert(errorMessage);

                // Reset button
                const submitBtn = document.getElementById('submit-btn');
                submitBtn.disabled = false;
                submitBtn.textContent = 'Submit Entry';
            }
        }

        // Admin Panel Functions
        async function openAdminPanel() {
            document.getElementById('admin-panel').style.display = 'flex';
            document.body.style.overflow = 'hidden';
            await loadUsers();
        }

        function closeAdminPanel() {
            document.getElementById('admin-panel').style.display = 'none';
            document.body.style.overflow = 'auto';
        }

        async function loadUsers() {
            try {
                const db = window.firebaseApp.db;
                const usersSnapshot = await db.collection('users').get();
                const userRolesSnapshot = await db.collection('user_roles').get();
                const usersList = document.getElementById('users-list');

                if (usersSnapshot.empty) {
                    usersList.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">No users found.</p>';
                    return;
                }

                // Build map of manual role overrides
                const roleOverrides = {};
                userRolesSnapshot.forEach(doc => {
                    roleOverrides[doc.id] = doc.data().role;
                });

                let html = `
                    <div style="margin-bottom: 15px; padding: 12px; background: #f0f7ff; border-left: 4px solid #57068c; border-radius: 4px; font-size: 0.9rem;">
                        <strong>ðŸ’¡ Tip:</strong> You can also manage roles via Firebase Console in the <code>user_roles</code> collection. Manual entries override admin UI settings.
                    </div>
                    <div style="display: grid; gap: 15px;">
                `;

                usersSnapshot.forEach(doc => {
                    const user = doc.data();
                    const email = doc.id;
                    const uiRole = user.role || 'visitor';
                    const hasOverride = roleOverrides.hasOwnProperty(email);
                    const effectiveRole = hasOverride ? roleOverrides[email] : uiRole;

                    html += `
                        <div style="border: 1px solid ${hasOverride ? '#ff9800' : '#ddd'}; border-radius: 8px; padding: 15px; background: white;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <strong style="color: #2d2d2d;">${email}</strong>
                                    ${user.name ? `<div style="font-size: 0.9rem; color: #666;">${user.name}</div>` : ''}
                                    ${hasOverride ? `<div style="font-size: 0.8rem; color: #ff9800; margin-top: 4px;"><i class="fas fa-database"></i> Override: ${effectiveRole} (from user_roles collection)</div>` : ''}
                                </div>
                                <select onchange="updateUserRole('${email}', this.value)" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px; font-family: 'Montserrat', sans-serif; background: white; color: #2d2d2d;" ${hasOverride ? 'disabled title="Role is overridden in user_roles collection"' : ''}>
                                    <option value="visitor" ${uiRole === 'visitor' ? 'selected' : ''}>Visitor</option>
                                    <option value="first-year-contributor" ${uiRole === 'first-year-contributor' ? 'selected' : ''}>First-Year Contributor (1 per 2 weeks)</option>
                                    <option value="continuing-contributor" ${uiRole === 'continuing-contributor' ? 'selected' : ''}>Continuing Contributor (1 per month)</option>
                                    <option value="contributor" ${uiRole === 'contributor' ? 'selected' : ''}>Contributor (Legacy)</option>
                                    <option value="alumni" ${uiRole === 'alumni' ? 'selected' : ''}>Alumni (Edit Own Only)</option>
                                    <option value="admin" ${uiRole === 'admin' ? 'selected' : ''}>Admin</option>
                                </select>
                            </div>
                        </div>
                    `;
                });
                html += '</div>';
                usersList.innerHTML = html;
            } catch (error) {
                console.error('Error loading users:', error);
                document.getElementById('users-list').innerHTML = '<p style="text-align: center; color: #dc3545; padding: 20px;">Error loading users.</p>';
            }
        }

        async function updateUserRole(email, newRole) {
            try {
                const db = window.firebaseApp.db;
                await db.collection('users').doc(email).set({
                    role: newRole,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                }, { merge: true });

                showNotification(`Updated ${email} to ${newRole}`, 'success');
            } catch (error) {
                console.error('Error updating user role:', error);
                showNotification('Failed to update user role', 'error');
                await loadUsers(); // Reload to reset the dropdown
            }
        }

        // Admin tab switching
        function switchAdminTab(tab) {
            // Update tab buttons
            document.querySelectorAll('.admin-tab').forEach(btn => {
                btn.style.borderBottomColor = 'transparent';
                btn.style.color = '#666';
            });

            // Hide all panels
            document.getElementById('admin-users-panel').style.display = 'none';
            document.getElementById('admin-contributions-panel').style.display = 'none';
            document.getElementById('admin-semester-config-panel').style.display = 'none';

            // Show selected panel
            if (tab === 'users') {
                document.getElementById('users-tab').style.borderBottomColor = '#57068c';
                document.getElementById('users-tab').style.color = '#57068c';
                document.getElementById('admin-users-panel').style.display = 'block';
            } else if (tab === 'contributions') {
                document.getElementById('contributions-tab').style.borderBottomColor = '#57068c';
                document.getElementById('contributions-tab').style.color = '#57068c';
                document.getElementById('admin-contributions-panel').style.display = 'block';
                loadContributions(); // Load contributions when tab is opened
            } else if (tab === 'semester-config') {
                document.getElementById('semester-config-tab').style.borderBottomColor = '#57068c';
                document.getElementById('semester-config-tab').style.color = '#57068c';
                document.getElementById('admin-semester-config-panel').style.display = 'block';
                loadSemesterConfig(); // Load config when tab is opened
            }
        }

        // Semester Configuration Functions
        async function loadSemesterConfig() {
            try {
                const getSemesterConfigFunc = window.firebaseApp.functions.httpsCallable('getSemesterConfiguration');
                const result = await getSemesterConfigFunc();
                const config = result.data;

                // Populate form fields
                const startDate = new Date(config.startDate);
                const endDate = new Date(config.endDate);

                document.getElementById('semester-start-date').value = startDate.toISOString().split('T')[0];
                document.getElementById('semester-end-date').value = endDate.toISOString().split('T')[0];

                document.getElementById('first-year-period-length').value = config.firstYearContributor.periodLengthDays;
                document.getElementById('first-year-min-per-period').value = config.firstYearContributor.minContributionsPerPeriod;
                document.getElementById('first-year-max-per-period').value = config.firstYearContributor.maxContributionsPerPeriod;

                document.getElementById('continuing-period-length').value = config.continuingContributor.periodLengthDays;
                document.getElementById('continuing-min-per-period').value = config.continuingContributor.minContributionsPerPeriod;
                document.getElementById('continuing-max-per-period').value = config.continuingContributor.maxContributionsPerPeriod;

                console.log('Semester configuration loaded:', config);
            } catch (error) {
                console.error('Error loading semester configuration:', error);
                showSemesterConfigStatus('Error loading configuration: ' + error.message, 'error');
            }
        }

        async function saveSemesterConfig(event) {
            event.preventDefault();

            const statusDiv = document.getElementById('semester-config-status');
            statusDiv.style.display = 'none';

            try {
                // Collect form data
                const startDate = document.getElementById('semester-start-date').value;
                const endDate = document.getElementById('semester-end-date').value;

                const configData = {
                    startDate: new Date(startDate).toISOString(),
                    endDate: new Date(endDate).toISOString(),
                    firstYearContributor: {
                        periodLengthDays: parseInt(document.getElementById('first-year-period-length').value),
                        minContributionsPerPeriod: parseInt(document.getElementById('first-year-min-per-period').value),
                        maxContributionsPerPeriod: parseInt(document.getElementById('first-year-max-per-period').value),
                    },
                    continuingContributor: {
                        periodLengthDays: parseInt(document.getElementById('continuing-period-length').value),
                        minContributionsPerPeriod: parseInt(document.getElementById('continuing-min-per-period').value),
                        maxContributionsPerPeriod: parseInt(document.getElementById('continuing-max-per-period').value),
                    },
                };

                // Call Cloud Function
                const updateConfigFunc = window.firebaseApp.functions.httpsCallable('updateSemesterConfiguration');
                const result = await updateConfigFunc(configData);

                if (result.data.success) {
                    showSemesterConfigStatus('Configuration saved successfully!', 'success');

                    // Refresh progress dashboards for all users
                    if (window.refreshProgressDashboard) {
                        window.refreshProgressDashboard();
                    }
                } else {
                    throw new Error('Failed to save configuration');
                }
            } catch (error) {
                console.error('Error saving semester configuration:', error);
                showSemesterConfigStatus('Error saving configuration: ' + error.message, 'error');
            }
        }

        function showSemesterConfigStatus(message, type) {
            const statusDiv = document.getElementById('semester-config-status');
            statusDiv.textContent = message;
            statusDiv.style.display = 'block';
            statusDiv.style.background = type === 'success' ? '#d4edda' : '#f8d7da';
            statusDiv.style.color = type === 'success' ? '#155724' : '#721c24';
            statusDiv.style.border = type === 'success' ? '1px solid #c3e6cb' : '1px solid #f5c6cb';

            // Auto-hide after 5 seconds
            setTimeout(() => {
                statusDiv.style.display = 'none';
            }, 5000);
        }

        // Load contributions from Firestore
        async function loadContributions() {
            try {
                const db = window.firebaseApp.db;
                const snapshot = await db.collection('contributions').orderBy('createdAt', 'desc').get();
                const contributionsList = document.getElementById('contributions-list');

                if (snapshot.empty) {
                    contributionsList.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">No contributions found.</p>';
                    return;
                }

                let html = '<div style="display: grid; gap: 15px;">';
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const createdAt = data.createdAt ? new Date(data.createdAt.seconds * 1000).toLocaleDateString() : 'Unknown';

                    let entryTitle, entryType, entryDetails;

                    if (data.type === 'edtech-product') {
                        // EdTech product entry
                        entryTitle = data.edtechProduct?.name || 'Unnamed Product';
                        entryType = 'EdTech Product';
                        entryDetails = `
                            <div><strong>Type:</strong> ${entryType}</div>
                            <div><strong>Categories:</strong> ${data.edtechProduct?.categories?.join(', ') || 'None'}</div>
                            <div><strong>Submitted by:</strong> ${data.authorName || 'Unknown'} (${data.authorEmail || 'Unknown'})</div>
                            <div><strong>Topic:</strong> ${data.topic} / ${data.subtopic}</div>
                            <div><strong>Date:</strong> ${createdAt}</div>
                            <div style="margin-top: 10px;"><strong>Target Consumers:</strong> ${data.edtechProduct?.targetConsumers?.substring(0, 100) || 'N/A'}${data.edtechProduct?.targetConsumers?.length > 100 ? '...' : ''}</div>
                        `;
                    } else {
                        // Regular research entry
                        entryTitle = data.bibliography?.title || 'Untitled';
                        entryType = 'Research Entry';
                        entryDetails = `
                            <div><strong>Author(s):</strong> ${data.bibliography?.authors || 'Unknown'}</div>
                            <div><strong>Submitted by:</strong> ${data.authorName || 'Unknown'} (${data.authorEmail || 'Unknown'})</div>
                            <div><strong>Topic:</strong> ${data.topic} / ${data.subtopic}</div>
                            <div><strong>Date:</strong> ${createdAt}</div>
                            <div style="margin-top: 10px;"><strong>Summary:</strong> ${data.summary?.substring(0, 150) || 'No summary'}${data.summary?.length > 150 ? '...' : ''}</div>
                        `;
                    }

                    html += `
                        <div style="border: 1px solid #ddd; border-radius: 8px; padding: 15px; background: white;">
                            <div style="display: flex; justify-content: space-between; align-items: start; gap: 15px;">
                                <div style="flex: 1;">
                                    <strong style="color: #57068c; font-size: 1.1rem;">${entryTitle}</strong>
                                    <div style="margin-top: 5px; color: #666; font-size: 0.9rem;">
                                        ${entryDetails}
                                    </div>
                                </div>
                                <div style="display: flex; gap: 8px;">
                                    <button onclick="openEditContribution('${doc.id}')" style="padding: 8px 16px; background: #4285f4; color: white; border: none; border-radius: 4px; cursor: pointer; white-space: nowrap;">
                                        <i class="fas fa-edit"></i> Edit
                                    </button>
                                    <button onclick="deleteContribution('${doc.id}')" style="padding: 8px 16px; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer; white-space: nowrap;">
                                        <i class="fas fa-trash"></i> Delete
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                });
                html += '</div>';
                contributionsList.innerHTML = html;
            } catch (error) {
                console.error('Error loading contributions:', error);
                document.getElementById('contributions-list').innerHTML = '<p style="text-align: center; color: #dc3545; padding: 20px;">Error loading contributions.</p>';
            }
        }

        // Delete a contribution
        async function deleteContribution(contributionId) {
            try {
                const currentUser = window.auth.getCurrentUser();
                if (!currentUser) {
                    showNotification('Please sign in to delete entries.', 'error');
                    return;
                }

                const db = window.firebaseApp.db;
                const doc = await db.collection('contributions').doc(contributionId).get();

                if (!doc.exists) {
                    showNotification('Contribution not found', 'error');
                    return;
                }

                const data = doc.data();

                // Check permissions
                const isAdmin = currentUser.role === 'admin';
                const isOwner = data.authorEmail === currentUser.email || data.userEmail === currentUser.email;

                if (!isAdmin && !isOwner) {
                    showNotification('You can only delete your own contributions.', 'error');
                    return;
                }

                // Check if others have added perspectives
                const perspectives = data.perspectives || [];
                const hasPerspectivesFromOthers = perspectives.some(p =>
                    p.authorEmail && p.authorEmail !== currentUser.email
                );

                if (hasPerspectivesFromOthers) {
                    showNotification('Cannot delete: Other users have added perspectives to this entry.', 'error');
                    return;
                }

                if (!confirm('Are you sure you want to delete this contribution? This cannot be undone.')) {
                    return;
                }

                await db.collection('contributions').doc(contributionId).delete();
                showNotification('Contribution deleted successfully', 'success');

                // Reload contributions and refresh the page entries
                await loadContributions();
                window.location.reload(); // Refresh to remove from topic pages
            } catch (error) {
                console.error('Error deleting contribution:', error);
                showNotification('Failed to delete contribution', 'error');
            }
        }

        // Refresh contributions list
        function refreshContributions() {
            loadContributions();
        }

        // Subtopic mapping for edit form
        const subtopicsByTopic = {
            'understanding-users': [
                { value: 'general', label: 'General' },
                { value: 'administrators', label: 'Administrators' },
                { value: 'students', label: 'Students' },
                { value: 'faculty', label: 'Faculty' }
            ],
            'evaluating-tools': [
                { value: 'coding', label: 'Coding' },
                { value: 'creativity', label: 'Creativity' },
                { value: 'detection-tools', label: 'Detection Tools' },
                { value: 'ethics-safety', label: 'Ethics & Safety' },
                { value: 'equity-social-justice', label: 'Equity & Social Justice' },
                { value: 'error-hallucination', label: 'Error & Hallucination' },
                { value: 'reasoning', label: 'Reasoning' },
                { value: 'usability', label: 'Usability' },
                { value: 'translation', label: 'Translation' }
            ],
            'assessing-impacts': [
                { value: 'learning-outcomes', label: 'Learning Outcomes' },
                { value: 'academic-integrity', label: 'Academic Integrity' },
                { value: 'assessment-validity', label: 'Assessment Validity' },
                { value: 'student-wellbeing', label: 'Student Wellbeing' },
                { value: 'equity-access', label: 'Equity & Access' }
            ],
            'innovating-edtech': [
                { value: 'ai-tutoring', label: 'AI Tutoring & Learning Support' },
                { value: 'writing-content-generation', label: 'Writing & Content Generation Tools' },
                { value: 'detection-integrity', label: 'Detection & Academic Integrity Tools' },
                { value: 'organizational-productivity', label: 'Organizational & Productivity Tools' },
                { value: 'feedback-assessment', label: 'Feedback & Assessment' },
                { value: 'accessibility-inclusion', label: 'Accessibility & Inclusion' },
                { value: 'learning-analytics', label: 'Classroom & Learning Analytics' },
                { value: 'scheduling', label: 'Scheduling' }
            ],
            'learning-science': [
                { value: 'writing-composition', label: 'Writing & Composition' },
                { value: 'cognitive-science', label: 'Cognitive Science' },
                { value: 'reading-literacy', label: 'Reading & Literacy' },
                { value: 'educational-philosophy', label: 'Educational Philosophy' },
                { value: 'ai-ml-foundations', label: 'AI/ML Foundations' }
            ],
            'research-methods': [
                { value: 'literature-review', label: 'Literature Review' },
                { value: 'collaborative-research', label: 'Collaborative Research' },
                { value: 'experimental-design', label: 'Experimental Design' },
                { value: 'survey-design', label: 'Survey Design' },
                { value: 'interview-focus-groups', label: 'Interview & Focus Groups' },
                { value: 'data-analysis', label: 'Data Analysis' },
                { value: 'research-ethics', label: 'Research Ethics' },
                { value: 'academic-writing', label: 'Academic Writing' }
            ]
        };

        // Open edit contribution modal
        // Edit form secondary category management
        let editSecondaryCategoryCount = 0;
        const EDIT_MAX_SECONDARY_CATEGORIES = 2;

        function addEditSecondaryCategory(topic = '', subtopic = '') {
            if (editSecondaryCategoryCount >= EDIT_MAX_SECONDARY_CATEGORIES) {
                alert('Maximum 2 secondary categories allowed');
                return;
            }

            editSecondaryCategoryCount++;
            const container = document.getElementById('edit-secondary-categories-container');
            const categoryDiv = document.createElement('div');
            categoryDiv.className = `edit-secondary-category-${editSecondaryCategoryCount}`;
            categoryDiv.style.cssText = 'margin-bottom: 15px; padding: 15px; background: white; border-radius: 8px; border: 1px solid #ddd;';

            categoryDiv.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <h5 style="margin: 0; color: #57068c; font-size: 0.9rem;">Secondary Category ${editSecondaryCategoryCount}</h5>
                    <button type="button" onclick="removeEditSecondaryCategory(${editSecondaryCategoryCount})"
                            style="padding: 4px 8px; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.8rem;">
                        <i class="fas fa-times"></i> Remove
                    </button>
                </div>
                <div style="margin-bottom: 10px;">
                    <label style="display: block; font-weight: 500; margin-bottom: 5px; color: #2d2d2d; font-size: 0.9rem;">Topic</label>
                    <select class="edit-secondary-topic" data-index="${editSecondaryCategoryCount}" onchange="updateEditSecondarySubtopics(${editSecondaryCategoryCount})"
                            style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-family: 'Montserrat', sans-serif; font-size: 0.9rem;">
                        <option value="">-- Select topic --</option>
                        <option value="evaluating-tools" ${topic === 'evaluating-tools' ? 'selected' : ''}>Evaluating Tools</option>
                        <option value="understanding-users" ${topic === 'understanding-users' ? 'selected' : ''}>Understanding Users</option>
                        <option value="assessing-impacts" ${topic === 'assessing-impacts' ? 'selected' : ''}>Assessing Impacts</option>
                        <option value="innovating-edtech" ${topic === 'innovating-edtech' ? 'selected' : ''}>Innovating EdTech</option>
                        <option value="learning-science" ${topic === 'learning-science' ? 'selected' : ''}>Learning Science</option>
                        <option value="research-methods" ${topic === 'research-methods' ? 'selected' : ''}>Research Methods</option>
                    </select>
                </div>
                <div>
                    <label style="display: block; font-weight: 500; margin-bottom: 5px; color: #2d2d2d; font-size: 0.9rem;">Subtopic</label>
                    <select class="edit-secondary-subtopic" data-index="${editSecondaryCategoryCount}" data-selected="${subtopic}"
                            style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-family: 'Montserrat', sans-serif; font-size: 0.9rem;">
                        <option value="">-- Select topic first --</option>
                    </select>
                </div>
            `;

            container.appendChild(categoryDiv);

            // If topic is provided, populate subtopics
            if (topic) {
                updateEditSecondarySubtopics(editSecondaryCategoryCount, subtopic);
            }

            // Update button visibility
            if (editSecondaryCategoryCount >= EDIT_MAX_SECONDARY_CATEGORIES) {
                document.getElementById('edit-add-secondary-category-btn').style.display = 'none';
            }
        }

        function removeEditSecondaryCategory(index) {
            const categoryDiv = document.querySelector(`.edit-secondary-category-${index}`);
            if (categoryDiv) {
                categoryDiv.remove();
                editSecondaryCategoryCount--;

                // Show add button if below max
                if (editSecondaryCategoryCount < EDIT_MAX_SECONDARY_CATEGORIES) {
                    document.getElementById('edit-add-secondary-category-btn').style.display = 'block';
                }
            }
        }

        function updateEditSecondarySubtopics(index, selectedSubtopic = '') {
            const topicSelect = document.querySelector(`.edit-secondary-topic[data-index="${index}"]`);
            const subtopicSelect = document.querySelector(`.edit-secondary-subtopic[data-index="${index}"]`);

            if (!topicSelect || !subtopicSelect) return;

            const selectedTopic = topicSelect.value;
            subtopicSelect.innerHTML = '<option value="">-- Select a subtopic --</option>';

            if (selectedTopic && subtopics[selectedTopic]) {
                subtopics[selectedTopic].forEach(subtopic => {
                    const option = document.createElement('option');
                    option.value = subtopic.value;
                    option.textContent = subtopic.label;
                    if (subtopic.value === selectedSubtopic) {
                        option.selected = true;
                    }
                    subtopicSelect.appendChild(option);
                });
            }
        }

        function getEditSecondaryCategories() {
            const categories = [];
            const topicSelects = document.querySelectorAll('.edit-secondary-topic');

            topicSelects.forEach(topicSelect => {
                const index = topicSelect.getAttribute('data-index');
                const subtopicSelect = document.querySelector(`.edit-secondary-subtopic[data-index="${index}"]`);

                if (topicSelect.value && subtopicSelect.value) {
                    categories.push({
                        topic: topicSelect.value,
                        subtopic: subtopicSelect.value
                    });
                }
            });

            return categories;
        }

        async function openEditContribution(contributionId) {
            try {
                const currentUser = window.auth.getCurrentUser();
                if (!currentUser) {
                    showNotification('Please sign in to edit entries.', 'error');
                    return;
                }

                const db = window.firebaseApp.db;
                const doc = await db.collection('contributions').doc(contributionId).get();

                if (!doc.exists) {
                    showNotification('Contribution not found', 'error');
                    return;
                }

                const data = doc.data();

                // Check permissions: admin can edit all, alumni/contributor can only edit their own
                const isAdmin = currentUser.role === 'admin';
                const isOwner = data.authorEmail === currentUser.email || data.userEmail === currentUser.email;

                if (!isAdmin && !isOwner) {
                    showNotification('You can only edit your own contributions.', 'error');
                    return;
                }

                // Alumni role check - they can edit but not create
                if (currentUser.role === 'alumni' && !isOwner) {
                    showNotification('As an alumni, you can only edit your own previous contributions.', 'error');
                    return;
                }

                // Store contribution ID and type
                document.getElementById('edit-contribution-id').value = contributionId;
                const isEdTech = data.type === 'edtech-product';

                // Support both old and new schema for primary category
                const primaryCategory = data.primaryCategory || { topic: data.topic, subtopic: data.subtopic };

                // Populate basic fields
                document.getElementById('edit-topic').value = primaryCategory.topic || '';
                updateEditSubtopicOptions(primaryCategory.subtopic || '');

                // Show/hide fields based on entry type
                const bibFields = document.getElementById('edit-bibliography-fields');
                const edtechFields = document.getElementById('edit-edtech-fields');
                const summaryField = document.getElementById('edit-summary-field');
                const modalTitle = document.querySelector('#edit-contribution-modal h2');

                if (isEdTech) {
                    // EdTech product entry
                    modalTitle.textContent = 'Edit EdTech Product';
                    bibFields.style.display = 'none';
                    summaryField.style.display = 'none';
                    edtechFields.style.display = 'block';

                    const product = data.edtechProduct || {};
                    document.getElementById('edit-edtech-product-name').value = product.name || '';
                    document.getElementById('edit-edtech-product-url').value = product.url || '';
                    document.getElementById('edit-edtech-target-consumers').value = product.targetConsumers || '';
                    document.getElementById('edit-edtech-pain-point').value = product.painPoint || '';
                    document.getElementById('edit-edtech-competitors').value = product.competitors || '';
                    document.getElementById('edit-edtech-business-model').value = product.businessModel || '';
                    document.getElementById('edit-edtech-economic-model').value = product.economicModel || '';
                    document.getElementById('edit-edtech-differentiators').value = product.differentiators || '';
                    document.getElementById('edit-edtech-affordances').value = product.affordances || '';
                    document.getElementById('edit-edtech-limitations').value = product.limitations || '';

                    // Set categories checkboxes
                    document.querySelectorAll('.edit-edtech-category-checkbox').forEach(checkbox => {
                        checkbox.checked = (product.categories || []).includes(checkbox.value);
                    });
                } else {
                    // Regular research entry
                    modalTitle.textContent = 'Edit Research Entry';
                    bibFields.style.display = 'block';
                    summaryField.style.display = 'block';
                    edtechFields.style.display = 'none';

                    document.getElementById('edit-summary').value = data.summary || '';

                    // Populate bibliography fields
                    const bib = data.bibliography || {};
                    document.getElementById('edit-bib-title').value = bib.title || '';
                    document.getElementById('edit-bib-authors').value = bib.authors || '';
                    document.getElementById('edit-bib-year').value = bib.year || '';
                    document.getElementById('edit-bib-url').value = bib.url || '';
                    document.getElementById('edit-bib-pubtype').value = bib.pubType || 'journal';

                    // Journal fields
                    document.getElementById('edit-bib-journal').value = bib.journal || '';
                    document.getElementById('edit-bib-volume').value = bib.volume || '';
                    document.getElementById('edit-bib-issue').value = bib.issue || '';
                    document.getElementById('edit-bib-pages').value = bib.pages || '';

                    // Book fields
                    document.getElementById('edit-bib-publisher').value = bib.publisher || '';
                    document.getElementById('edit-bib-location').value = bib.location || '';

                    // Tags
                    const tags = bib.tags || [];
                    document.getElementById('edit-tags').value = Array.isArray(tags) ? tags.join(', ') : tags;

                    // Update visible fields based on pub type
                    updateEditPubTypeFields();
                }

                // Populate contributor dropdown (same for both types)
                const contributorSelect = document.getElementById('edit-contributor');
                contributorSelect.innerHTML = '<option value="">Select Contributor</option>';

                if (window.contributorAPI) {
                    const allContributors = window.contributorAPI.getAllContributors();
                    allContributors.forEach(contributor => {
                        const option = document.createElement('option');
                        option.value = contributor.name;
                        option.textContent = `${contributor.name} (${contributor.count} contributions)`;
                        contributorSelect.appendChild(option);
                    });
                }

                // Set current contributor
                const currentContributor = data.authorName || '';
                contributorSelect.value = currentContributor;

                // Reset and populate secondary categories
                document.getElementById('edit-secondary-categories-container').innerHTML = '';
                editSecondaryCategoryCount = 0;
                document.getElementById('edit-add-secondary-category-btn').style.display = 'block';

                // Get secondary categories (primaryCategory was already defined above)
                const secondaryCategories = data.secondaryCategories || [];

                // Populate existing secondary categories
                secondaryCategories.forEach(category => {
                    addEditSecondaryCategory(category.topic, category.subtopic);
                });

                // Show modal
                document.getElementById('edit-contribution-modal').style.display = 'flex';
            } catch (error) {
                console.error('Error loading contribution for edit:', error);
                showNotification('Failed to load contribution', 'error');
            }
        }

        // Close edit contribution modal
        function closeEditContribution() {
            document.getElementById('edit-contribution-modal').style.display = 'none';
            document.getElementById('edit-contribution-form').reset();

            // Reset secondary categories
            document.getElementById('edit-secondary-categories-container').innerHTML = '';
            editSecondaryCategoryCount = 0;
            document.getElementById('edit-add-secondary-category-btn').style.display = 'block';
        }

        // Add Perspective functionality
        async function openAddPerspective(button) {
            // Reset perspective draft ID when opening fresh
            currentPerspectiveDraftId = null;

            // Check if user is signed in
            const currentUser = window.auth.getCurrentUser();
            if (!currentUser) {
                showNotification('Please sign in to add your perspective.', 'error');
                return;
            }

            // Check if user has permission (contributor, alumni, or admin)
            if (currentUser.role !== 'contributor' && currentUser.role !== 'alumni' && currentUser.role !== 'admin') {
                showNotification('Sign in with a contributor account to add perspectives.', 'error');
                return;
            }

            // Find the closest bib-entry to get the entry ID and source info
            const bibEntry = button.closest('.bib-entry');
            if (!bibEntry) {
                showNotification('Could not find entry information.', 'error');
                return;
            }

            const entryId = bibEntry.getAttribute('data-contribution-id') || bibEntry.id;
            const citation = bibEntry.querySelector('.bib-citation')?.textContent.trim() || '';

            // Set the entry ID and source info
            document.getElementById('perspective-entry-id').value = entryId;
            document.getElementById('perspective-source-info').textContent = citation;

            // If admin, show the "add perspective on behalf of" selector
            const adminSelector = document.getElementById('admin-perspective-selector');
            const behalfOfSelect = document.getElementById('perspective-behalf-of-user');

            if (currentUser.role === 'admin') {
                adminSelector.style.display = 'block';

                // Populate team members dropdown
                try {
                    const db = window.firebaseApp.db;
                    const usersSnapshot = await db.collection('users')
                        .where('role', 'in', ['contributor', 'admin', 'alumni'])
                        .get();

                    // Clear existing options except the first one
                    behalfOfSelect.innerHTML = '<option value="">-- Select team member (or leave blank for yourself) --</option>';

                    // Add users sorted by name
                    const users = [];
                    usersSnapshot.forEach(doc => {
                        const userData = doc.data();
                        users.push({
                            email: doc.id,
                            name: userData.name || doc.id,
                            role: userData.role,
                            picture: userData.picture || ''
                        });
                    });

                    users.sort((a, b) => a.name.localeCompare(b.name));

                    users.forEach(user => {
                        const option = document.createElement('option');
                        option.value = JSON.stringify({ email: user.email, name: user.name, picture: user.picture });
                        option.textContent = `${user.name} (${user.role})`;
                        behalfOfSelect.appendChild(option);
                    });
                } catch (error) {
                    console.error('Error loading team members:', error);
                }
            } else {
                adminSelector.style.display = 'none';
            }

            // Show modal
            document.getElementById('add-perspective-modal').style.display = 'flex';
            document.body.style.overflow = 'hidden';
        }

        function closeAddPerspective() {
            document.getElementById('add-perspective-modal').style.display = 'none';
            document.body.style.overflow = 'auto';
            document.getElementById('add-perspective-form').reset();
            currentPerspectiveDraftId = null; // Reset draft ID
        }

        async function submitPerspective(event) {
            event.preventDefault();

            const entryId = document.getElementById('perspective-entry-id').value;
            const perspectiveText = document.getElementById('perspective-text').value;

            // Validate length
            if (perspectiveText.length < 50) {
                alert('Perspective must be at least 50 characters.');
                return;
            }

            try {
                const currentUser = window.auth.getCurrentUser();
                const db = window.firebaseApp.db;

                // Determine who to attribute the perspective to
                let contributorEmail, contributorName, contributorPicture;
                const behalfOfSelect = document.getElementById('perspective-behalf-of-user');

                if (currentUser.role === 'admin' && behalfOfSelect.value) {
                    // Admin adding perspective on behalf of someone else
                    const selectedUser = JSON.parse(behalfOfSelect.value);
                    contributorEmail = selectedUser.email;
                    contributorName = selectedUser.name;
                    contributorPicture = selectedUser.picture || '';
                } else {
                    // Adding perspective under own name
                    contributorEmail = currentUser.email;
                    contributorName = currentUser.name;
                    contributorPicture = currentUser.picture || '';
                }

                // Disable submit button
                const submitBtn = document.getElementById('submit-perspective-btn');
                submitBtn.disabled = true;
                submitBtn.textContent = 'Submitting...';

                // Get the current entry
                const entryRef = db.collection('contributions').doc(entryId);
                const entryDoc = await entryRef.get();

                if (!entryDoc.exists) {
                    throw new Error('Entry not found');
                }

                // Create perspective object
                // Note: Using client-side timestamp because serverTimestamp() is not allowed in arrayUnion
                const perspective = {
                    text: perspectiveText,
                    authorName: contributorName,
                    authorEmail: contributorEmail,
                    authorPicture: contributorPicture,
                    createdAt: new Date()
                };

                // Add perspective to the perspectives array
                await entryRef.update({
                    perspectives: firebase.firestore.FieldValue.arrayUnion(perspective)
                });

                showNotification('Your perspective has been added!', 'success');

                // Delete the draft if it was loaded from drafts
                if (currentPerspectiveDraftId) {
                    try {
                        const deleteDraftFunc = firebase.functions().httpsCallable('deleteDraft');
                        await deleteDraftFunc({ draftId: currentPerspectiveDraftId });
                        currentPerspectiveDraftId = null; // Reset
                    } catch (error) {
                        console.error('Error deleting perspective draft after submission:', error);
                        // Don't show error to user, submission was successful
                    }
                }

                closeAddPerspective();

                // Reload to show new perspective
                window.location.reload();

            } catch (error) {
                console.error('Error adding perspective:', error);
                showNotification('Failed to add perspective: ' + error.message, 'error');

                // Re-enable button
                const submitBtn = document.getElementById('submit-perspective-btn');
                submitBtn.disabled = false;
                submitBtn.textContent = 'Add Perspective';
            }
        }

        // Delete perspective (admin only)
        window.deletePerspective = async function(button, encodedPerspectiveData) {
            if (!window.auth || !window.auth.getCurrentUser || window.auth.getCurrentUser()?.role !== 'admin') {
                alert('Only administrators can delete perspectives');
                return;
            }

            if (!confirm('Are you sure you want to delete this perspective?')) {
                return;
            }

            try {
                const db = window.firebaseApp.db;

                // Find the closest bib-entry to get the contribution ID
                const bibEntry = button.closest('.bib-entry');
                if (!bibEntry) {
                    throw new Error('Could not find entry');
                }

                const contributionId = bibEntry.getAttribute('data-contribution-id') || bibEntry.id.split('-')[0];

                // Decode the perspective data
                const perspectiveData = JSON.parse(decodeURIComponent(encodedPerspectiveData));

                // Convert the createdAt back to a Firestore Timestamp for proper matching
                if (perspectiveData.createdAt && typeof perspectiveData.createdAt === 'object') {
                    if (perspectiveData.createdAt.seconds !== undefined) {
                        perspectiveData.createdAt = new firebase.firestore.Timestamp(
                            perspectiveData.createdAt.seconds,
                            perspectiveData.createdAt.nanoseconds || 0
                        );
                    }
                }

                // Remove the perspective from the array
                await db.collection('contributions').doc(contributionId).update({
                    perspectives: firebase.firestore.FieldValue.arrayRemove(perspectiveData)
                });

                showNotification('Perspective deleted successfully', 'success');

                // Reload to show updated perspectives
                window.location.reload();

            } catch (error) {
                console.error('Error deleting perspective:', error);
                showNotification('Failed to delete perspective: ' + error.message, 'error');
            }
        };

        // Edit perspective (admin only)
        window.editPerspective = function(button, encodedPerspectiveData) {
            if (!window.auth || !window.auth.getCurrentUser || window.auth.getCurrentUser()?.role !== 'admin') {
                alert('Only administrators can edit perspectives');
                return;
            }

            try {
                // Find the closest bib-entry to get the contribution ID and source info
                const bibEntry = button.closest('.bib-entry');
                if (!bibEntry) {
                    throw new Error('Could not find entry');
                }

                const contributionId = bibEntry.getAttribute('data-contribution-id') || bibEntry.id.split('-')[0];
                const citation = bibEntry.querySelector('.bib-citation')?.textContent.trim() || '';

                // Decode the perspective data
                const perspectiveData = JSON.parse(decodeURIComponent(encodedPerspectiveData));

                // Set the entry ID, original data, and source info
                document.getElementById('edit-perspective-entry-id').value = contributionId;
                document.getElementById('edit-perspective-original-data').value = encodedPerspectiveData;
                document.getElementById('edit-perspective-source-info').textContent = citation;
                document.getElementById('edit-perspective-text').value = perspectiveData.text;

                // Show modal
                document.getElementById('edit-perspective-modal').style.display = 'flex';
                document.body.style.overflow = 'hidden';

            } catch (error) {
                console.error('Error opening edit perspective modal:', error);
                showNotification('Failed to open edit modal: ' + error.message, 'error');
            }
        };

        function closeEditPerspective() {
            document.getElementById('edit-perspective-modal').style.display = 'none';
            document.body.style.overflow = 'auto';
            document.getElementById('edit-perspective-form').reset();
        }

        async function submitEditPerspective(event) {
            event.preventDefault();

            const entryId = document.getElementById('edit-perspective-entry-id').value;
            const originalDataEncoded = document.getElementById('edit-perspective-original-data').value;
            const newText = document.getElementById('edit-perspective-text').value.trim();

            if (newText.length < 50) {
                alert('Perspective must be at least 50 characters.');
                return;
            }

            try {
                const currentUser = window.auth.getCurrentUser();
                const db = window.firebaseApp.db;

                // Disable submit button
                const submitBtn = document.getElementById('submit-edit-perspective-btn');
                submitBtn.disabled = true;
                submitBtn.textContent = 'Saving...';

                // Decode the original perspective data
                const originalPerspective = JSON.parse(decodeURIComponent(originalDataEncoded));

                // Convert the createdAt back to a Firestore Timestamp for proper matching
                if (originalPerspective.createdAt && typeof originalPerspective.createdAt === 'object') {
                    if (originalPerspective.createdAt.seconds !== undefined) {
                        originalPerspective.createdAt = new firebase.firestore.Timestamp(
                            originalPerspective.createdAt.seconds,
                            originalPerspective.createdAt.nanoseconds || 0
                        );
                    }
                }

                // Create updated perspective object
                const updatedPerspective = {
                    text: newText,
                    authorName: originalPerspective.authorName,
                    authorEmail: originalPerspective.authorEmail,
                    createdAt: originalPerspective.createdAt
                };

                // Get the entry reference
                const entryRef = db.collection('contributions').doc(entryId);

                // Remove old perspective and add updated one
                await entryRef.update({
                    perspectives: firebase.firestore.FieldValue.arrayRemove(originalPerspective)
                });

                await entryRef.update({
                    perspectives: firebase.firestore.FieldValue.arrayUnion(updatedPerspective)
                });

                showNotification('Perspective updated successfully!', 'success');
                closeEditPerspective();

                // Reload to show updated perspective
                window.location.reload();

            } catch (error) {
                console.error('Error updating perspective:', error);
                showNotification('Failed to update perspective: ' + error.message, 'error');

                // Re-enable button
                const submitBtn = document.getElementById('submit-edit-perspective-btn');
                submitBtn.disabled = false;
                submitBtn.textContent = 'Save Changes';
            }
        }

        // Reading List Functions
        async function toggleReadingList(button, entryId) {
            const currentUser = window.auth?.getCurrentUser();
            if (!currentUser) {
                showNotification('Please sign in to use the reading list', 'info');
                return;
            }

            try {
                const db = window.firebaseApp.db;
                const userRef = db.collection('users').doc(currentUser.email);
                const userDoc = await userRef.get();

                const readingList = userDoc.data()?.readingList || [];
                const isInList = readingList.includes(entryId);
                const icon = button.querySelector('i');

                if (isInList) {
                    // Remove from reading list
                    await userRef.update({
                        readingList: firebase.firestore.FieldValue.arrayRemove(entryId)
                    });
                    icon.className = 'far fa-star';
                    button.title = 'Add to reading list';
                    showNotification('Removed from reading list', 'success');
                } else {
                    // Add to reading list
                    await userRef.update({
                        readingList: firebase.firestore.FieldValue.arrayUnion(entryId)
                    });
                    icon.className = 'fas fa-star';
                    button.title = 'Remove from reading list';
                    showNotification('Added to reading list', 'success');
                }
            } catch (error) {
                console.error('Error toggling reading list:', error);
                showNotification('Failed to update reading list', 'error');
            }
        }

        async function openReadingList() {
            const currentUser = window.auth?.getCurrentUser();
            if (!currentUser) {
                showNotification('Please sign in to view your reading list', 'info');
                return;
            }

            document.getElementById('reading-list-modal').style.display = 'flex';
            document.body.style.overflow = 'hidden';

            await loadReadingList();
        }

        function closeReadingList() {
            document.getElementById('reading-list-modal').style.display = 'none';
            document.body.style.overflow = 'auto';
        }

        async function loadReadingList() {
            const contentDiv = document.getElementById('reading-list-content');
            const currentUser = window.auth?.getCurrentUser();

            try {
                const db = window.firebaseApp.db;
                const userRef = db.collection('users').doc(currentUser.email);
                const userDoc = await userRef.get();

                const readingList = userDoc.data()?.readingList || [];

                if (readingList.length === 0) {
                    contentDiv.innerHTML = `
                        <div style="text-align: center; padding: 60px 20px; color: #666;">
                            <i class="far fa-star" style="font-size: 4rem; color: #ddd; margin-bottom: 20px;"></i>
                            <h3 style="color: #999; font-weight: normal;">Your reading list is empty</h3>
                            <p>Click the star icon on any entry to add it to your reading list</p>
                        </div>
                    `;
                    return;
                }

                // Fetch all entries in the reading list
                const entries = await Promise.all(
                    readingList.map(async (entryId) => {
                        const doc = await db.collection('contributions').doc(entryId).get();
                        if (doc.exists) {
                            return { id: doc.id, ...doc.data() };
                        }
                        return null;
                    })
                );

                const validEntries = entries.filter(e => e !== null);

                if (validEntries.length === 0) {
                    contentDiv.innerHTML = `
                        <div style="text-align: center; padding: 60px 20px; color: #666;">
                            <p>No valid entries found in your reading list</p>
                        </div>
                    `;
                    return;
                }

                // Render entries
                let html = '<div style="display: grid; gap: 20px;">';
                validEntries.forEach(entry => {
                    const isEdTech = entry.type === 'edtech-product';
                    const title = isEdTech
                        ? entry.edtechProduct?.name || 'Unnamed Product'
                        : entry.bibliography?.title || 'Untitled';
                    const author = isEdTech
                        ? `Analyzed by ${entry.authorName}`
                        : entry.bibliography?.authors || 'Unknown';
                    const url = isEdTech
                        ? entry.edtechProduct?.url
                        : entry.bibliography?.url;

                    html += `
                        <div style="padding: 20px; border: 1px solid #e0e0e0; border-radius: 8px; background: white;">
                            <div style="display: flex; justify-content: space-between; align-items: start; gap: 15px;">
                                <div style="flex: 1;">
                                    <h3 style="margin: 0 0 10px 0; color: #57068c; font-size: 1.1rem;">${title}</h3>
                                    <p style="margin: 0 0 10px 0; color: #666; font-size: 0.9rem;">${author}</p>
                                    ${entry.summary ? `<p style="margin: 0; color: #555; line-height: 1.6;">${entry.summary.substring(0, 200)}${entry.summary.length > 200 ? '...' : ''}</p>` : ''}
                                </div>
                                <div style="display: flex; gap: 8px;">
                                    ${url ? `<button onclick="window.open('${url}', '_blank')" style="padding: 8px 16px; background: #57068c; color: white; border: none; border-radius: 4px; cursor: pointer; white-space: nowrap;">
                                        <i class="fas fa-external-link-alt"></i> View
                                    </button>` : ''}
                                    <button onclick="removeFromReadingList('${entry.id}')" style="padding: 8px 16px; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer; white-space: nowrap;">
                                        <i class="fas fa-trash"></i> Remove
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                });
                html += '</div>';

                contentDiv.innerHTML = html;

            } catch (error) {
                console.error('Error loading reading list:', error);
                contentDiv.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #dc3545;">
                        <i class="fas fa-exclamation-triangle" style="font-size: 2rem; margin-bottom: 10px;"></i>
                        <p>Failed to load reading list</p>
                    </div>
                `;
            }
        }

        async function removeFromReadingList(entryId) {
            const currentUser = window.auth?.getCurrentUser();
            if (!currentUser) return;

            try {
                const db = window.firebaseApp.db;
                await db.collection('users').doc(currentUser.email).update({
                    readingList: firebase.firestore.FieldValue.arrayRemove(entryId)
                });

                showNotification('Removed from reading list', 'success');

                // Update the star icon if it's on the page
                const starButton = document.querySelector(`button[data-entry-id="${entryId}"]`);
                if (starButton) {
                    const icon = starButton.querySelector('i');
                    icon.className = 'far fa-star';
                    starButton.title = 'Add to reading list';
                }

                // Reload the reading list
                await loadReadingList();
            } catch (error) {
                console.error('Error removing from reading list:', error);
                showNotification('Failed to remove from reading list', 'error');
            }
        }

        // Initialize reading list stars on page load
        window.initializeReadingListStars = async function() {
            const currentUser = window.auth?.getCurrentUser();
            if (!currentUser) return;

            try {
                const db = window.firebaseApp.db;
                const userRef = db.collection('users').doc(currentUser.email);
                const userDoc = await userRef.get();

                const readingList = userDoc.data()?.readingList || [];

                // Update all star buttons to reflect saved state
                document.querySelectorAll('.reading-list-star').forEach(button => {
                    const entryId = button.getAttribute('data-entry-id');
                    if (readingList.includes(entryId)) {
                        const icon = button.querySelector('i');
                        icon.className = 'fas fa-star';
                        button.title = 'Remove from reading list';
                    }
                });
            } catch (error) {
                console.error('Error initializing reading list stars:', error);
            }
        }

        // Duplicate Detection Functions
        async function checkForDuplicates(newBibliography) {
            try {
                const db = window.firebaseApp.db;

                // Get all published contributions
                const snapshot = await db.collection('contributions')
                    .where('status', '==', 'published')
                    .get();

                const newAuthor = newBibliography.authors || '';
                const newTitle = newBibliography.title || '';

                // Check each existing entry for similarity
                for (const doc of snapshot.docs) {
                    const data = doc.data();
                    const bib = data.bibliography || {};

                    const existingAuthor = bib.authors || '';
                    const existingTitle = bib.title || '';

                    // Calculate similarity for author AND title
                    const authorSimilarity = calculateSimilarity(newAuthor, existingAuthor);
                    const titleSimilarity = calculateSimilarity(newTitle, existingTitle);

                    // Match if BOTH author AND title are similar (85% threshold)
                    if (authorSimilarity >= 85 && titleSimilarity >= 85) {
                        console.log(`Potential duplicate found: ${doc.id}`);
                        console.log(`  Author similarity: ${authorSimilarity.toFixed(1)}%`);
                        console.log(`  Title similarity: ${titleSimilarity.toFixed(1)}%`);

                        return {
                            id: doc.id,
                            data: data,
                            authorSimilarity,
                            titleSimilarity
                        };
                    }
                }

                // No duplicates found
                return null;

            } catch (error) {
                console.error('Error checking for duplicates:', error);
                throw error;
            }
        }

        function showDuplicateDetectionModal(duplicate, formData) {
            const bib = duplicate.data.bibliography;
            const primaryCat = duplicate.data.primaryCategory || { topic: duplicate.data.topic, subtopic: duplicate.data.subtopic };

            // Format existing citation
            const existingCitation = formatCitationFromBib(bib);
            document.getElementById('duplicate-existing-citation').innerHTML = existingCitation;
            document.getElementById('duplicate-existing-summary').textContent = duplicate.data.summary;

            // Show location
            const topicLabel = primaryCat.topic || '';
            const subtopicLabel = primaryCat.subtopic ? ` â†’ ${primaryCat.subtopic}` : '';
            document.getElementById('duplicate-existing-location').textContent = `${topicLabel}${subtopicLabel}`;

            // Format your citation
            const yourCitation = formatCitationFromBib(formData.bibliography);
            document.getElementById('duplicate-your-citation').innerHTML = yourCitation;
            document.getElementById('duplicate-your-summary').textContent = formData.summary;

            // Store data for later use
            document.getElementById('duplicate-existing-id').value = duplicate.id;
            document.getElementById('duplicate-form-data').value = JSON.stringify(formData);

            // Show modal
            document.getElementById('duplicate-detection-modal').style.display = 'flex';
            document.body.style.overflow = 'hidden';
        }

        function formatCitationFromBib(bib) {
            const authors = bib.authors;
            const year = bib.year;
            const title = bib.title;

            if (bib.pubType === 'journal') {
                return `${authors} (${year}). "${title}." <em>${bib.journal || ''}</em>${bib.volume ? `, ${bib.volume}` : ''}${bib.issue ? `(${bib.issue})` : ''}${bib.pages ? `, pp ${bib.pages}` : ''}.`;
            } else if (bib.pubType === 'book') {
                return `${authors} (${year}). <em>${title}</em>. ${bib.publisher || ''}${bib.location ? `, ${bib.location}` : ''}.`;
            } else if (bib.pubType === 'chapter') {
                return `${authors} (${year}). "${title}." In ${bib.editors ? bib.editors + ', ' : ''}<em>${bib.bookTitle || ''}</em>${bib.chapterPages ? `, pp ${bib.chapterPages}` : ''}. ${bib.chapterPublisher || ''}.`;
            } else {
                return `${authors} (${year}). "${title}."`;
            }
        }

        function closeDuplicateDetection() {
            document.getElementById('duplicate-detection-modal').style.display = 'none';
            document.body.style.overflow = 'auto';
        }

        async function confirmDuplicate() {
            // User confirms it's the same source - add as perspective
            const existingId = document.getElementById('duplicate-existing-id').value;
            const formData = JSON.parse(document.getElementById('duplicate-form-data').value);

            try {
                const db = window.firebaseApp.db;
                const currentUser = window.auth.getCurrentUser();

                // Create perspective from the user's summary
                const perspective = {
                    text: formData.summary,
                    authorName: currentUser.name,
                    authorEmail: currentUser.email,
                    createdAt: new Date()
                };

                // Add perspective to existing entry
                await db.collection('contributions').doc(existingId).update({
                    perspectives: firebase.firestore.FieldValue.arrayUnion(perspective)
                });

                closeDuplicateDetection();
                closeContributionModal();

                showNotification('Your perspective has been added to the existing entry!', 'success');

                // Reload to show the new perspective
                setTimeout(() => window.location.reload(), 1000);

            } catch (error) {
                console.error('Error adding perspective:', error);
                showNotification('Failed to add perspective: ' + error.message, 'error');
            }
        }

        async function rejectDuplicate() {
            // User says it's a different source - proceed with creating new entry
            const formData = JSON.parse(document.getElementById('duplicate-form-data').value);

            closeDuplicateDetection();

            try {
                // Show loading state
                const submitBtn = document.getElementById('submit-btn');
                submitBtn.disabled = true;
                submitBtn.textContent = 'Submitting...';

                // Call Firebase function to save contribution
                const saveContribution = window.firebaseApp.functions.httpsCallable('saveContribution');
                const result = await saveContribution(formData);

                if (result.data.success) {
                    showNotification('Thank you for your contribution! Your entry has been published.', 'success');
                    closeContributionModal();
                    window.location.reload();
                } else {
                    throw new Error(result.data.error || 'Failed to save contribution');
                }
            } catch (error) {
                console.error('Error submitting contribution:', error);
                showNotification('Error submitting contribution: ' + error.message, 'error');

                // Reset button
                const submitBtn = document.getElementById('submit-btn');
                submitBtn.disabled = false;
                submitBtn.textContent = 'Submit Entry';
            }
        }

        // Update subtopic options based on selected topic
        function updateEditSubtopicOptions(preselectedValue) {
            const topicSelect = document.getElementById('edit-topic');
            const subtopicSelect = document.getElementById('edit-subtopic');
            const selectedTopic = topicSelect.value;

            // Clear existing options
            subtopicSelect.innerHTML = '<option value="">Select Subtopic</option>';

            if (selectedTopic && subtopicsByTopic[selectedTopic]) {
                subtopicsByTopic[selectedTopic].forEach(subtopic => {
                    const option = document.createElement('option');
                    option.value = subtopic.value;
                    option.textContent = subtopic.label;
                    subtopicSelect.appendChild(option);
                });
            }

            // Set the preselected value if provided
            if (preselectedValue) {
                subtopicSelect.value = preselectedValue;
            }
        }

        // Update visible fields based on publication type
        function updateEditPubTypeFields() {
            const pubType = document.getElementById('edit-bib-pubtype').value;
            const journalFields = document.getElementById('edit-journal-fields');
            const bookFields = document.getElementById('edit-book-fields');

            if (pubType === 'journal') {
                journalFields.style.display = 'grid';
                bookFields.style.display = 'none';
            } else if (pubType === 'book' || pubType === 'chapter') {
                journalFields.style.display = 'none';
                bookFields.style.display = 'grid';
            } else {
                journalFields.style.display = 'none';
                bookFields.style.display = 'none';
            }
        }

        // Save edited contribution
        async function saveEditedContribution(event) {
            event.preventDefault();

            const contributionId = document.getElementById('edit-contribution-id').value;

            try {
                const db = window.firebaseApp.db;

                // Get form data
                const topic = document.getElementById('edit-topic').value;
                const subtopic = document.getElementById('edit-subtopic').value;
                const contributorName = document.getElementById('edit-contributor').value;
                const secondaryCategories = getEditSecondaryCategories();

                // Determine if this is an EdTech product or regular entry
                const isEdTech = document.getElementById('edit-edtech-fields').style.display !== 'none';

                let updateData = {
                    primaryCategory: {
                        topic: topic,
                        subtopic: subtopic
                    },
                    secondaryCategories: secondaryCategories,
                    // Keep old fields for backward compatibility
                    topic: topic,
                    subtopic: subtopic,
                    authorName: contributorName,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };

                if (isEdTech) {
                    // EdTech product entry
                    const categories = Array.from(document.querySelectorAll('.edit-edtech-category-checkbox:checked')).map(cb => cb.value);

                    updateData.type = 'edtech-product';
                    updateData.edtechProduct = {
                        name: document.getElementById('edit-edtech-product-name').value.trim(),
                        url: document.getElementById('edit-edtech-product-url').value.trim() || null,
                        categories: categories,
                        targetConsumers: document.getElementById('edit-edtech-target-consumers').value.trim(),
                        painPoint: document.getElementById('edit-edtech-pain-point').value.trim(),
                        competitors: document.getElementById('edit-edtech-competitors').value.trim() || null,
                        businessModel: document.getElementById('edit-edtech-business-model').value,
                        economicModel: document.getElementById('edit-edtech-economic-model').value,
                        differentiators: document.getElementById('edit-edtech-differentiators').value.trim(),
                        affordances: document.getElementById('edit-edtech-affordances').value.trim(),
                        limitations: document.getElementById('edit-edtech-limitations').value.trim()
                    };
                } else {
                    // Regular research entry
                    const summary = document.getElementById('edit-summary').value;
                    const bibliography = {
                        title: document.getElementById('edit-bib-title').value,
                        authors: document.getElementById('edit-bib-authors').value,
                        year: document.getElementById('edit-bib-year').value,
                        url: document.getElementById('edit-bib-url').value,
                        pubType: document.getElementById('edit-bib-pubtype').value,
                        journal: document.getElementById('edit-bib-journal').value,
                        volume: document.getElementById('edit-bib-volume').value,
                        issue: document.getElementById('edit-bib-issue').value,
                        pages: document.getElementById('edit-bib-pages').value,
                        publisher: document.getElementById('edit-bib-publisher').value,
                        location: document.getElementById('edit-bib-location').value,
                        tags: document.getElementById('edit-tags').value.split(',').map(t => t.trim()).filter(t => t)
                    };

                    updateData.summary = summary;
                    updateData.bibliography = bibliography;
                }

                // Update contribution in Firestore
                await db.collection('contributions').doc(contributionId).update(updateData);

                showNotification('Contribution updated successfully', 'success');
                closeEditContribution();

                // Force hard reload to show updated contribution
                window.location.reload(true);
            } catch (error) {
                console.error('Error updating contribution:', error);
                showNotification('Failed to update contribution: ' + error.message, 'error');
            }
        }

        // Delete contribution from modal
        async function deleteContributionFromModal() {
            const contributionId = document.getElementById('edit-contribution-id').value;

            if (!contributionId) {
                showNotification('No contribution selected', 'error');
                return;
            }

            try {
                const currentUser = window.auth.getCurrentUser();
                if (!currentUser) {
                    showNotification('Please sign in to delete entries.', 'error');
                    return;
                }

                const db = window.firebaseApp.db;
                const doc = await db.collection('contributions').doc(contributionId).get();

                if (!doc.exists) {
                    showNotification('Entry not found', 'error');
                    return;
                }

                const data = doc.data();

                // Check permissions
                const isAdmin = currentUser.role === 'admin';
                const isOwner = data.authorEmail === currentUser.email || data.userEmail === currentUser.email;

                if (!isAdmin && !isOwner) {
                    showNotification('You can only delete your own contributions.', 'error');
                    return;
                }

                // Check if others have added perspectives
                const perspectives = data.perspectives || [];
                const hasPerspectivesFromOthers = perspectives.some(p =>
                    p.authorEmail && p.authorEmail !== currentUser.email
                );

                if (hasPerspectivesFromOthers) {
                    showNotification('Cannot delete: Other users have added perspectives to this entry.', 'error');
                    return;
                }

                if (!confirm('Are you sure you want to delete this entry? This cannot be undone.')) {
                    return;
                }

                // Delete from Firestore
                await db.collection('contributions').doc(contributionId).delete();
                console.log(`Deleted contribution ${contributionId} from Firestore`);

                showNotification('Entry deleted successfully', 'success');
                closeEditContribution();

                // Reload page to reflect deletion
                window.location.reload(true);
            } catch (error) {
                console.error('Error deleting contribution:', error);
                showNotification('Failed to delete entry: ' + error.message, 'error');
            }
        }

        // Delete all contributions from Firestore
        async function deleteAllContributions() {
            if (!confirm('âš ï¸ WARNING: This will permanently delete ALL contributions from Firestore. This cannot be undone.\n\nAre you absolutely sure you want to proceed?')) {
                return;
            }

            // Double confirmation
            if (!confirm('Final confirmation: Delete ALL contributions? Type YES in the console to confirm.')) {
                return;
            }

            try {
                const db = window.firebaseApp.db;
                showNotification('Fetching all contributions...', 'info');

                const snapshot = await db.collection('contributions').get();

                if (snapshot.empty) {
                    showNotification('No contributions to delete', 'info');
                    return;
                }

                const totalCount = snapshot.size;
                showNotification(`Found ${totalCount} contributions. Deleting...`, 'info');

                // Delete in batches of 500 (Firestore limit)
                const batchSize = 500;
                let deletedCount = 0;

                while (deletedCount < snapshot.size) {
                    const batch = db.batch();
                    const docsToDelete = snapshot.docs.slice(deletedCount, deletedCount + batchSize);

                    docsToDelete.forEach(doc => {
                        console.log(`Deleting: ${doc.id} (topic: ${doc.data().topic})`);
                        batch.delete(doc.ref);
                    });

                    await batch.commit();
                    deletedCount += docsToDelete.length;
                    console.log(`Progress: ${deletedCount}/${snapshot.size} deleted`);

                    showNotification(`Progress: ${deletedCount}/${totalCount} deleted`, 'info');
                }

                showNotification(`âœ“ All ${totalCount} contributions deleted successfully`, 'success');

                // Reload page after a short delay
                setTimeout(() => {
                    window.location.reload(true);
                }, 2000);

            } catch (error) {
                console.error('Error deleting contributions:', error);
                showNotification('Failed to delete contributions: ' + error.message, 'error');
            }
        }

        // Migrate hardcoded HTML entries to Firestore
        async function migrateHardcodedEntries() {
            if (!confirm('This will migrate all hardcoded HTML entries to Firestore. Continue?')) {
                return;
            }

            const statusDiv = document.getElementById('migration-status');
            statusDiv.style.display = 'block';
            statusDiv.innerHTML = '<strong>Starting migration...</strong>';

            try {
                const db = window.firebaseApp.db;
                const allEntries = document.querySelectorAll('.bib-entry');
                const totalEntries = allEntries.length;
                let migratedCount = 0;
                let skippedCount = 0;
                let errorCount = 0;

                statusDiv.innerHTML = `<strong>Found ${totalEntries} entries. Starting migration...</strong>`;

                // Process entries in batches
                for (let i = 0; i < allEntries.length; i++) {
                    const entry = allEntries[i];

                    // Skip if already has firestore-id (already migrated)
                    if (entry.hasAttribute('data-firestore-id')) {
                        skippedCount++;
                        continue;
                    }

                    try {
                        // Extract entry data
                        const entryId = entry.id;
                        const citation = entry.querySelector('.bib-citation');
                        const annotationText = entry.querySelector('.annotation-text');
                        const authorDiv = entry.querySelector('.annotation-author');
                        const tags = entry.getAttribute('data-tags') || '';

                        if (!citation || !annotationText) {
                            console.warn(`Skipping entry ${entryId}: missing required elements`);
                            skippedCount++;
                            continue;
                        }

                        // Extract citation info
                        const sourceUrl = citation.getAttribute('data-source-url') || '';
                        const sourceTitle = citation.getAttribute('data-source-title') || '';
                        const citationText = citation.textContent.replace('â–¼', '').replace('â–²', '').trim();

                        // Parse citation to extract author, year, title
                        const parsed = parseCitation(citationText);

                        // Extract annotation
                        const annotationHTML = annotationText.innerHTML;
                        const authorText = authorDiv ? authorDiv.textContent : '';
                        const summary = annotationHTML.split('<div class="annotation-author">')[0].trim();

                        // Parse author and date
                        const authorMatch = authorText.match(/^(.+?)(?:,?\s+(\d{1,2}\/\d{1,2}\/\d{2,4}|\w+ \d{1,2},? \d{4}))?$/);
                        const authorName = authorMatch ? authorMatch[1].trim() : 'Legacy Entry';

                        // Determine topic/subtopic from page structure
                        // Build subtopic-to-topic mapping from navigation structure
                        const subtopicToTopicMap = {};
                        document.querySelectorAll('.subtopic-card[onclick]').forEach(card => {
                            const onclick = card.getAttribute('onclick');
                            const match = onclick.match(/showSubtopicPage\('([^']+)',\s*'([^']+)'\)/);
                            if (match) {
                                const topicId = match[1];
                                const subtopicId = match[2];
                                subtopicToTopicMap[subtopicId] = topicId;
                            }
                        });

                        // Find which page div contains this entry (skip the entry's own ID)
                        // Look for the parent that contains .bibliography-container
                        let parentPage = entry.parentElement;
                        while (parentPage && parentPage !== document.body) {
                            // Check if this element has an ID and contains a bibliography-container
                            if (parentPage.id && parentPage.querySelector('.bibliography-container')) {
                                break;
                            }
                            parentPage = parentPage.parentElement;
                        }

                        let topic = '';
                        let subtopic = '';

                        if (parentPage && parentPage.id) {
                            const pageId = parentPage.id;
                            console.log(`Entry ${entryId} found in page: ${pageId}`);

                            // Check if this page ID is a known subtopic
                            if (subtopicToTopicMap[pageId]) {
                                // It's a subtopic page
                                subtopic = pageId;
                                topic = subtopicToTopicMap[pageId];
                                console.log(`  -> Mapped to topic=${topic}, subtopic=${subtopic}`);
                            } else {
                                // It might be a topic page itself
                                // Check if it matches known topic IDs
                                const knownTopics = ['understanding-users', 'evaluating-tools', 'assessing-impacts',
                                                     'innovating-edtech', 'learning-science', 'research-methods'];
                                if (knownTopics.includes(pageId)) {
                                    topic = pageId;
                                    subtopic = '';
                                    console.log(`  -> Topic page: ${topic}`);
                                } else {
                                    // Default fallback
                                    topic = 'general';
                                    subtopic = '';
                                    console.log(`  -> Defaulting to general (unknown page ID)`);
                                }
                            }
                        } else {
                            console.warn(`Entry ${entryId}: Could not find parent page with bibliography-container`);
                            topic = 'general';
                            subtopic = '';
                        }

                        // Create contribution document
                        const contributionData = {
                            topic: topic,
                            subtopic: subtopic,
                            bibliography: {
                                authors: parsed.authors || 'Unknown',
                                year: parsed.year || new Date().getFullYear(),
                                title: parsed.title || sourceTitle || 'Untitled',
                                pubType: 'journal',
                                url: sourceUrl,
                                tags: tags.split(',').filter(t => t.trim())
                            },
                            summary: summary,
                            authorName: authorName,
                            authorEmail: 'migrated@system',
                            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                            updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                            status: 'published',
                            migratedFrom: 'html',
                            originalId: entryId
                        };

                        // Save to Firestore
                        const docRef = await db.collection('contributions').add(contributionData);

                        // Mark entry as migrated
                        entry.setAttribute('data-firestore-id', docRef.id);

                        migratedCount++;

                        // Update status every 5 entries
                        if (migratedCount % 5 === 0) {
                            statusDiv.innerHTML = `
                                <strong>Migration Progress:</strong><br>
                                Migrated: ${migratedCount} / ${totalEntries}<br>
                                Skipped: ${skippedCount}<br>
                                Errors: ${errorCount}
                            `;
                        }
                    } catch (error) {
                        console.error(`Error migrating entry:`, error);
                        errorCount++;
                    }
                }

                statusDiv.innerHTML = `
                    <strong style="color: #28a745;">âœ“ Migration Complete!</strong><br>
                    Migrated: ${migratedCount}<br>
                    Skipped: ${skippedCount}<br>
                    Errors: ${errorCount}
                `;

                showNotification(`Migration complete: ${migratedCount} entries migrated`, 'success');

                // Reload contributions list
                await loadContributions();
            } catch (error) {
                console.error('Migration error:', error);
                statusDiv.innerHTML = `<strong style="color: #dc3545;">Migration failed: ${error.message}</strong>`;
                showNotification('Migration failed', 'error');
            }
        }

        // Parse citation text to extract structured data
        function parseCitation(citationText) {
            const result = {
                authors: '',
                year: null,
                title: ''
            };

            // Try to extract year (matches 4 digits in parentheses)
            const yearMatch = citationText.match(/\((\d{4})\)/);
            if (yearMatch) {
                result.year = parseInt(yearMatch[1]);
            }

            // Extract authors (text before year)
            if (yearMatch) {
                result.authors = citationText.substring(0, yearMatch.index).trim();
                // Remove trailing comma or period
                result.authors = result.authors.replace(/[,.]$/, '').trim();
            }

            // Extract title (text in quotes after year)
            const titleMatch = citationText.match(/[""]([^"""]+)[""]/) || citationText.match(/"([^"]+)"/);
            if (titleMatch) {
                result.title = titleMatch[1];
            }

            return result;
        }

        // Add search functionality
        document.addEventListener('DOMContentLoaded', () => {
            const searchInput = document.getElementById('admin-search');
            if (searchInput) {
                searchInput.addEventListener('input', (e) => {
                    const searchTerm = e.target.value.toLowerCase();
                    const userDivs = document.querySelectorAll('#users-list > div > div');
                    userDivs.forEach(div => {
                        const email = div.querySelector('strong').textContent.toLowerCase();
                        div.parentElement.style.display = email.includes(searchTerm) ? 'block' : 'none';
                    });
                });
            }
        });

        // Use event delegation on document for better cross-browser reliability
        let annotationDelegationInitialized = false;

        function initializeAnnotations() {
            // Only set up the delegated listener once
            if (!annotationDelegationInitialized) {
                document.addEventListener('click', function(event) {
                    // Find if click was on a citation element
                    const citation = event.target.closest('.bib-citation');

                    if (citation) {
                        // Don't toggle if clicking on links or buttons
                        if (event.target.closest('a') || event.target.closest('button')) {
                            return;
                        }

                        toggleAnnotation(citation);
                    }
                });
                annotationDelegationInitialized = true;
            }

            // Add pointer cursor to all citations
            document.querySelectorAll('.bib-citation').forEach(citation => {
                citation.style.cursor = 'pointer';
            });
        }

        function toggleAnnotation(clickedElement) {
            // Find the annotation container relative to the clicked citation
            const entry = clickedElement.closest('.bib-entry');
            if (!entry) {
                console.error('Could not find parent .bib-entry element');
                return;
            }

            const annotationContainer = entry.querySelector('.bib-annotation-container');
            if (!annotationContainer) {
                console.error('Annotation container not found in this entry');
                return;
            }

            const isCurrentlyVisible = annotationContainer.style.display === 'block';

            // Close all annotations and reset all indicators
            document.querySelectorAll('.bib-annotation-container').forEach(container => {
                container.style.display = 'none';
            });
            document.querySelectorAll('.collapse-indicator').forEach(indicator => {
                indicator.classList.remove('expanded');
            });

            // Open this annotation if it wasn't already open
            if (!isCurrentlyVisible) {
                annotationContainer.style.display = 'block';
                annotationContainer.scrollIntoView({ behavior: 'smooth', block: 'nearest' });

                // Find and rotate the indicator for this entry
                const indicator = entry.querySelector('.collapse-indicator');
                if (indicator) {
                    indicator.classList.add('expanded');
                }
            }
        }

        function viewSource(button) {
            const entry = button.closest('.bib-entry');
            const citation = entry.querySelector('.bib-citation');
            const sourceUrl = citation.getAttribute('data-source-url');
            window.open(sourceUrl, '_blank');
        }

        function closeSourceModal() {
            document.getElementById('sourceModal').style.display = 'none';
        }

        function initializeFilteringSystem() {
            document.querySelectorAll('.pathway-card .view-more').forEach(link => {
                const tag = link.getAttribute('data-tag');
                if (tag) {
                    link.addEventListener('click', function(e) {
                        e.preventDefault();
                        filterEntriesByTag(tag);
                    });
                }
            });
        }

        function filterEntriesByTag(tag) {
            navigationState = {
                currentView: 'filtered',
                topicId: null,
                subtopicId: null,
                subsubtopicId: null,
                pathwayName: null,
                filterTag: tag
            };
            
            document.body.classList.add('show-topics');
            document.body.classList.add('show-breadcrumbs');
            
            document.querySelectorAll('.topic-pages > div').forEach(div => {
                div.style.display = 'none';
            });
            
            let filteredContainer = document.getElementById('filtered-results');
            if (!filteredContainer) {
                filteredContainer = document.createElement('div');
                filteredContainer.id = 'filtered-results';
                filteredContainer.className = 'topic-container';
                document.querySelector('.topic-pages').appendChild(filteredContainer);
            }
            
            filteredContainer.innerHTML = '';
            
            const header = document.createElement('div');
            header.className = 'topic-page-header';
            header.innerHTML = `
                <h1>Research Path: ${tag.split('-').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ')}</h1>
                <p>A curated collection of resources for this research path.</p>
            `;
            filteredContainer.appendChild(header);
            
            const matchingEntries = document.querySelectorAll(`.bib-entry[data-tags*="${tag}"]`);
            
            const entriesContainer = document.createElement('div');
            entriesContainer.className = 'bibliography-container';
            filteredContainer.appendChild(entriesContainer);
            
            if (matchingEntries.length === 0) {
                entriesContainer.innerHTML = '<p>No entries found for this research path. Please check again as our collection grows.</p>';
            } else {
                const entriesArray = Array.from(matchingEntries);
                
                entriesArray.sort((a, b) => {
                    const textA = a.querySelector('.bib-citation').textContent.trim().toLowerCase();
                    const textB = b.querySelector('.bib-citation').textContent.trim().toLowerCase();
                    return textA.localeCompare(textB);
                });
                
                entriesArray.forEach(originalEntry => {
                    const clonedEntry = originalEntry.cloneNode(true);
                    
                    const viewAnnotationsButton = clonedEntry.querySelector('.bib-button:nth-child(2)');
                    if (viewAnnotationsButton) {
                        const onclick = viewAnnotationsButton.getAttribute('onclick');
                        if (onclick) {
                            const match = onclick.match(/toggleAnnotation\('([^']+)'\)/);
                            if (match && match[1]) {
                                const baseId = match[1];
                                
                                const originalAnnotationContainer = document.getElementById(`${baseId}-annotation`);
                                if (originalAnnotationContainer) {
                                    const clonedAnnotationContainer = originalAnnotationContainer.cloneNode(true);
                                    clonedEntry.appendChild(clonedAnnotationContainer);
                                    
                                    viewAnnotationsButton.removeAttribute('onclick');
                                    viewAnnotationsButton.addEventListener('click', function() {
                                        const annotationContainer = clonedEntry.querySelector('.bib-annotation-container');
                                        if (annotationContainer) {
                                            const isVisible = annotationContainer.style.display === 'block';
                                            if (isVisible) {
                                                annotationContainer.style.display = 'none';
                                            } else {
                                                entriesContainer.querySelectorAll('.bib-annotation-container').forEach(container => {
                                                    container.style.display = 'none';
                                                });
                                                
                                                annotationContainer.style.display = 'block';
                                                
                                                setTimeout(() => {
                                                    annotationContainer.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                                                }, 50);
                                            }
                                        }
                                    });
                                }
                            }
                        }
                    }
                    
                    const viewSourceButton = clonedEntry.querySelector('.bib-button:nth-child(1)');
                    if (viewSourceButton) {
                        viewSourceButton.removeAttribute('onclick');
                        viewSourceButton.addEventListener('click', function() {
                            const citation = this.closest('.bib-citation');
                            const sourceUrl = citation.getAttribute('data-source-url');
                            if (sourceUrl) {
                                window.open(sourceUrl, '_blank');
                            }
                        });
                    }
                    
                    const addPerspectiveBtn = clonedEntry.querySelector('.add-perspective-btn');
                    if (addPerspectiveBtn) {
                        addPerspectiveBtn.removeAttribute('onclick');
                        addPerspectiveBtn.addEventListener('click', function(e) {
                            e.preventDefault();
                            openContributePopup();
                        });
                    }
                    
                    entriesContainer.appendChild(clonedEntry);
                });
            }
            
            filteredContainer.style.display = 'block';
            
            document.querySelector('.landing-page').style.display = 'none';
            document.querySelector('.topic-pages').style.display = 'block';
            
            updateBreadcrumbs();
            window.scrollTo(0, 0);
        }

        function attachEventListenersToEntries(container) {
            container.querySelectorAll('.bib-button').forEach(button => {
                if (button.textContent.includes('View Annotations')) {
                    const newButton = button.cloneNode(true);
                    button.parentNode.replaceChild(newButton, button);
                    button = newButton;
                    
                    const onclick = button.getAttribute('onclick');
                    if (onclick && onclick.includes('toggleAnnotation')) {
                        const match = onclick.match(/toggleAnnotation\('([^']+)'\)/);
                        if (match && match[1]) {
                            const id = match[1];
                            button.addEventListener('click', function(e) {
                                e.preventDefault();
                                toggleAnnotation(id);
                            });
                        }
                    }
                }
                
                if (button.textContent.includes('View Source')) {
                    const newButton = button.cloneNode(true);
                    button.parentNode.replaceChild(newButton, button);
                    button = newButton;
                    
                    button.addEventListener('click', function(e) {
                        e.preventDefault();
                        viewSource(this);
                    });
                }
            });
            
            container.querySelectorAll('.add-perspective-btn').forEach(button => {
                const newButton = button.cloneNode(true);
                button.parentNode.replaceChild(newButton, button);
                button = newButton;
                
                button.addEventListener('click', function(e) {
                    e.preventDefault();
                    openContributePopup();
                });
            });
        }

        // DEPRECATED: This function is no longer needed
        // Contributions are now loaded globally by loadFirestoreContributions() in entriesIndex.js
        // which handles all topics/subtopics and multi-category entries
        /*
        async function loadContributionsForSubtopic(topicId, subtopicId) {
            // Function removed to prevent duplicate entries
            // All entries are loaded by loadFirestoreContributions() in entriesIndex.js
            console.log('loadContributionsForSubtopic is deprecated - using global loader instead');
        }
        */

        // Create HTML for a bibliography entry from contribution data
        function createEntryHTML(contributionId, data) {
            const bib = data.bibliography;
            const url = bib.url || (bib.doi ? `https://doi.org/${bib.doi}` : '#');
            const title = bib.title || '';

            // Create a unique ID for the annotation container
            const annotationId = `contrib-${contributionId}-annotation`;

            return `
                <div class="bib-entry" data-contribution-id="${contributionId}">
                    <div class="bib-citation"
                        data-source-url="${url}"
                        data-source-title="${title}">
                        ${data.citation}
                        <span class="collapse-indicator"></span>
                    </div>
                    <div class="bib-annotation-container" id="${annotationId}">
                        <div class="bib-annotation">
                            <div class="annotation-text">
                                ${data.summary}
                                <div class="annotation-author" style="display: flex; align-items: center; gap: 8px;">
                                    ${data.authorPicture ? `<img src="${data.authorPicture}" style="width: 24px; height: 24px; border-radius: 50%; object-fit: cover; border: 1px solid #ddd;">` : ''}
                                    <span>${data.authorName} ${new Date(data.createdAt?.toDate ? data.createdAt.toDate() : data.createdAt).toLocaleDateString()}</span>
                                </div>
                            </div>
                        </div>
                        <div class="annotation-actions">
                            <button class="bib-button" onclick="viewSource(this)">View Source</button>
                            <button class="add-perspective-btn">Add Your Perspective</button>
                        </div>
                    </div>
                </div>
            `;
        }

        function updateEntryCounter() {
            console.log("Updating entry counter...");

            // Count unique entries only (by data-contribution-id)
            // Only count entries from main topic/subtopic pages, not contributor pages
            const uniqueEntryIds = new Set();

            // Get only pages that are topics/subtopics (not contributor pages)
            const mainPages = document.querySelectorAll('.topic-pages > div[id]');
            mainPages.forEach(page => {
                // Skip contributor pages (IDs start with "contributor-")
                if (page.id.startsWith('contributor-')) {
                    return;
                }

                // Count unique entries in this page
                page.querySelectorAll('.bib-entry').forEach(entry => {
                    const entryId = entry.getAttribute('data-contribution-id');
                    if (entryId) {
                        uniqueEntryIds.add(entryId);
                    }
                });
            });

            const uniqueCount = uniqueEntryIds.size;
            console.log(`Found ${uniqueCount} unique bibliography entries (excluding contributor pages)`);

            const counter = document.getElementById('entry-counter');
            if (counter) {
                counter.textContent = uniqueCount;
                console.log(`Counter updated to: ${uniqueCount}`);
            } else {
                console.log("Counter element not found!");
            }
        }

        // Update visibility of "Content in Development" placeholders
        function updateContentPlaceholders() {
            // Find all pages (topics and subtopics)
            const allPages = document.querySelectorAll('.topic-pages > div[id]');

            allPages.forEach(page => {
                const topicContent = page.querySelector('.topic-content');
                if (!topicContent) return;

                const bibContainer = topicContent.querySelector('.bibliography-container');
                const placeholder = topicContent.querySelector('.empty-content-placeholder');

                // If page has a bibliography container
                if (bibContainer) {
                    const entryCount = bibContainer.querySelectorAll('.bib-entry').length;

                    // Hide/show external placeholder div
                    if (placeholder) {
                        placeholder.style.display = entryCount > 0 ? 'none' : 'block';
                    }

                    // Also check for inline placeholder paragraphs in bibliography container
                    const inlinePlaceholder = bibContainer.querySelector('p[style*="text-align: center"]');
                    if (inlinePlaceholder && inlinePlaceholder.textContent.includes('No bibliography entries yet')) {
                        inlinePlaceholder.style.display = entryCount > 0 ? 'none' : 'block';
                    }
                }
            });

            console.log('âœ“ Updated content placeholders');
        }

        function logDebugInfo() {
            console.log("Available tags in bibliography entries:");
            const allTags = new Set();
            document.querySelectorAll('.bib-entry').forEach(entry => {
                const tags = entry.getAttribute('data-tags');
                if (tags) {
                    tags.split(',').forEach(tag => allTags.add(tag.trim()));
                }
            });
            console.log(Array.from(allTags).sort());
        }

        // ===== PROGRESS DASHBOARD FUNCTIONS =====

        async function loadProgressDashboard() {
            const dashboard = document.getElementById('progress-dashboard');
            if (!dashboard) return;

            const currentUser = window.auth && window.auth.getCurrentUser ? window.auth.getCurrentUser() : null;

            // Only show for users with pacing requirements
            if (!currentUser || !window.auth.requiresPacing()) {
                dashboard.classList.remove('show');
                return;
            }

            try {
                // Fetch progress data
                const progressData = await window.auth.getProgressStatus();

                if (!progressData || !progressData.requiresPacing) {
                    dashboard.classList.remove('show');
                    return;
                }

                // Show dashboard
                dashboard.classList.add('show');

                // Update status badge
                const statusBadge = document.getElementById('progress-status-badge');
                statusBadge.textContent = progressData.status.replace('-', ' ').toUpperCase();
                statusBadge.className = `progress-status-badge ${progressData.status}`;

                // Update info cards
                document.getElementById('progress-current-period').textContent = `${progressData.currentPeriod} (${progressData.contributionsThisPeriod}/${progressData.maxContributionsPerPeriod})`;
                document.getElementById('progress-total-periods').textContent = progressData.totalPeriods;
                document.getElementById('progress-user-contributions').textContent = progressData.totalContributions;
                document.getElementById('progress-expected-contributions').textContent = `${progressData.expectedMinimum} min`;

                // Calculate and update progress bar
                const progressPercentage = progressData.expectedMinimum > 0 ?
                    Math.round((progressData.totalContributions / progressData.expectedMinimum) * 100) : 0;

                const progressBarFill = document.getElementById('progress-bar-fill');
                const progressPercentageEl = document.getElementById('progress-percentage');
                const progressBarText = document.getElementById('progress-bar-text');

                progressBarFill.style.width = `${Math.min(progressPercentage, 100)}%`;
                progressPercentageEl.textContent = `${progressPercentage}%`;
                progressBarText.textContent = `${progressData.totalContributions} / ${progressData.expectedMinimum} minimum`;

                // Apply status class to progress bar
                progressBarFill.className = 'progress-bar-fill';
                if (progressData.status === 'ahead') {
                    progressBarFill.classList.add('ahead');
                } else if (progressData.status === 'behind') {
                    progressBarFill.classList.add('behind');
                }

                // Show notifications
                displayProgressNotifications(progressData);

                // Display contributions list
                displayContributionsList(progressData);

                console.log('âœ“ Progress dashboard loaded', progressData);
            } catch (error) {
                console.error('Error loading progress dashboard:', error);
                dashboard.classList.remove('show');
            }
        }

        function displayProgressNotifications(progressData) {
            const notificationArea = document.getElementById('progress-notification-area');
            notificationArea.innerHTML = '';

            // Show notification if user can't contribute (reached max for period)
            if (!progressData.canContribute && progressData.nextAllowedDate) {
                const nextDate = new Date(progressData.nextAllowedDate);
                const notification = document.createElement('div');
                notification.className = 'progress-notification error';
                notification.innerHTML = `
                    <i class="fas fa-exclamation-circle"></i>
                    <div>
                        <strong>You've reached the maximum for this period!</strong>
                        You've submitted ${progressData.contributionsThisPeriod} out of ${progressData.maxContributionsPerPeriod} allowed contributions for Period ${progressData.currentPeriod}.
                        You can submit again starting ${nextDate.toLocaleDateString('en-US', {
                            month: 'long',
                            day: 'numeric',
                            year: 'numeric'
                        })}.
                    </div>
                `;
                notificationArea.appendChild(notification);
            }
            // Show notification if user is behind (missing minimums in past periods)
            else if (progressData.status === 'behind' && progressData.periodsMissingMinimum > 0) {
                const notification = document.createElement('div');
                notification.className = 'progress-notification warning';
                notification.innerHTML = `
                    <i class="fas fa-exclamation-triangle"></i>
                    <div>
                        <strong>You're behind on ${progressData.periodsMissingMinimum} period${progressData.periodsMissingMinimum > 1 ? 's' : ''}!</strong>
                        Some past periods didn't meet the minimum requirement of ${progressData.minContributionsPerPeriod} contribution${progressData.minContributionsPerPeriod > 1 ? 's' : ''} per period.
                        While you can't go back, make sure to meet the minimum for current and future periods!
                    </div>
                `;
                notificationArea.appendChild(notification);
            }
            // Show notification if period is ending soon (last 3 days)
            else if (progressData.periodEndDate) {
                const endDate = new Date(progressData.periodEndDate);
                const daysUntilEnd = Math.ceil((endDate - new Date()) / (1000 * 60 * 60 * 24));

                if (daysUntilEnd >= 0 && daysUntilEnd <= 3) {
                    // Check if user has met minimum for this period
                    if (progressData.contributionsThisPeriod < progressData.minContributionsPerPeriod) {
                        const needed = progressData.minContributionsPerPeriod - progressData.contributionsThisPeriod;
                        const notification = document.createElement('div');
                        notification.className = 'progress-notification info';
                        notification.innerHTML = `
                            <i class="fas fa-info-circle"></i>
                            <div>
                                <strong>Period ${progressData.currentPeriod} ends in ${daysUntilEnd} day${daysUntilEnd !== 1 ? 's' : ''}!</strong>
                                You need ${needed} more contribution${needed !== 1 ? 's' : ''} to meet the minimum before ${endDate.toLocaleDateString('en-US', {
                                    month: 'long',
                                    day: 'numeric'
                                })}.
                            </div>
                        `;
                        notificationArea.appendChild(notification);
                    }
                }
            }
        }

        function displayContributionsList(progressData) {
            const listContainer = document.getElementById('contributions-list-container');
            const list = document.getElementById('contributions-list');

            if (!progressData.contributions || progressData.contributions.length === 0) {
                listContainer.style.display = 'none';
                return;
            }

            listContainer.style.display = 'block';
            list.innerHTML = '';

            // Group contributions by period
            const contributionsByPeriod = {};
            progressData.contributions.forEach(contrib => {
                if (!contributionsByPeriod[contrib.period]) {
                    contributionsByPeriod[contrib.period] = [];
                }
                contributionsByPeriod[contrib.period].push(contrib);
            });

            // Display contributions sorted by period (newest first)
            const periods = Object.keys(contributionsByPeriod).map(Number).sort((a, b) => b - a);

            periods.forEach(period => {
                contributionsByPeriod[period].forEach(contrib => {
                    const item = document.createElement('div');
                    item.className = 'contribution-item';

                    const contributionDate = new Date(contrib.date);
                    const dateStr = contributionDate.toLocaleDateString('en-US', {
                        month: 'short',
                        day: 'numeric',
                        year: 'numeric'
                    });

                    item.innerHTML = `
                        <div class="contribution-item-info">
                            <div class="contribution-item-title">
                                ${contrib.topic} â€º ${contrib.subtopic}
                            </div>
                            <div class="contribution-item-meta">
                                Submitted ${dateStr}
                            </div>
                        </div>
                        <div class="contribution-item-period">
                            Period ${period}
                        </div>
                    `;

                    list.appendChild(item);
                });
            });

            if (progressData.contributions.length === 0) {
                list.innerHTML = '<div class="empty-contributions">No contributions yet this semester. Start contributing to see your progress!</div>';
            }
        }

        // Listen for auth state changes
        window.addEventListener('authStateChanged', function(event) {
            loadProgressDashboard();
        });

        // Load dashboard on page load if user is already signed in
        window.addEventListener('load', function() {
            setTimeout(loadProgressDashboard, 1000);
        });

        // Make function globally accessible for refreshing after contribution
        window.refreshProgressDashboard = loadProgressDashboard;
    </script>

    <!-- Authentication Module (Firebase) -->
    <script src="auth.js"></script>

    <!-- Entries Index Module (Firebase) -->
    <script src="entriesIndex.js"></script>

    <!-- Contributors Module (Dynamic) -->
    <script src="contributors.js"></script>

    <!-- Chatbot Module (Firebase) -->
    <script src="chatbot.js"></script>


</body></html>